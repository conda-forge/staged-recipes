{% set name = "ghc-cross" %}
{% set version = "9.6.7" %}

package:
  name: ghc-cross_split
  version: {{ version }}

source:
  - url: https://downloads.haskell.org/~ghc/{{ version }}/ghc-{{ version }}-src.tar.xz
    sha256: d053bf6ce1d588a75cfe8c9316269486e9d8fb89dcdf6fd92836fa2e3df61305
    patches:
      - skip-bindist-recache-crosscompile.patch

build:
  number: 0
  skip: true  #[not (linux and x86_64) or cross_target_platform == "linux-64"]
  detect_binary_files_with_prefix: false

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    - autoconf
    - automake
    - binutils
    - binutils_impl_{{ cross_target_platform }} {{ binutils_version }}.*
    - cabal ==3.10.3.0
    - file
    - ghc-bootstrap ==9.6.7
    - llvm-tools {{ c_compiler_version }}.*
    - m4
    - make
    - perl 5.32.*
    - pkg-config
    - python 3.10.*
    - sed
    - sphinx
    - zstd

    # Cross-compiler packages
    - {{ c_stdlib }}_{{ cross_target_platform }} >={{ c_stdlib_version }}
    - {{ c_compiler }}_impl_{{ cross_target_platform }} {{ c_compiler_version }}.*
    - {{ cxx_compiler }}_impl_{{ cross_target_platform }} {{ cxx_compiler_version }}.*
    - libgcc-devel_{{ cross_target_platform }}

outputs:
  - name: ghc_impl_{{ cross_target_platform }}
    script: install_ghc.sh
    build:
      merge_build_host: false
      # ld binaries have host prefix search paths embeded in them
      detect_binary_files_with_prefix: true
      ignore_run_exports_from:    # [linux]
        - {{ compiler('cxx') }}   # [linux]
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ stdlib('c') }}
      host:
        - gmp
        - libiconv
        - libffi
      run:
        - gmp
        - libiconv
        - libffi
      run_constrained:
        - binutils_impl_{{ cross_target_platform }} {{ version }}
    test:
      commands:
        - {{ triplet }}-ghc --version
        - {{ triplet }}-ghc-pkg --version
        - {{ triplet }}-hp2ps --version
        - {{ triplet }}-hsc2hs --version
        - echo "{{ ctng_vendor }}"

about:
  home: https://haskell.org/ghc/
  license: BSD-3-Clause
  license_file:
    - LICENSE
  summary: Glorious Glasgow Haskell Compilation System
  description: |
    GHC is a state-of-the-art, open source, compiler and interactive environment 
    for the functional language Haskell.
  doc: https://www.haskell.org/ghc/documentation.html

extra:
  recipe-maintainers:
    - MementoRC
  feedstock_name:
    - ghc-cross
