# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json

context:
  name: modelscope
  version: 1.23.0

recipe:
  name: modelscope-all
  version: ${{ version }}

source:
  - url: https://github.com/${{ name }}/${{ name }}/archive/refs/tags/v${{ version }}.tar.gz
    # sdists are broken and fail to include setup.py and other files. 
    # https://pypi.org/packages/source/m/${{ name }}/modelscope-${{ version }}.tar.gz
    sha256: 2984869b4ae54a6c2e396cc097d18db65e4f6e892302378f5e03cd0121317a9c
    patches:
      - 0001_fix_version.patch

build:
  number: 0
  noarch: python

outputs:
  - package:
      name: modelscope
    build:
      script: ${{ PYTHON }} -m pip install .
      python:
        entry_points:
        - modelscope = modelscope.cli.cli:run_cmd
      noarch: python
    requirements:
      host:
      - python ${{ python_min }}.*
      - pip
      - setuptools
      run:
      - python >=${{ python_min }}
      - requests >=2.25
      - tqdm >=4.64.0
      - urllib3 >=1.26
      - pip # undeclared dep. the utils package uses private methods in pip
      - setuptools # undeclared dep. the utils package uses setuptools for hackory
    tests:
      - python:
          imports:
          - modelscope
          - modelscope.cli
          - modelscope.fileio
          - modelscope.exporters
          pip_check: true
          python_version: ${{ python_min }}.*

  - package:
      name: modelscope-audio
    build:
      noarch: generic
      skip: win # while this is a noarch package, some of the dependencies are not available on Windows.
    requirements:
      host:
      - python ${{ python_min }}.*
      - pip
      - setuptools
      run:
      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
      - libsndfile >=1.2.2
      - addict  # extra == "audio"
      - attrs  # extra == "audio"
      - datasets >=3.0.0 # extra == "audio"
      - einops  # extra == "audio"
      - pillow  # extra == "audio"
      - python-dateutil >=2.1 # extra == "audio"
      - scipy  # extra == "audio"
      - setuptools # extra == "audio"
      - simplejson >=3.3.0 # extra == "audio"
      - sortedcontainers >=1.5.9 # extra == "audio"
      - transformers  # extra == "audio"
      - urllib3 >=1.26 # extra == "audio"
      # funasr is not on conda-forge yet. It provides speech recognition support.
      # - funasr >=1.0.0 # extra == "audio"
      # kaldiio is not on conda-forge yet. It provides kaldi support.
      # - kaldiio  # extra == "audio"
      # kwsbp is not on pypi. mysterious dependency only available as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com
      # - kwsbp >=0.0.6 # extra == "audio"
      - matplotlib-base  # extra == "audio"
      # py-sound-connect is not on pypi. mysterious dependency only available as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com
      # - py-sound-connect >=0.1 # extra == "audio"
      - pysoundfile >0.10 # extra == "audio"
      - tensorboardx  # extra == "audio"
      - hdbscan  # extra == "audio"
      # hyperpyyaml is not on conda-forge yet. It provides expanded yaml support.
      # - hyperpyyaml  # extra == "audio"
      - librosa >=0.10.1 # extra == "audio"
      # mindaec is not on pypi. mysterious dependency only available as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com
      # - mindaec  # extra == "audio"
      - mir_eval >=0.7 # extra == "audio"
      - rotary-embedding-torch >=0.1.5 # extra == "audio"
      # speechbrain is not on conda-forge yet. It provides speech recognition support.
      # - speechbrain >=0.5.12 # extra == "audio"
      - torchaudio  # extra == "audio"
      - tqdm  # extra == "audio"
      - umap-learn  # extra == "audio"
      - bitstring  # extra == "audio"
      - greenlet >=1.1.2 # extra == "audio"
      - inflect  # extra == "audio"
      - jedi >=0.18.1 # extra == "audio"
      # kantts is not on pypi. only available as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com. source here without release tags https://github.com/modelscope/KAN-TTS
      # - kantts  # extra == "audio"
      - lxml  # extra == "audio"
      - msgpack-python >=1.0.4 # extra == "audio"
      - parso >=0.8.3 # extra == "audio"
      - pexpect >=4.8.0 # extra == "audio"
      - pickleshare >=0.7.5 # extra == "audio"
      - prompt-toolkit >=3.0.30 # extra == "audio"
      - protobuf  # extra == "audio"
      - ptflops  # extra == "audio"
      - ptyprocess >=0.7.0 # extra == "audio"
      - pygments >=2.12.0 # extra == "audio"
      # pysptk is not on conda-forge yet. It provides speech recognition support.
      # - pysptk <0.1.19,>=0.1.15 # extra == "audio"
      # pytorch-wavelets is not on conda-forge yet.
      # - pytorch-wavelets  # extra == "audio"
      - pywavelets >=1.0.0 # extra == "audio"
      - scikit-learn  # extra == "audio"
      - sox  # extra == "audio"
      - traitlets >=5.3.0 # extra == "audio"
      # ttsfrd is not on pypi. only available as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com.
      # - ttsfrd >=0.1.2 # extra == "audio"
      - unidecode  # extra == "audio"
      - wcwidth >=0.2.5 # extra == "audio"
      # funcodec is not on conda-forge yet. It provides fast audio codec support.
      # - funcodec >=0.2.0 # extra == "audio"
      - __unix # some of the dependencies are not available on Windows.
    tests:
      - python:
          imports:
          - modelscope.models.audio
          pip_check: true
          python_version: ${{ python_min }}.*
  
  - package:
      name: modelscope-multimodal
    build:
      noarch: generic
      skip: win # while this is a noarch package, some of the dependencies are not available on Windows.
    requirements:
      host:
      - python ${{ python_min }}.*
      run:
      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
      - addict  # extra == "multi-modal"
      - attrs  # extra == "multi-modal"
      - datasets >=3.0.0 # extra == "multi-modal"
      - einops  # extra == "multi-modal"
      - pillow  # extra == "multi-modal"
      - python-dateutil >=2.1 # extra == "multi-modal"
      - scipy  # extra == "multi-modal"
      - simplejson >=3.3.0 # extra == "multi-modal"
      - sortedcontainers >=1.5.9 # extra == "multi-modal"
      - transformers  # extra == "multi-modal"
      - urllib3 >=1.26 # extra == "multi-modal"
      - accelerate  # extra == "multi-modal"
      - cloudpickle  # extra == "multi-modal"
      # decord is not on conda-forge yet. 
      # - decord >=0.6.0 # extra == "multi-modal"
      - diffusers >=0.25.0 # extra == "multi-modal"
      # fairseq conflicts hydra-core and omegaconf versions
      # - if: (osx and arm64) or x86_64
      #  then:
      #  - fairseq # extra == "multi-modal"
      #  - torchaudio # fairseq undeclared dependency
      - ftfy >=6.0.3 # extra == "multi-modal"
      - librosa ==0.10.1 # extra == "multi-modal"
      - opencv # extra == "multi-modal"
      - pycocoevalcap >=1.2 # extra == "multi-modal"
      - pycocotools >=2.0.4 # extra == "multi-modal"
      - pydot  # extra == "multi-modal"
      - pytorch-lightning # extra == "multi-modal"
      - rapidfuzz  # extra == "multi-modal"
      - rouge-score # extra == "multi-modal"
      - sacrebleu  # extra == "multi-modal"
      - safetensors  # extra == "multi-modal"
      - setuptools # extra == "multi-modal"
      - pysoundfile  # extra == "multi-modal"
      # taming-transformers-rom1504 is not on pypi. It's a binary wheel only available on modelscope.oss-cn-beijing.aliyuncs.com
      # - taming-transformers-rom1504  # extra == "multi-modal"
      - timm  # extra == "multi-modal"
      - tokenizers  # extra == "multi-modal"
      - torchvision  # extra == "multi-modal"
      - transformers >=4.27.1 # extra == "multi-modal"
      - unicodedata2  # extra == "multi-modal"
      # zhconv is not on conda-forge yet.
      # - zhconv  # extra == "multi-modal"
      - __unix # some of the dependencies are not available on Windows.
    tests:
      - python:
          imports:
          - modelscope.models.multi_modal
          pip_check: true
          python_version: ${{ python_min }}.*

  # The nlp features may mostly function without megatron-util.
  - package:
      name: modelscope-nlp
    build:
      noarch: generic
      skip: win # while this is a noarch package, some of the dependencies are not available on Windows.
    requirements:
      host:
      - python ${{ python_min }}.*
      run:
      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
      - addict  # extra == "nlp"
      - attrs  # extra == "nlp"
      - datasets >=3.0.0 # extra == "nlp"
      - einops  # extra == "nlp"
      - pillow  # extra == "nlp"
      - python-dateutil >=2.1 # extra == "nlp"
      - scipy  # extra == "nlp"
      - setuptools # extra == "nlp"
      - simplejson >=3.3.0 # extra == "nlp"
      - sortedcontainers >=1.5.9 # extra == "nlp"
      - transformers  # extra == "nlp"
      - urllib3 >=1.26 # extra == "nlp"
      - boto3  # extra == "nlp"
      # incorrectly specified dependency upstream
      # - embeddings  # extra == "nlp"
      - filelock  # extra == "nlp"
      - ftfy  # extra == "nlp"
      - jieba >=0.42.1 # extra == "nlp"
      - matplotlib-base  # extra == "nlp"
      # megatron-util is not on pypi and the source code is not available.
      # the error tells you to `pip install megatron_util -f https://modelscope.oss-cn-beijing.aliyuncs.com/releases/repo.html`
      # - megatron-util  # extra == "nlp"
      - nltk  # extra == "nlp"
      - pandas  # extra == "nlp"
      - protobuf # extra == "nlp"
      # pythainlp is not on conda-forge yet. It provides Thai language support.
      #- pythainlp  # extra == "nlp"
      # pyvi is not on conda-forge yet. It provides Vietnamese language support.
      #- pyvi  # extra == "nlp"
      - regex  # extra == "nlp"
      - rouge  # extra == "nlp"
      - sacremoses >=0.0.41 # extra == "nlp"
      - scikit-learn  # extra == "nlp"
      - sentencepiece  # extra == "nlp"
      - seqeval  # extra == "nlp"
      - spacy <=3.7.0,>=2.3.5 # extra == "nlp"
      - stanza  # extra == "nlp"
      # subword-nmt is not on conda-forge yet. It provides subword tokenization.
      #- subword-nmt  # extra == "nlp"
      - termcolor  # extra == "nlp"
      - tokenizers  # extra == "nlp"
      - transformers >=4.12.0 # extra == "nlp"
      # zhconv is not on conda-forge yet. It provides Chinese language support.
      #- zhconv  # extra == "nlp"
      - __unix # some of the dependencies are not available on Windows.
    tests:
      - python:
          imports:
          - modelscope
          - modelscope.models.nlp
          pip_check: true
          python_version: ${{ python_min }}.*

# The cv extra uses too many mysterious dependencies that are not on pypi and are only available as binary wheels on modelscope.oss-cn-beijing.aliyuncs.com to be useful.
#  - package:
#      name: modelscope-cv
#    build:
#      noarch: generic
#    requirements:
#      host:
#      - python ${{ python_min }}.*
#      run:
#      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
#      - addict  # extra == "cv"
#      - attrs  # extra == "cv"
#      - datasets <=3.2.0,>=3.0.0 # extra == "cv"
#      - einops  # extra == "cv"
#      - pillow  # extra == "cv"
#      - python-dateutil >=2.1 # extra == "cv"
#      - scipy  # extra == "cv"
#      - simplejson >=3.3.0 # extra == "cv"
#      - sortedcontainers >=1.5.9 # extra == "cv"
#      - transformers  # extra == "cv"
#      - urllib3 >=1.26 # extra == "cv"
#      - accelerate  # extra == "cv"
#      - albumentations >=1.0.3 # extra == "cv"
#      - av >=9.2.0 # extra == "cv"
#      # bmt-clipit is not on pypi. Another one of those mysterious dependencies only on modelscope.oss-cn-beijing.aliyuncs.com/
#      # - bmt-clipit >=1.0 # extra == "cv"
#      # chumpy is not not actually ussed but specified as a dependency
#      # - chumpy  # extra == "cv"
#      # OpenAI's clip is not on pypi. The source code is available at https://github.com/openai/CLIP but has been largely replaced by HF and OpenCLIP.
#      # They have a binary wheel hosted on modelscope.oss-cn-beijing.aliyuncs.com though.
#      # - clip >=1.0 # extra == "cv"
#      # control-ldm is not on pypi. Another one of those mysterious dependencies provided only as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com/
#      # - control-ldm  # extra == "cv"
#      # ddpm-guided-diffusion is not on pypi. Another one of those mysterious dependencies provided only as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com/
#      # - ddpm-guided-diffusion  # extra == "cv"
#      - diffusers  # extra == "cv"
#      - easydict  # extra == "cv"
#      # edit-distance is not on pypi. Another one of those mysterious dependencies provided only as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com/
#      # - edit-distance  # extra == "cv"
#      # face-alignment is not on pypi. Another one of those mysterious dependencies provided only as a binary wheel on modelscope.oss-cn-beijing.aliyuncs.com/
#      # - face-alignment >=1.3.5 # extra == "cv"
#      - fairscale >=0.4.1 # extra == "cv"
#      - fastai >=1.0.51 # extra == "cv"
#      - ffmpeg >=1.4 # extra == "cv"
#      - ffmpeg-python >=0.2.0 # extra == "cv"
#      - ftfy  # extra == "cv"
#      - fvcore  # extra == "cv"
#      - imageio >=2.9.0 # extra == "cv"
#      - imageio-ffmpeg >=0.4.2 # extra == "cv"
#      - imgaug >=0.4.0 # extra == "cv"
#      - kornia >=0.5.0 # extra == "cv"
#      - lmdb  # extra == "cv"
#      - lpips  # extra == "cv"
#      - matplotlib-base >=3.8.0 # extra == "cv"
#      - ml-collections  # extra == "cv"
#      - mmcls >=0.21.0 # extra == "cv"
#      - mmdet <=2.28.2,>=2.25.0 # extra == "cv"
#      - mmdet3d ==1.0.0a1 # extra == "cv"
#      - mmsegmentation <=0.30.0 # extra == "cv"
#      - moviepy ==1.0.3 # extra == "cv"
#      - nerfacc ==0.2.2 # extra == "cv"
#      - networkx  # extra == "cv"
#      - numba  # extra == "cv"
#      - omegaconf  # extra == "cv"
#      - onnx  # extra == "cv"
#      - onnxruntime >=1.10 # extra == "cv"
#      - onnxsim  # extra == "cv"
#      - open-clip-torch >=2.7.0 # extra == "cv"
#      - opencv-python  # extra == "cv"
#      - paint-ldm  # extra == "cv"
#      - pandas  # extra == "cv"
#      - panopticapi  # extra == "cv"
#      - pillow >=6.2.0 # extra == "cv"
#      - plyfile >=0.7.4 # extra == "cv"
#      - psutil  # extra == "cv"
#      - pyclipper  # extra == "cv"
#      - pymcubes <=0.1.4 # extra == "cv"
#      - pytorch-lightning  # extra == "cv"
#      - regex  # extra == "cv"
#      - scikit-image  # extra == "cv"
#      - scikit-learn  # extra == "cv"
#      - shapely  # extra == "cv"
#      - shotdetect-scenedetect-lgss >=0.0.4 # extra == "cv"
#      - smplx  # extra == "cv"
#      - tensorflow-estimator >=1.15.1 # extra == "cv"
#      - tf-slim  # extra == "cv"
#      - thop  # extra == "cv"
#      - timm >=0.4.9 # extra == "cv"
#      - torch-scatter  # extra == "cv"
#      - torchmetrics >=0.6.2 # extra == "cv"
#      - torchsummary >=1.5.1 # extra == "cv"
#      - torchvision  # extra == "cv"
#      - tqdm  # extra == "cv"
#      - transformers >=4.26.0 # extra == "cv"
#      - trimesh  # extra == "cv"
#      - ujson  # extra == "cv"
#      - utils  # extra == "cv"
#      - videofeatures-clipit >=1.0 # extra == "cv"
#      - yacs  # extra == "cv"
#    tests:
#      - python:
#          imports:
#          - modelscope
#          pip_check: true

  - package:
      name: modelscope-science
    build:
      noarch: generic
    requirements:
      host:
      - python ${{ python_min }}.*
      run:
      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
      - addict  # extra == "science"
      - attrs  # extra == "science"
      - datasets >=3.0.0 # extra == "science"
      - einops  # extra == "science"
      - pillow  # extra == "science"
      - python-dateutil >=2.1 # extra == "science"
      - scipy  # extra == "science"
      - setuptools # extra == "science"
      - simplejson >=3.3.0 # extra == "science"
      - sortedcontainers >=1.5.9 # extra == "science"
      - transformers  # extra == "science"
      - urllib3 >=1.26 # extra == "science"
      - biopython  # extra == "science"
      - iopath  # extra == "science"
      - ipdb  # extra == "science"
      - lmdb  # extra == "science"
      - ml-collections  # extra == "science"
      - tensorboardx  # extra == "science"
      - tokenizers  # extra == "science"
      - tomli # undeclared dependency of ipdb upstream
    tests:
      - python:
          imports:
          - modelscope.models.science
          pip_check: true
          python_version: ${{ python_min }}.*

  - package:
      name: modelscope-server
    build:
      noarch: generic
    requirements:
      host:
      - python ${{ python_min }}.*
      run:
      - ${{ pin_subpackage("modelscope", upper_bound="x.x.x") }}
      - setuptools # utils uses setuptools
      - fastapi  # extra == "server"
      - sse-starlette  # extra == "server"
      - uvicorn  # extra == "server"
    tests:
      - python:
          imports:
          - modelscope.server
          pip_check: true
          python_version: ${{ python_min }}.*

about:
  homepage: https://github.com/modelscope/modelscope
  summary: 'ModelScope: bring the notion of Model-as-a-Service to life.'
  description: |
    ModelScope is built upon the notion of “Model-as-a-Service” (MaaS). 
    It seeks to bring together most advanced machine learning models from the AI community, and streamlines the process of leveraging AI models in real-world applications. 
  license: Apache-2.0
  license_file: LICENSE

extra:
  feedstock-name: modelscope
  recipe-maintainers:
    - zbowling
