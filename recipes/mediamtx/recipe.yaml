# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

context:
  name: mediamtx
  version: "1.14.0"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  - url: https://github.com/bluenviron/mediamtx/archive/refs/tags/v${{ version }}.tar.gz
    sha256: fa388288865aec093720953af8374b759ca9519f8d20699cfa8b41281e99f372
    target_directory: src
  - path: service.yaml
    target_directory: service-config

build:
  number: 0
  script:
    - cd src
    - echo "v${{ version }}" > VERSION
    - go generate ./...
    - go-licenses save . --save_path ../library_licenses --ignore golang.org/x/sys/unix --ignore golang.org/x/crypto/internal/poly1305 --ignore golang.org/x/crypto/salsa20/salsa --ignore golang.org/x/crypto/argon2 --ignore golang.org/x/crypto/blake2b --ignore golang.org/x/sys/cpu --ignore golang.org/x/crypto/sha3 --ignore github.com/ugorji/go/codec --ignore github.com/benburkert/openpgp
    - if: unix
      then:
        - go build -v -o $PREFIX/bin/mediamtx -ldflags="-s -w"
        - mkdir -p $PREFIX/config
        - cp ../service-config/service.yaml $PREFIX/config/service.yaml
      else:
        - go build -v -o %LIBRARY_BIN%\mediamtx.exe -ldflags="-s"
        - mkdir %LIBRARY_PREFIX%\config
        - copy ..\service-config\service.yaml %LIBRARY_PREFIX%\config\service.yaml

requirements:
  build:
    - ${{ compiler("go-nocgo") }}
    - go-licenses

tests:
  - script: mediamtx --version
  - script: mediamtx --help
  - package_contents:
      bin:
        - mediamtx
      files:
        - config/service.yaml
      strict: true

about:
  homepage: https://github.com/bluenviron/mediamtx
  summary: Ready-to-use and zero-dependency real-time media server and media proxy
  description: |
    MediaMTX is a ready-to-use and zero-dependency real-time media server and
    media proxy that allows to publish, read, proxy, record and playback video and audio streams.
    It has been conceived as a "media router" that routes media streams from one end to the other.
  license: MIT
  license_file:
    - src/LICENSE
    - library_licenses/
  documentation: https://github.com/bluenviron/mediamtx/blob/main/README.md
  repository: https://github.com/bluenviron/mediamtx

extra:
  recipe-maintainers:
    - phreed
