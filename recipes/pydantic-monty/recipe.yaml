context:
  version: "0.0.1"

package:
  name: pydantic-monty
  version: ${{ version }}

source:
  # https://github.com/pydantic/monty/issues/76
  # url: https://pypi.org/packages/source/p/pydantic-monty/pydantic-monty-${{ version }}.tar.gz
  url: https://github.com/pydantic/monty/archive/refs/tags/v${{ version }}.tar.gz
  sha256: 41651066a05933292e61cf07aae23602b593df1d8d2e24d57bef43934441db1b

build:
  script:
    env:
      CARGO_PROFILE_RELEASE_STRIP: symbols
      CARGO_PROFILE_RELEASE_LTO: fat
      CARGO: cargo-auditable-wrapper${{ '' if unix else '.bat' }}
    content:
      - cd crates/monty-python
      - if: win
        then:
          # hack: path too long for ruff subpackage
          - set CARGO_HOME=C:\.cargo
      - if: unix
        then:
          - cp ${RECIPE_DIR}/cargo-auditable-wrapper.sh ${BUILD_PREFIX}/bin/cargo-auditable-wrapper
        else:
          - copy %RECIPE_DIR%\cargo-auditable-wrapper.bat %BUILD_PREFIX%\Library\bin\cargo-auditable-wrapper.bat
      -  python -m pip install . -vv
      - cargo-bundle-licenses --format yaml --output ../../THIRD_PARTY.yml
  number: 0

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ compiler('rust') }}
    - ${{ stdlib('c') }}
    - cargo-bundle-licenses
    - cargo-auditable
    - if: build_platform != target_platform
      then:
        - python
        - cross-python_${{ target_platform }}
        - maturin >=1.9.4,<2
  host:
    - python
    - pip
    - maturin >=1.9.4,<2
    - setuptools
  run:
    - python

tests:
  - python:
      imports:
      - pydantic_monty
      pip_check: true

about:
  homepage: https://github.com/pydantic/monty
  summary: A minimal, secure Python interpreter written in Rust for use by AI
  description: |
    A minimal, secure Python interpreter written in Rust for use by AI.
    Monty avoids the cost, latency, complexity and general faff of using full container based sandbox for running LLM generated code.
    Instead, it let's you run safely run Python code written by an LLM embedded in your agent, with startup times measured in single digit microseconds not hundreds of milliseconds.
  license: MIT
  license_file:
    - LICENSE
    - THIRD_PARTY.yml
  repository: https://github.com/pydantic/monty

extra:
  recipe-maintainers:
    - pavelzw
