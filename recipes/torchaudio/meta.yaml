{% set name = "torchaudio" %}
{% set version = "0.11.0" %}
{% set torch_proc_type = "cuda" if cuda_compiler_version != "None" else "cpu" %}

package:
  name: torchaudio-split
  version: {{ version }}

source:
  url: https://github.com/pytorch/audio/archive/refs/tags/v{{ version }}.tar.gz
  sha256: e2d24a6685443b906942f1311438ea1f00efb5961cca7fefeb3254b9ebce156c

build:
  number: 0
  skip: true  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}


test:
  source_files:
    - tests
  imports:
    - torchaudio
    - torchaudio.datasets
    - torchaudio.kaldi_io
    - torchaudio.sox_effects
    - torchaudio.transforms
  commands:
    - pytest -vvv --capture=tee-sys tests
  requires:
    - pytest
    - scipy

outputs:
  - name: torchaudio
    script: build-torch.sh  # [not win]
    script: build-torch.bat  # [win]
    build:
      string: cpu_py{{ COND_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}  # [cuda_compiler_version == "None"]
      string: cuda{{ cuda_cimpiler_version | replace('.', '') }}py{{ CONDA_PY }}h{{ PKG_HASH }}_{{ PKG_BUILDNUM }}  # [cuda_compiler_version != "None"]
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('cuda') }}  # [cuda_compiler_version != "None"]
        - sysroot_linux-64 ==2.17  # [linux64]
        - python  # [build_platform != target_platform]
        - cross-python_{{ target_platform }}  # [build_platform != target_platform]
        - numpy  # [build_platform != target_platform]
        - pytorch  # [build_platform != target_platform]
        - pytorch =*={{ torch_proc_type }}*  # [build_platform != target_platform]
      host:
        - cmake
        - cudnn  # [cuda_compiler_version != "None"]
        - ffmpeg >=4.1
        - ninja
        - numpy >=1.11  # [py<=39]
        - numpy >=1.21.2  # [py>39]
        - pip
        - pkg-config  # [not win]
        - python
        - pytorch
        - pytorch =*={{ torch_proc_type }}*
        - setuptools
      run:
        - {{ pin_compatible('cudnn') }}  # [cuda_compiler_version != "None"]
        - {{ pin_compatible('numpy') }}
        - python
        - pytorch
      run_constrained:
        - pytorch =*={{ torch_proc_type }}*

about:
  home: https://pytorch.org/audio/main/
  dev_url: https://github.com/pytorch/audio
  license: BSD-2-Clause
  license_file: LICENSE
  summary: 'simple audio I/O for pytorch'

extra:
  recipe-maintainers:
    - thewchan
