From 9b66b0a808c1dcea54c7b1608f2c5da2434ce139 Mon Sep 17 00:00:00 2001
From: Ky Anh <40734986+itskyf@users.noreply.github.com>
Date: Mon, 16 Sep 2024 04:50:46 +0000
Subject: [PATCH] fix: build with CUDA 12.0

---
 setup.py                                        | 4 ++--
 src/3rdparty/concurrent_unordered_map.cuh       | 3 ++-
 src/coordinate_map_gpu.cu                       | 2 ++
 src/{direct_max_pool.cpp => direct_max_pool.cu} | 0
 src/{quantization.cpp => quantization.cu}       | 0
 src/spmm.cu                                     | 4 ++++
 6 files changed, 10 insertions(+), 3 deletions(-)
 rename src/{direct_max_pool.cpp => direct_max_pool.cu} (100%)
 rename src/{quantization.cpp => quantization.cu} (100%)

diff --git setup.py setup.py
index 452ea57..8cbdec9 100644
--- setup.py
+++ setup.py
@@ -261,8 +261,8 @@ SOURCE_SETS = {
             "interpolation_gpu.cu",
             "spmm.cu",
             "gpu.cu",
-            "quantization.cpp",
-            "direct_max_pool.cpp",
+            "quantization.cu",
+            "direct_max_pool.cu",
         ],
         ["pybind/minkowski.cu"],
         [],
diff --git src/3rdparty/concurrent_unordered_map.cuh src/3rdparty/concurrent_unordered_map.cuh
index ed8e1b2..e13270c 100644
--- src/3rdparty/concurrent_unordered_map.cuh
+++ src/3rdparty/concurrent_unordered_map.cuh
@@ -25,8 +25,9 @@
 #include <cudf/detail/utilities/device_atomics.cuh>
 #include <cudf/utilities/error.hpp>
 
-#include <thrust/pair.h>
 #include <thrust/count.h>
+#include <thrust/execution_policy.h>
+#include <thrust/pair.h>
 
 #include <functional>
 #include <memory>
diff --git src/coordinate_map_gpu.cu src/coordinate_map_gpu.cu
index fb7325d..ab5be63 100644
--- src/coordinate_map_gpu.cu
+++ src/coordinate_map_gpu.cu
@@ -35,7 +35,9 @@
 #include <thrust/execution_policy.h>
 #include <thrust/iterator/counting_iterator.h>
 #include <thrust/iterator/transform_iterator.h>
+#include <thrust/remove.h>
 #include <thrust/sort.h>
+#include <thrust/unique.h>
 
 namespace minkowski {
 
diff --git src/direct_max_pool.cpp src/direct_max_pool.cu
similarity index 100%
rename from src/direct_max_pool.cpp
rename to src/direct_max_pool.cu
diff --git src/quantization.cpp src/quantization.cu
similarity index 100%
rename from src/quantization.cpp
rename to src/quantization.cu
diff --git src/spmm.cu src/spmm.cu
index 8891a56..c4961d5 100644
--- src/spmm.cu
+++ src/spmm.cu
@@ -29,6 +29,10 @@
 
 #include <cusparse.h>
 
+#include <thrust/execution_policy.h>
+#include <thrust/reduce.h>
+#include <thrust/sort.h>
+
 #include <ATen/core/Tensor.h>
 #include <ATen/cuda/CUDAContext.h>
 #include <ATen/cuda/CUDAUtils.h>
-- 
2.43.5

