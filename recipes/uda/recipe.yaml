context:
  name: UDA
  version: "2.8.1"
  username: ukaea

recipe:
  name: ${{ name|lower }}
  version: ${{ version }}

cache:
  source:
    url: https://github.com//${{ username }}/${{ name }}/archive/refs/tags/${{ version }}.tar.gz
    sha256: 58ad0b9adcf5e9ac4b31e38df38a47d3d6e8501beed5958cf7237a60177c1c0e
    patches:
      - uda_cli_help.patch
      - no_cast_function_type.patch
      - udaClient.patch
      - add_log_memcached.patch
      - improve_install_destination.patch
      - fix_win_setup_py.patch
  build:
    script:
      - if: unix
        then: build_cache.sh
      - if: win
        then: build_cache.bat
  requirements:
    build:
      - ${{ compiler("cxx") }}
      - ${{ stdlib("c") }}
      - git
      - cmake
      - ninja
      - pkg-config
    host:
      - libxml2
      - libboost-devel
      - fmt
      - openssl
      - capnproto
      - python ${{ python_min }}.*
      - openjdk
      - if: linux and x86_64
        then: libtirpc
      - if: unix
        then: libmemcached
      - if: win
        then:
          - dlfcn-win32
          - zlib
    run:
      - if: linux and x86_64
        then: libtirpc
    ignore_run_exports:
      from_package:
        - libxml2
        - python
        - if: win
          then:
            - zlib
            - dlfcn-win32

outputs:
  # Client only (core library)
  - package:
      name: libuda-client
      version: ${{ version }}
    build:
      number: 0
      files:
        include: ["**"]
        exclude:
          - ${{ "Library/" if win }}bin/install_plugin
          - ${{ "Library/" if win }}etc/*
          - ${{ "Library/" if win }}include/uda/c++/*
          - ${{ "Library/" if win }}lib/pkgconfig/uda-cpp.pc
          - ${{ "Library/" if win }}lib/pkgconfig/uda-fat-cpp.pc
          - ${{ "Library/" if win }}lib/pkgconfig/uda-fat-client.pc
          - ${{ "Library/" if win }}lib/pkgconfig/uda-plugins.pc
          - ${{ "Library/" if win }}lib/python*
          - ${{ "Library/" if win }}java/*
          - ${{ "Library/" if win }}python_installer/*
          - ${{ "Library/" if win }}modulefiles/*
          - if: win
            then:
              - Library/bin/uda_cpp.*
              - Library/bin/uda_jni.*
              - Library/lib/uda_cpp.*
            else:
              - lib/libuda_cpp*
              - lib/libuda_jni*
    requirements:
      run_exports:
        - ${{ pin_subpackage("libuda-client", upper_bound="x.x") }}
    tests:
      - script:
          - uda_cli --help

  # C++ client
  - package:
      name: uda-client-cpp
      version: ${{ version }}
    build:
      number: 0
      files:
        include:
          - ${{ "Library/" if win }}include/uda/c++/*
          - ${{ "Library/" if win }}lib/pkgconfig/uda-cpp.pc
          - if: win
            then:
              - Library/bin/uda_cpp.*
              - Library/lib/uda_cpp.*
            else:
              - lib/libuda_cpp*
    requirements:
      ignore_run_exports:
        from_package:
          - libboost-devel
          - capnproto
      run:
        - libuda-client
      run_exports:
        - ${{ pin_subpackage("uda-client-cpp", upper_bound="x.x") }}
    tests:
      - package_contents:
          files:
            - ${{ "Library/" if win }}lib/pkgconfig/uda-cpp.pc
          lib:
            - uda_cpp
          include:
            - uda/c++/UDA.hpp
            - uda/c++/array.hpp
            - uda/c++/client.hpp
            - uda/c++/data.hpp
            - uda/c++/dim.hpp
            - uda/c++/result.hpp
            - uda/c++/scalar.hpp
            - uda/c++/string.hpp
            - uda/c++/structdata.hpp
            - uda/c++/treenode.hpp
            - uda/c++/vector.hpp

  # Python client
  - package:
      name: pyuda
      version: ${{ version }}
    build:
      number: 0
      files:
        include:
          - ${{ "Library/" if win }}lib/python*
      script:
        - if: unix
          then: ${{ PYTHON }} -m pip install --no-deps --no-build-isolation ${PREFIX}/python_installer/
        - if: win
          then: |
            ${{ PYTHON }} -m pip install --no-deps --no-build-isolation "%LIBRARY_PREFIX%\python_installer"
    requirements:
      build:
        - ${{ compiler("cxx") }}
        - if: build_platform != target_platform
          then:
            - python
            - cross-python_${{ target_platform }}
            - cython
            - numpy
      host:
        - libuda-client
        - libxml2
        - python
        - pip
        - setuptools
        - cython
        - numpy
        - six
      run:
        - six
        - progress
      ignore_run_exports:
        from_package:
          - libxml2
          - libuda-client
          - libboost-devel
    tests:
      - python:
          imports:
            - pyuda
            - uda
          pip_check: true

  # Java client
  - package:
      name: uda-client-java
      version: ${{ version }}
    build:
      number: 0
      script:
        - if: unix
          then: ln -sf $PREFIX/java/UDA-${{ version }}.jar $PREFIX/java/UDA.jar
      files:
        include:
          - ${{ "Library/" if win }}java/*
          - if: win
            then:
              - Library/bin/uda_jni.*
            else:
              - lib/libuda_jni*
    requirements:
      run:
        - libuda-client
        - openjdk
      ignore_run_exports:
        from_package:
          - libboost-devel
          - capnproto
      run_exports:
        - ${{ pin_subpackage("uda-client-java", upper_bound="x.x") }}
    tests:
      - package_contents:
          files:
            - ${{ "Library/" if win }}java/UDA.jar
            - if: unix
              then: java/UDA-${{ version }}.jar
            - if: win
              then:
                - Library/bin/uda_jni.dll
          lib:
            - if: unix
              then: uda_jni

about:
  homepage: https://ukaea.github.io/UDA/
  summary: Universal Data Access (USA) library to provide data over the network in a unified data object.
  description: |
    The UDA can be either run as a client-server API, running as thin client with all functionality
    being handled on a remote server, or as fat-client API where both the client access and plugin
    functionality is run on the local machine.
  license: Apache-2.0
  license_file: LICENCE.txt
  documentation: https://ukaea.github.io/UDA/
  repository: https://github.com/ukaea/UDA

extra:
  feedstock-name: uda-feedstock
  recipe-maintainers:
    - munechika-koyo
