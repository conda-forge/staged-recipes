context:
  name: libshumate
  version: 1.5.3
  version_majmin: ${{ (version | split('.'))[:2] | join('.') }}

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: "https://download.gnome.org/sources/${{ name }}/${{ version_majmin }}/${{ name }}-${{ version }}.tar.xz"
  sha256: 35f013b25391856e1b5c3d4409a5c4a640c6ccb5f5296ff982ec7bed39f56d4c
  patches:
    - fix-meson-windows.patch

build:
  number: 0
  script:
    - if: win
      then: |
        meson setup %MESON_ARGS% ^
          --prefix=%LIBRARY_PREFIX% ^
          --default-library=shared ^
          --wrap-mode=nofallback ^
          --buildtype=release ^
          -Dgtk_doc=false ^
          -Dvapi=false ^
          -Ddemos=false ^
          -Dgir=false ^
          builddir
        ninja -v -C builddir -j %CPU_COUNT%
        ninja -C builddir install -j %CPU_COUNT%
    - if: osx
      then: |
        # Define _DARWIN_C_SOURCE to expose POSIX.1-2008 functions like strnlen
        export CFLAGS="${CFLAGS} -D_DARWIN_C_SOURCE"
    - if: unix
      then: |
        meson setup ${MESON_ARGS} \
            --prefix=$PREFIX \
            --default-library=shared \
            --wrap-mode=nofallback \
            -Dgtk_doc=false \
            -Dvapi=false \
            -Ddemos=false \
            -Dgir=false \
            builddir
        ninja -v -C builddir -j ${CPU_COUNT}
        ninja -C builddir install -j ${CPU_COUNT}
  files:
    exclude:
      - '**/gschemas.compiled'
      - '**/icon-theme.cache'
      - '**/loaders.cache'

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ stdlib('c') }}
    - meson
    - ninja
    - pkg-config
  host:
    - expat
    - glib
    - gtk4
    - json-glib
    - libsoup
    - protobuf-c
    - libsqlite
    - zlib
    - if: unix
      then: gperf
  run:
    - protobuf-c
  run_exports:
    - ${{ pin_subpackage('libshumate', upper_bound='x.x') }}
  ignore_run_exports:
    by_name:
      - libexpat
      - adwaita-icon-theme
      - libzlib

tests:
  - package_contents:
      files:
        - if: unix
          then:
            - lib/pkgconfig/shumate-1.0.pc
        - if: win
          then:
            - Library/lib/pkgconfig/shumate-1.0.pc
            - Library/lib/shumate-1.0.lib
      lib:
        - if: unix
          then: shumate-1.0

about:
  homepage: https://gitlab.gnome.org/GNOME/libshumate
  summary: libshumate is a GTK4 widget to display maps.
  description: |
    libshumate is a C library providing a GtkWidget to display maps in GTK4 
    applications. It supports numerous free map sources such as OpenStreetMap, 
    OpenCycleMap, OpenAerialMap and Maps for free. 
  license: LGPL-2.1-or-later
  license_file: COPYING
  documentation: https://gnome.pages.gitlab.gnome.org/libshumate/
  repository: https://gitlab.gnome.org/GNOME/libshumate

extra:
  recipe-maintainers:
    - haecker-felix
    - Hofer-Julian
