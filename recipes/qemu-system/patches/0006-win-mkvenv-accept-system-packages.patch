From: conda-forge
Subject: Accept system packages and fix Windows wheels path

Conda packages don't register with importlib.metadata, so the Python
package check fails even when packages are installed and working. This patch:
1. Trusts canary executables (for meson)
2. Fixes wheels path expansion on Windows (expands %VAR% environment variables)

--- a/python/scripts/mkvenv.py
+++ b/python/scripts/mkvenv.py
@@ -738,6 +738,7 @@ def _do_ensure(
     for name, info in group.items():
         constraint = _make_version_constraint(info, False)
         matcher = Matcher(name + constraint)
+        canary_prog = info.get("canary", None)
         print(f"mkvenv: checking for {matcher}", file=sys.stderr)

         dist: Optional[Distribution] = None
@@ -746,6 +747,17 @@ def _do_ensure(
         except PackageNotFoundError:
             pass

+        # conda-forge: If dist not found but canary executable exists,
+        # trust it (conda packages don't use importlib.metadata)
+        if dist is None and canary_prog:
+            import shutil
+            canary_path = shutil.which(canary_prog)
+            if canary_path:
+                print(f"mkvenv: {name} not found via importlib but canary "
+                      f"'{canary_prog}' exists at {canary_path}, trusting it",
+                      file=sys.stderr)
+                present.append(name)
+                continue
+
         if (
             dist is None
             # Always pass installed package to pip, so that they can be
@@ -766,6 +778,10 @@ def _do_ensure(
     if absent:
         if online or wheels_dir:
             # Some packages are missing or aren't a suitable version,
             # install a suitable (possibly vendored) package.
+            # conda-forge: expand environment variables in wheels_dir for Windows
+            if wheels_dir:
+                import os
+                wheels_dir = Path(os.path.expandvars(str(wheels_dir)))
             install_packages(
                 absent, online=online, wheels_dir=wheels_dir, venv_dir=venv_dir
             )
