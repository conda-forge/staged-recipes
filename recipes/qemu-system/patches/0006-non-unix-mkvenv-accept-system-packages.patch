From: conda-forge
Subject: Accept system/venv packages for conda-forge builds

Conda packages don't register with importlib.metadata, and venv-installed
packages fail the _is_system_package check. This patch:
1. Trusts canary executables (for meson)
2. Removes _is_system_package check (accepts venv packages)
3. Doesn't clear existing venv (preserves pre-installed packages)

--- a/python/scripts/mkvenv.py
+++ b/python/scripts/mkvenv.py
@@ -738,6 +738,7 @@ def _do_ensure(
     for name, info in group.items():
         constraint = _make_version_constraint(info, False)
         matcher = Matcher(name + constraint)
+        canary_prog = info.get("canary", None)
         print(f"mkvenv: checking for {matcher}", file=sys.stderr)

         dist: Optional[Distribution] = None
@@ -746,11 +747,22 @@ def _do_ensure(
         except PackageNotFoundError:
             pass

+        # conda-forge: If dist not found but canary executable exists,
+        # trust it (conda packages don't use importlib.metadata)
+        if dist is None and canary_prog:
+            import shutil
+            canary_path = shutil.which(canary_prog)
+            if canary_path:
+                print(f"mkvenv: {name} not found via importlib but canary "
+                      f"'{canary_prog}' exists at {canary_path}, trusting it",
+                      file=sys.stderr)
+                present.append(name)
+                continue
+
         if (
             dist is None
-            # Always pass installed package to pip, so that they can be
-            # updated if the requested version changes
-            or not _is_system_package(dist)
+            # conda-forge: removed _is_system_package check to accept
+            # packages installed in venv or via conda
             or not matcher.match(dist.version)
         ):
             absent.append(name + _make_version_constraint(info, True))
@@ -922,7 +934,7 @@ def main() -> int:
         make_venv(
             args.target,
             system_site_packages=True,
-            clear=True,
+            clear=False,
         )
         print(args.target)
         return 0
