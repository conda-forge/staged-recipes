From 580566eafc9ac68b2614b64d6f7aaa84eebb70da Mon Sep 17 00:00:00 2001
From: Matthew Loper <mattloper@scenix.ai>
Date: Mon, 18 Aug 2025 08:12:28 -0700
Subject: [PATCH] ci: drop Python 2 checks; migrate CI to CircleCI 2.1 + Python
 3.12

- Remove Python 2 job and legacy test discovery path

- Use cimg/python:3.12 and add pip cache

- Install minimal system deps (gfortran, liblapack-dev)

- Replace inspect.getargspec with inspect.getfullargspec

- Fix string identity check to equality for order == 'C'
---
 .circleci/config.yml | 67 ++++++++++++--------------------------------
 chumpy/ch.py         |  5 ++--
 chumpy/ch_ops.py     |  2 +-
 3 files changed, 22 insertions(+), 52 deletions(-)

diff --git a/.circleci/config.yml b/.circleci/config.yml
index 660b405..d0deca1 100644
--- a/.circleci/config.yml
+++ b/.circleci/config.yml
@@ -1,66 +1,39 @@
-version: 2
-jobs:
-  python2:
-    docker:
-      - image: circleci/python:2
+version: 2.1
 
-    steps:
-      - checkout
-
-      - run:
-          name: Install container dependencies
-          command: |
-            sudo apt-get --allow-releaseinfo-change update
-            sudo apt-get install -qq gfortran liblapack-dev
-
-      - run:
-          name: Install python dependencies
-          command: |
-            mkdir -p venv
-            virtualenv venv
-            . venv/bin/activate
-            # Hack to disable the progress bar
-            set -o pipefail; pip install -r requirements.txt | cat
-
-      - run:
-          name: Show versions
-          command: |
-            . venv/bin/activate
-            pip freeze
-
-      - run:
-          name: Run tests
-          command: |
-            . venv/bin/activate
-            make test
+orbs:
+  python: circleci/python@2.1.1   # optional, for helpers
 
+jobs:
   python3:
     docker:
-      - image: circleci/python:3
-
+      - image: cimg/python:3.12
     steps:
       - checkout
-
       - run:
-          name: Install container dependencies
+          name: Install system deps
           command: |
             sudo apt-get update
-            sudo apt-get install -qq gfortran liblapack-dev
-
+            sudo apt-get install -y --no-install-recommends gfortran liblapack-dev
+      - restore_cache:
+          keys:
+            - v1-pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
+            - v1-pip-{{ arch }}-
       - run:
-          name: Install python dependencies
+          name: Install python deps
           command: |
             python -m venv venv
             . venv/bin/activate
-            # Hack to disable the progress bar
+            pip install -U pip
             set -o pipefail; pip install -r requirements.txt | cat
-
+      - save_cache:
+          key: v1-pip-{{ arch }}-{{ .Branch }}-{{ checksum "requirements.txt" }}
+          paths:
+            - ~/.cache/pip
       - run:
           name: Show versions
           command: |
             . venv/bin/activate
             pip freeze
-
       - run:
           name: Run tests
           command: |
@@ -69,12 +42,9 @@ jobs:
 
 workflows:
   version: 2
-
   on-commit:
     jobs:
-      - python2
       - python3
-
   daily:
     triggers:
       - schedule:
@@ -83,5 +53,4 @@ workflows:
             branches:
               only: master
     jobs:
-      - python2
-      - python3
+      - python3
\ No newline at end of file
diff --git a/chumpy/ch.py b/chumpy/ch.py
index e903df9..2fda05d 100644
--- a/chumpy/ch.py
+++ b/chumpy/ch.py
@@ -1200,7 +1200,7 @@ def depends_on(*dependencies):
             [deps.add(d) for d in dep]
     
     def _depends_on(func):
-        want_out = 'out' in inspect.getargspec(func).args
+        want_out = 'out' in inspect.getfullargspec(func).args
         
         @wraps(func)
         def with_caching(self, *args, **kwargs):
@@ -1243,7 +1243,8 @@ class ChLambda(Ch):
             self.args[argname].x = getattr(self, argname)
     
     def __init__(self, lmb, initial_args=None):
-        args = {argname: ChHandle(x=Ch(idx)) for idx, argname in enumerate(inspect.getargspec(lmb)[0])}
+        argspec_args = inspect.getfullargspec(lmb).args
+        args = {argname: ChHandle(x=Ch(idx)) for idx, argname in enumerate(argspec_args)}
         if initial_args is not None:
             for initial_arg in initial_args:
                 if initial_arg in args:
diff --git a/chumpy/ch_ops.py b/chumpy/ch_ops.py
index f5f2f74..1192ec7 100755
--- a/chumpy/ch_ops.py
+++ b/chumpy/ch_ops.py
@@ -82,7 +82,7 @@ for rtn in not_yet_implemented:
 
 def asarray(a, dtype=None, order=None):
     assert(dtype is None or dtype is np.float64)
-    assert(order is 'C' or order is None)
+    assert(order == 'C' or order is None)
     if hasattr(a, 'dterms'):
         return a
     return Ch(np.asarray(a, dtype, order))
-- 
2.51.0

