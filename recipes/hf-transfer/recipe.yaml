context:
  name: hf-transfer
  version: 0.1.9

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://pypi.org/packages/source/${{ name[0] }}/${{ name }}/hf_transfer-${{ version }}.tar.gz
  sha256: 035572865dab29d17e783fbf1e84cf1cb24f3fcf8f1b17db1cfc7fdf139f02bf

build:
  number: 0
  script:
    - if: unix
      then:
        # https://github.com/rust-lang/cargo/issues/10583#issuecomment-1129997984
        - export CARGO_NET_GIT_FETCH_WITH_CLI=true
        # Optimize the Cargo build
        - export CARGO_PROFILE_RELEASE_STRIP=symbols
        - export CARGO_PROFILE_RELEASE_LTO=fat
        # Install the Python package using maturin
        - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation
        # Generate the THIRDPARTY.yml file
        - cargo-bundle-licenses --format yaml --output ${SRC_DIR}/THIRDPARTY.yml
    - if: win
      then:
        # https://github.com/rust-lang/cargo/issues/10583#issuecomment-1129997984
        - set CARGO_NET_GIT_FETCH_WITH_CLI=true
        # Optimize the Cargo build
        - set CARGO_PROFILE_RELEASE_STRIP=symbols
        - set CARGO_PROFILE_RELEASE_LTO=fat
        # Install the Python package using maturin
        - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation
        # Generate the THIRDPARTY.yml file
        - cargo-bundle-licenses --format yaml --output %SRC_DIR%\THIRDPARTY.yml || goto :error
  skip: not (match(python, python_min ~ ".*") and is_abi3)
  python:
    version_independent: true

requirements:
  build:
    - if: build_platform != target_platform
      then:
        - python
        - cross-python_${{ target_platform }}
        - maturin >=1.4,<2
        - openssl
    - ${{ compiler('c') }}
    - ${{ stdlib('c') }}
    - ${{ compiler('rust') }}
    - cargo-bundle-licenses
    - make
    - pkg-config
    - puccinialin
  host:
    - python
    - python-abi3
    - maturin >=1.4,<2
    - pip
  run:
    - python

tests:
  - python:
      imports:
        - hf_transfer
      python_version: ["${{ python_min ~ '.*' }}"]
      pip_check: true
  - script:
      # NOTE: we must manually set SP_DIR since it is not set.
      # Can be removed once https://github.com/prefix-dev/rattler-build/issues/1733 is fixed.
      - if: unix
        then:
          - export SP_DIR=$(python -c "import site; print(site.getsitepackages()[0])")
          - abi3audit $SP_DIR/hf_transfer/hf_transfer.abi3.so -s -v --assume-minimum-abi3 ${{ python_min }}
      - if: win
        then:
          - set "SP_DIR=%PREFIX%\\Lib\\site-packages"
          - abi3audit %SP_DIR%\\hf_transfer\\hf_transfer.pyd -s -v --assume-minimum-abi3 ${{ python_min }}
    requirements:
      run:
        - abi3audit

about:
  homepage: https://github.com/huggingface/hf_transfer
  summary: Speed up file transfers with the Hugging Face Hub.
  license: Apache-2.0
  license_file:
    - LICENSE
    - THIRDPARTY.yml

extra:
  recipe-maintainers:
    - shermansiu
