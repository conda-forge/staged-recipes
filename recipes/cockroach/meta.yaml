{% set name = "cockroach" %}
{% set version = "19.2.5" %}

package:
  name: go-{{ name|lower }}
  version: {{ version }}

source:
  git_url: ../{{ name }}-v{{ version }}
  #git_depth: 1
  #url: https://binaries.cockroachdb.com/{{ name }}-v{{ version }}.src.tgz
  #sha256: 7908fcf2dfe9fc525b3a5f60983372ab61dc859f28320bd23b2d9afb77cf31bb

build:
  number: 0
  script:
    - export PATH=$(pwd)/src/github.com/cockroachdb/cockroach/bin:${PATH}
    - make install-oss prefix=$PREFIX

requirements:
  build:
    - {{ compiler("go-cgo") }} >=1.12.17,<1.13
    - {{ compiler("c") }} >=6
    - {{ compiler("cxx") }} >=6
    - cmake >=3.8,<4
    - protobuf ==3.6.0
    - yarn

  host:
    #- cryptopp ==5.6.5
    - jemalloc >=4.5.0,<5
    - krb5 >=1.17.0,<2
    # - libprotobuf ==3.6.0  ... missing header files, why????
    - libedit >=3.1,<4
    - rocksdb >=6.2.2,<6.3
    - snappy >=1.1.7,<2

  run:
    - {{ pin_compatible('jemalloc', exact=True) }}
    - {{ pin_compatible('libedit', max_pin="x.x") }}


test:
  commands:
    - cockroach --help

about:
  home: http://cockroachlabs.com
  license: BSL-1.1
  license_file: src/github.com/cockroachdb/cockroach/licenses/BSL.txt
  summary: 'A disaster-surviving, cloud-native SQL database for building global, scalable cloud services.'

  description: |
    CockroachDB is a distributed SQL database built on a transactional and
    strongly-consistent key-value store. It scales horizontally; survives disk,
    machine, rack, and even datacenter failures with minimal latency disruption and
    no manual intervention; supports strongly-consistent ACID transactions; and
    provides a familiar SQL API for structuring, manipulating, and querying data.
  doc_url: https://www.cockroachlabs.com/docs
  dev_url: https://github.com/cockroachdb/cockroach

extra:
  recipe-maintainers:
    - sodre
