{% set version = "2.0.0" %}
{% set commit = "c2e0b548" %}

package:
  name: opentrustregion-split
  version: {{ version }}

source:
  # url: https://github.com/eriksen-lab/opentrustregion/archive/v{{ version }}.tar.bz2
  url: https://github.com/loriab/opentrustregion/archive/cmakeconda.tar.gz
  sha256: 8e6109a7f167a22ad637b6c5b74ebbfe2b25f3f1d409fff51f8fd0fbe3241702

build:
  number: 0
  binary_relocation: true

outputs:
  - name: opentrustregion
    script: build-fortran.sh                                                       # [unix]
    script: bld-fortran.bat                                                        # [win]
    build:
      run_exports:
        - {{ pin_subpackage('opentrustregion', max_pin='x.x') }}
    requirements:
      build:
        - {{ stdlib("c") }}                                                        # [unix]
        - {{ compiler("c") }}                                                      # [unix]
        - {{ compiler("fortran") }}                                                # [unix]
        - {{ stdlib("m2w64_c") }}                                                  # [win]
        - {{ compiler("m2w64_c") }}                                                # [win]
        - {{ compiler("m2w64_fortran") }}                                          # [win]
        - cmake
        - ninja
        - binutils                                                                 # [win]
      host:
        - libblas
        - liblapack
      run:
        - libgcc                                                                   # [osx]
    test:
      commands:
        - ls -l $PREFIX/lib                                                        # [unix]
        - ls -l $PREFIX/lib/cmake/OpenTrustRegion                                  # [unix]
        - dir %PREFIX%\\Library\\lib                                               # [win]
        - dir %PREFIX%\\Library\\OpenTrustRegion\\CMake                            # [win]
        # Verify library
        - test -h $PREFIX/lib/libopentrustregion_32$SHLIB_EXT                      # [unix]
        - test ! -h $PREFIX/lib/libopentrustregion_32.a                            # [unix]
        - if not exist %PREFIX%\\Library\\lib\\libopentrustregion_32.dll.a exit 1  # [win]   # gnu import lib
        - if not exist %PREFIX%\\Library\\lib\\libopentrustregion_32.lib exit 1    # [win]   # ms import lib
        - if not exist %PREFIX%\\Library\\bin\\libopentrustregion_32.dll exit 1    # [win]   # gnu/ms dyn lib
        - if exist %PREFIX%\\Library\\lib\\libopentrustregion_32.a exit 1          # [win]   # gnu static lib absent
        # Verify accessories
        - test -f $PREFIX/include/opentrustregion.h                                # [unix]
        - test -f $PREFIX/lib/cmake/OpenTrustRegion/OpenTrustRegionConfig.cmake    # [unix]
        - test -f $PREFIX/lib/cmake/OpenTrustRegion/OpenTrustRegionTargets.cmake   # [unix]
        - if not exist %PREFIX%\\Library\\include\\opentrustregion.h exit 1        # [win]
        - if not exist %PREFIX%\\Library\\OpenTrustRegion\\CMake\\OpenTrustRegionConfig.cmake exit 1  # [win]
        - if not exist %PREFIX%\\Library\\OpenTrustRegion\\CMake\\OpenTrustRegionTargets.cmake exit 1  # [win]
        # Inspect linkage
        - ldd -v $PREFIX/lib/libopentrustregion_32$SHLIB_EXT                       # [linux and build_platform == target_platform]
        - otool -L $PREFIX/lib/libopentrustregion_32$SHLIB_EXT                     # [osx]
        # Actually test (deferred to Py)

  - name: pyopentrustregion
    build:
      noarch: python
#      skip: true                                                                 # [(aarch64 or ppc64le) and python_impl == 'pypy']
      script: python -m pip install . --no-deps -vv
#      ignore_run_exports:
#        - opentrustregion
      preserve_egg_dir: true
    requirements:
      build:
        - {{ stdlib("c") }}                                                        # [unix]
        - {{ compiler("c") }}                                                      # [unix]
        - {{ compiler("fortran") }}                                                # [unix]
        - {{ stdlib("m2w64_c") }}                                                  # [win]
        - {{ compiler("m2w64_c") }}                                                # [win]
        - {{ compiler("m2w64_fortran") }}                                          # [win]
        - cmake
        - ninja
#        - python                                                                   # [build_platform != target_platform]
#        - cross-python_{{ target_platform }}                                     # [build_platform != target_platform]
      host:
        - {{ pin_subpackage('opentrustregion', exact=True) }}
        - python {{ python_min }}
        - pip
        - setuptools
        - wheel
        - libblas
        - liblapack
      run:
        - {{ pin_subpackage('opentrustregion', exact=True) }}
        - python >={{ python_min }}
        - numpy
        - libgfortran5
        - libblas
        - liblapack
    test:
      requires:
        - pip                                                                      # provides `pip check`
        - python {{ python_min }}
      imports:
        - pyopentrustregion
        - pyopentrustregion.testsuite
      commands:
        - ls -l $SP_DIR/pyopentrustregion                                          # [unix]
        - ls -l $SP_DIR/pyopentrustregion/test_data                                # [unix]
        - dir %SP_DIR%\\pyopentrustregion                                          # [win]
        # Verify module
        - test ! -f $SP_DIR/pyopentrustregion/libopentrustregion*.so                 # [unix]
        - test -f $SP_DIR/pyopentrustregion/python_interface.py                    # [unix]
#        - if not exist %SP_DIR%\\gdma*.pyd exit 1                                  # [win]
        - if not exist %SP_DIR%\\pyopentrustregion\\python_interface.py exit 1     # [win]
        # Verify accessories
#        - test -f $PREFIX/share/cmake/gdma/gdmaConfig.cmake                        # [unix]
#        - test -f $PREFIX/share/cmake/gdma/gdmaTargets-Python.cmake                # [unix]
        - test -f $SP_DIR/pyopentrustregion/test_data/h2o_r_ints.bin               # [unix]
#        - if not exist %PREFIX%\\Library\\share\\cmake\\gdma\\gdmaConfig.cmake exit 1  # [win]
#        - if not exist %PREFIX%\\Library\\share\\cmake\\gdma\\gdmaTargets-Python.cmake exit 1  # [win]
        # Actually test
        - pip check
        - python -m pyopentrustregion.testsuite

about:
  home: https://github.com/eriksen-lab/opentrustregion
  dev_url: https://github.com/eriksen-lab/opentrustregion
  doc_url: https://github.com/eriksen-lab/opentrustregion/blob/main/README.md
  license: MPL-2.0
  license_url: https://opensource.org/licenses/MPL-2.0
  license_file: LICENSE
  license_family: MOZILLA
  summary: "A Reusable Library for Second-Order Trust Region Orbital Optimization"

extra:
  feedstock-name: opentrustregion
  recipe-maintainers:
    - loriab
    - jonas-greiner
