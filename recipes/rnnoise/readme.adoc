= RNNoise Recipe CMake Conversion with Model Management
:toc:
:toc-placement: preamble
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: rouge

This document provides a comprehensive overview of the RNNoise conda-forge recipe,
which has been converted to use CMake as the primary build system with integrated official model downloading capabilities.

== Overview

The RNNoise conda-forge recipe has been successfully converted from autotools to a fully CMake-based build system.
There is a conversion tool which is a modular nushell-based model management system that downloads official RNNoise models directly from Xiph.org.
However, this tool is not used in the recipe, rather the model is downloaded directly as a tarball.
The model value can be obtained from the `model_version` file, which is used to ensure compatibility with official models.
https://github.com/xiph/rnnoise/blob/v0.2/model_version
Add this value to the context in the `recipe/meta.yaml` file.

== Key Features

=== CMake Build System

* *Cross-platform*: Single CMake build system for Linux, macOS, and Windows
* *Modern tooling*: Uses Ninja generator for fast parallel builds
* *Consistent*: Unified configuration and build logic across all platforms
* *Maintainable*: Standard CMake patterns and practices

=== Official Model Management

* *Official source*: Downloads models directly from `https://media.xiph.org/rnnoise/models/`
* *Version-aware*: Uses `model_version` file for proper model versioning
* *Checksum validation*: SHA256 verification of downloaded models
* *Fallback support*: Template-based fallback when models unavailable
* *Pure nushell*: No external dependencies for HTTP operations

=== Modular Architecture

* *Separation of concerns*: Model management separated from build process
* *Reusable components*: Model module can be used independently
* *Clean interfaces*: Well-defined module exports and error handling
* *Comprehensive logging*: Clear progress indicators and error messages

== File Structure

[source,text]
----
recipes/rnnoise/
‚îú‚îÄ‚îÄ recipe.yaml              # Conda recipe (CMake-based)
‚îú‚îÄ‚îÄ CMakeLists.txt           # Cross-platform CMake build file
‚îú‚îÄ‚îÄ build.nu                 # Main nushell build script
‚îú‚îÄ‚îÄ rnnoise-models.nu        # Model management module
‚îú‚îÄ‚îÄ rnnoise-config.cmake.in  # CMake package config template
‚îú‚îÄ‚îÄ rnnoise.pc.in            # pkg-config template (Unix)
‚îú‚îÄ‚îÄ rnnoise_data.h.in        # Fallback header template
‚îú‚îÄ‚îÄ rnnoise_data.c.in        # Fallback source template
‚îî‚îÄ‚îÄ readme.adoc              # This documentation
----

== Build Dependencies

=== Core Dependencies

* `cmake`: Build system generator (‚â•3.15)
* `ninja`: Fast parallel build tool
* `nushell`: For build scripting and model management
* C compiler and standard library

=== Platform-Specific

* *Unix/Linux/macOS*: `pkg-config` for metadata generation
* *Windows*: Uses standard MSVC toolchain

=== Removed Dependencies

The CMake conversion eliminated the following autotools dependencies:

* `autoconf` / `automake` / `libtool`
* `make`
* `wget` / `curl` (replaced with nushell's `http get`)

== Model Management System

=== rnnoise-models.nu Module

The model management is handled by a dedicated nushell module with the following capabilities:

==== Main Functions

* `download-models` - Downloads official RNNoise models
* `download-models-manual` - Manual download with full validation
* `extract-model` - Extracts and validates model archives
* `list-model-files` - Lists current model files
* `create-fallback-models` - Creates template fallback files

==== Download Process

. *Official script check*: Looks for `download_model.sh` script
. *Model version detection*: Reads `model_version` file for hash
. *HTTP download*: Uses nushell's `http get` to download from Xiph.org
. *Checksum validation*: Validates SHA256 hash using nushell's `hash` command
. *Extraction*: Extracts model archive using `tar`
. *Fallback creation*: Creates templates if download fails

==== Error Handling

* Graceful degradation when models unavailable
* Comprehensive error reporting with actionable information
* Multiple fallback strategies (script ‚Üí manual ‚Üí templates)
* Non-blocking failures (build continues with defaults)

== CMake Configuration

=== Build Process

. *Model download*: Execute model management module
. *CMake configuration*: Set up build with appropriate flags
. *Ninja compilation*: Fast parallel build
. *Installation*: Install libraries, headers, and metadata
. *Verification*: Confirm all expected files are present

=== Key CMake Features

==== Intelligent Model Detection

[source,cmake]
----
# Check for extracted model files first (from official download)
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/rnnoise_data.h" AND
   EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/rnnoise_data.c")
    message(STATUS "Found extracted model data files in root - using downloaded model")
    set(HAS_MODEL_DATA TRUE)
    set(MODEL_DATA_DIR "${CMAKE_CURRENT_SOURCE_DIR}")
elseif(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/rnnoise_data.h" AND
       EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/rnnoise_data.c")
    message(STATUS "Found model data files in src/ - using custom model")
    set(HAS_MODEL_DATA TRUE)
    set(MODEL_DATA_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src")
----

==== Flexible Source Detection

[source,cmake]
----
# Filter to only include sources that actually exist
set(SOURCES)
foreach(source_file ${CORE_SOURCES})
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/${source_file}")
        list(APPEND SOURCES ${source_file})
    else()
        message(STATUS "Skipping missing source: ${source_file}")
    endif()
endforeach()
----

==== Cross-Platform Configuration

[source,cmake]
----
if(WIN32)
    target_compile_definitions(rnnoise PRIVATE
        WIN32 _WINDOWS _USE_MATH_DEFINES _CRT_SECURE_NO_WARNINGS)
endif()

if(UNIX)
    target_link_libraries(rnnoise PRIVATE m)
    set_target_properties(rnnoise PROPERTIES
        VERSION 0.4.1 SOVERSION 0)
endif()
----

== Build Process Flow

=== 1. Model Management Phase

[source,nu]
----
# Download official RNNoise models using the models module
print "üì• Attempting to download official RNNoise models..."
let download_success = (download-models)

if $download_success {
    print "‚úÖ Model download completed successfully"
} else {
    print "‚ö†Ô∏è  Model download failed or not available, using fallbacks"
    create-fallback-models
}
----

=== 2. CMake Configuration Phase

[source,nu]
----
# Configure with CMake
print "üîß Configuring with CMake..."
cd build

let cmake_args = [
    ".."
    $"-DCMAKE_INSTALL_PREFIX=($env.PREFIX)"
    $"-DCMAKE_BUILD_TYPE=Release"
    "-G" "Ninja"
]

let configure_result = (^cmake ...$final_cmake_args | complete)
----

=== 3. Build and Install Phase

[source,nu]
----
# Build with Ninja
print "üèóÔ∏è  Building with Ninja..."
let cpu_count = ($env.CPU_COUNT? | default "1")
let build_result = (^ninja $"-j($cpu_count)" | complete)

# Install with Ninja
print "üì¶ Installing with Ninja..."
let install_result = (^ninja install | complete)
----

== Testing and Verification

The recipe includes comprehensive tests for both Unix and Windows platforms:

=== Unix Testing

[source,yaml]
----
- if: unix
  then:
    - test -f $PREFIX/lib/librnnoise${SHLIB_EXT}
    - test -f $PREFIX/include/rnnoise.h
    - pkg-config --exists --print-errors rnnoise
    - pkg-config --modversion rnnoise
----

=== Windows Testing

[source,yaml]
----
- if: win
  then:
    - if not exist "%LIBRARY_LIB%\rnnoise.lib" exit 1
    - if not exist "%LIBRARY_INC%\rnnoise.h" exit 1
----

== Compatibility and Migration

=== Backward Compatibility

* *API/ABI compatibility*: Same interface as autotools builds
* *pkg-config support*: Full metadata compatibility on Unix
* *CMake integration*: Enhanced `find_package()` support
* *Library versioning*: Proper SONAME handling on Unix

=== Migration Benefits

* *Faster builds*: Ninja generator with parallel compilation
* *Reduced dependencies*: Fewer external tools required
* *Better reliability*: Official model sources eliminate compatibility issues
* *Modern tooling*: Better IDE integration and debugging
* *Simplified maintenance*: Single build system to maintain
* *Enhanced portability*: Better cross-platform consistency

== Technical Implementation Details

=== Model Download Implementation

The model download uses RNNoise v0.2's official mechanism:

[source,nu]
----
# Manual download using model_version file
let hash = (open "model_version" | str trim)
let model = $"rnnoise_data-($hash).tar.gz"
let download_url = $"https://media.xiph.org/rnnoise/models/($model)"

# Use nushell's built-in http get command
http get $download_url | save $model

# Validate checksum using nushell's built-in hash command
let actual_hash = (open $model | hash sha256)
if $actual_hash == $hash {
    print "‚úÖ Checksum validation passed"
    extract-model $model
}
----

=== CMake Installation

[source,cmake]
----
# Installation configuration
install(TARGETS rnnoise
    EXPORT rnnoise-targets
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib)

# Install headers
install(FILES "include/rnnoise.h" DESTINATION include)

# Generate pkg-config file for Unix platforms
if(UNIX)
    configure_file("${CMAKE_CURRENT_LIST_DIR}/rnnoise.pc.in"
                   "${CMAKE_CURRENT_BINARY_DIR}/rnnoise.pc" @ONLY)
    install(FILES "${CMAKE_CURRENT_BINARY_DIR}/rnnoise.pc"
            DESTINATION lib/pkgconfig)
endif()
----

== Troubleshooting

=== Common Issues

==== Model Download Failures

* *Network issues*: Check internet connectivity
* *Checksum mismatches*: Corrupted download, will retry automatically
* *Missing model_version*: Recipe will use template fallbacks

==== Build Failures

* *Missing CMake*: Ensure CMake ‚â•3.15 is available
* *Missing Ninja*: Install ninja build tool
* *Compiler issues*: Verify C compiler and standard library

==== Runtime Issues

* *Missing libraries*: Check installation paths
* *Symbol errors*: Verify proper linking and SONAME
* *pkg-config failures*: Ensure proper installation on Unix

=== Debug Information

The build process provides comprehensive logging:

[source,nu]
----
# Model status
list-model-files

# CMake configuration output
print $"üìã stdout: ($configure_result.stdout)"
print $"üìã stderr: ($configure_result.stderr)"

# Build verification
print "üîç Verifying installation..."
----

== Future Enhancements

=== Potential Improvements

* *Model caching*: Cache downloaded models across builds
* *Multiple model support*: Support for different model variants
* *Build optimization*: Further compiler optimizations
* *Testing expansion*: More comprehensive runtime tests

=== Maintenance Tasks

* *Dependency updates*: Keep CMake and nushell current
* *Model updates*: Track new official model releases
* *Platform testing*: Regular validation across platforms
* *Performance monitoring*: Track build and runtime performance

== Conclusion

The RNNoise recipe now uses a modern, reliable build system that:

* *Eliminates compatibility issues*: Uses official model sources
* *Simplifies maintenance*: Single CMake build system
* *Improves reliability*: Comprehensive error handling and fallbacks
* *Enhances performance*: Fast parallel builds with Ninja
* *Maintains compatibility*: Full backward compatibility with existing consumers
* *Provides better tooling*: Modern development environment support

This conversion represents a significant improvement in the RNNoise conda-forge recipe,
providing a robust foundation for future development while maintaining full compatibility with existing software that depends on the RNNoise library.

The modular design with dedicated model management makes the recipe more maintainable and provides clear separation of concerns,
while the CMake-based build system offers better cross-platform consistency and performance.
