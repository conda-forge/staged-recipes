## Need these up here for conda-smithy to handle them properly.
#schema_version: 1

#context:
#  name: "iris-segmentation"
#  version: "0.6"
#  commit: "1521db8"
#  sha256 = "b3889f04b6d876135b5ad06b57d9db5f9e9818b6ce5f7855797c67cf86c84130"

{% set name = "iris-segmentation" %}
{% set version = "0.6" %}
#{% set commit = "4b321fa" %}
  #url: https://github.com/gt-sse-center/iris/archive/4b321fa.tar.gz
{% set sha256 = "b3889f04b6d876135b5ad06b57d9db5f9e9818b6ce5f7855797c67cf86c84130" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

#recipe:
#  name: ${{ name }}-split
#  version: ${{ version }}

source:
  #url: https://github.com/gt-sse-center/iris/archive/${{ commit }}.tar.gz
  #url: https://github.com/gt-sse-center/iris/archive/{{ commit }}.tar.gz
  url: https://github.com/loriab/iris/archive/packaging.tar.gz
  # url: https://pypi.org/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz
  # url: https://github.com/ray-project/ray/archive/ray-${{ version }}.tar.gz
  #sha256: ${{ sha256 }}
  sha256: {{ sha256 }}

#build:
#  number: 0


#outputs:
#  - package:
#      name: ray-all
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - if: not osx
#          then: ${{ pin_subpackage('ray-adag', exact=True) }}
#        - ${{ pin_subpackage('ray-air', exact=True) }}
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - if: not osx
#          then: ${{ pin_subpackage('ray-cgraph', exact=True) }}
#        - ${{ pin_subpackage('ray-client', exact=True) }}
#        - ${{ pin_subpackage('ray-data', exact=True) }}
#        - ${{ pin_subpackage('ray-rllib', exact=True) }}
#        - ${{ pin_subpackage('ray-serve', exact=True) }}
#        - ${{ pin_subpackage('ray-train', exact=True) }}
#        - ${{ pin_subpackage('ray-tune', exact=True) }}
#    tests:
#      - python:
#          imports:
#            - ray
#
#  - package:
#      name: ray-core
#    build:
#      script: build-core
#      python:
#        entry_points:
#          - ray = ray.scripts.scripts:main
#    requirements:
#      build:
#        - ${{ compiler('c') }}
#        - ${{ stdlib("c") }}
#        - ${{ compiler('cxx') }}
#        - bazel =6.5
#        - if: not win
#          then: bazel-toolchain =0.2.1
#        - if: linux
#          then: patchelf
#        - colorama
#        - curl
#        - cython >=0.29.32
#        - if: win
#          then: git =2.33
#        - if: linux and match(python, "<3.9")
#          then: libxcrypt
#        - make
#        - if: win
#          then: m2-bash
#        - psutil
#        - python
#        - setproctitle >=1.2.2,<1.4
#        - if: not win
#          then: unzip
#        - if: win
#          then: m2-unzip
#        - if: build_platform != target_platform
#          then: cross-python_${{ target_platform }}
#      host:
#        - python
#        - pip
#        - packaging
#        - libgrpc
#        - openjdk =11
#        - setuptools
#        - cython >=3.0.12
#      run:
#        - python
#        - aiohttp >=3.7
#        - click >=7.0,<8.3.0
#        - colorama
#        - filelock
#        - jsonschema
#        - msgpack-python >=1.0.0,<2.0.0
#        - packaging
#        - protobuf >=3.20.3
#        - psutil
#        - pyyaml
#        - requests
#    tests:
#      - python:
#          imports:
#            - ray
#            - ray._raylet
#            - ray.actor
#            - ray.runtime_context
#            - ray._private.state
#            - ray._private.worker
#      - script:
#          - python -c "import ray; ray.init(include_dashboard=False)"
#          - ray --help
#
#  # the various ray[extra] installs, alphabetically
#  - package:
#      name: ray-air
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-data', exact=True) }}
#        - ${{ pin_subpackage('ray-serve', exact=True) }}
#        - ${{ pin_subpackage('ray-train', exact=True) }}
#        - ${{ pin_subpackage('ray-tune', exact=True) }}
#    tests:
#      - python:
#          imports:
#            - ray.air
#
#  - package:
#      name: ray-data
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-core', exact=True) }}
#        - pandas >=1.3
#        - numpy >=1.20
#        - pyarrow >=9.0.0
#        - fsspec
#    tests:
#      - python:
#          imports:
#            - ray.data

#  - package:
#      name: iris-segmentation
build:
  number: 0
  noarch: python
  script:
##        - cd python/ray/dashboard/client
    - npm install
    - npm ci
    - npm run build
    - {{ PYTHON }} -m pip install . --no-deps -vv
##        # not sure why this seems to get copied on windows but not linux...
##        - if: not win
##          then:
##            - mkdir -p $SP_DIR/ray/dashboard/client
##            - cp -R ./build $SP_DIR/ray/dashboard/client/build
#        - pip install -e .
#script: {{ PYTHON }} -m pip install . --no-deps -vv
requirements:
      build:
        - nodejs >=18
      host:
        - python {{ python_min }}
        - pip
        - setuptools >=61.0
      run:
        - python >={{ python_min }}
#        - ${{ pin_subpackage('ray-core', exact=True) }}
#        - aiohttp-cors
#        - colorful
#        - grpcio
#        - opencensus
#        - opentelemetry-sdk >=1.30.0
        - flask
        - flask-compress >=1.13
        - flask-sqlalchemy >=2.5.1,<4.0
        - numpy
        - pyyaml
        - lightgbm
        - rasterio
        - requests
        - scipy
        - scikit-image
        - scikit-learn
        - sqlalchemy
        - matplotlib
        - gevent
        - typer

        - libnetcdf

#        # upstream doesn't have a lowerbound, but old versions on conda-forge
#        # are missing some constraints that result in a weird solve and break
#        - opentelemetry-exporter-prometheus >=0.51b0
#        - opentelemetry-proto
#        - prometheus_client >=0.7.1
#        - if: match(python, "<3.12")
#          then: py-spy >=0.2.0
#        - if: match(python, ">=3.12")
#          then: py-spy >=0.4.0
#        - pydantic !=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3
#        - requests
#        - smart_open
#        - virtualenv >=20.0.24,!=20.21.1
test:
  requires:
    - pytest
  commands:
    - test -f $SP_DIR/iris/__init__.py
    - test -f $SP_DIR/iris/demo/cloud-segmentation.json
    - test -f $SP_DIR/iris/static/dist/segmentationApp.js
    - conda list
    - iris --help
    - python -m pytest -v
#      - script:
#          - python -c "import ray; ray.init(include_dashboard=True)"
  imports:
    - iris
      #- python:
      #    imports:
      #      - iris

#  - package:
#      name: ray-client
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-core', exact=True) }}
#        - grpcio
#    tests:
#      - python:
#          imports:
#            - ray
#      - script:
#          - ray start --head
#          - python -c "import ray; ray.init('ray://127.0.0.1:10001')"
#          - ray stop
#
#  - package:
#      name: ray-rllib
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-tune', exact=True) }}
#        - dm-tree
#        - gymnasium ==1.1.1
#        - lz4
#        - ormsgpack ==1.7.0
#        - pyyaml
#        - scipy
#    tests:
#      - python:
#          imports:
#            - ray.rllib
#
#  - package:
#      name: ray-serve
#    build:
#      python:
#        entry_points:
#          - serve = ray.serve.scripts:cli
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - fastapi
#        - requests
#        - starlette
#        - uvicorn
#        - watchfiles
#        - pyOpenSSL
#    tests:
#      - python:
#          imports:
#            - ray.serve
#
#  - package:
#      name: ray-tune
#    build:
#      python:
#        entry_points:
#          - tune = ray.tune.scripts:cli
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - fsspec
#        - pandas
#        - pyarrow
#        - requests
#        - tensorboardX >=1.9
#    tests:
#      - python:
#          imports:
#            - ray.tune
#
#  - package:
#      name: ray-train
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-tune', exact=True) }}
#        - pydantic !=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3
#    tests:
#      - python:
#          imports:
#            - ray.train
#
#  - package:
#      name: ray-observability
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - if: not win
#          then: memray
#    tests:
#      - script:
#          - echo "no tests for ray-observability, it is a convenience bundle"
#
#  - package:
#      name: ray-adag
#    build:
#      skip: osx
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - cupy
#    tests:
#      - script:
#          - echo "no tests for ray-adag, it is a convenience bundle"
#
#  - package:
#      name: ray-cgraph
#    build:
#      skip: osx
#    requirements:
#      host:
#        - python
#      run:
#        - python
#        - ${{ pin_subpackage('ray-default', exact=True) }}
#        - cupy
#    tests:
#      - script:
#          - echo "no tests for ray-cgraph, it is a convenience bundle"

about:
  license: GPL-3.0-only
  license_file:
    - LICENSE
  license_url: https://opensource.org/license/gpl-3-0/
  license_family: GPL
  summary: IRIS is a semi-automatic tool for manual segmentation of multi-spectral and geo-spatial imagery.
  description: |
    IRIS is a tool for manual image segmentation of satellite imagery (or images
    in general). It was designed to accelerate the creation of machine learning
    training datasets for Earth Observation. This application is a flask app
    which can be run locally. Special highlights:
    * Support by AI (gradient boosted decision tree) when doing image segmentation
    * Multiple and configurable views for multispectral imagery
    * Simple setup with pip and one configuration file
    * Platform independent app (runs on Linux, Windows and Mac OS)
    * Multi-user support: work in a team on your dataset and merge the results
  homepage: https://github.com/gt-sse-center/iris
  # further upstream https://github.com/ESA-PhiLab/iris
  repository: https://github.com/gt-sse-center/iris
  documentation: https://github.com/gt-sse-center/iris/tree/master/docs

extra:
  feedstock-name: iris-segmentation
  recipe-maintainers:
    - loriab
    - rfievet
    - aliFrancis
    - DrJacqo 

