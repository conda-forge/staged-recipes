From c826dc7dd22a02690b50c0e8ce8d37443086680f Mon Sep 17 00:00:00 2001
From: Toni G <toni.giorgino@gmail.com>
Date: Fri, 30 Nov 2018 21:44:38 +0100
Subject: [PATCH] test patch

mv xxd

regen configure
---
 configure            | 57 +++++++++++---------------------------------
 configure.ac         |  6 +----
 src/cltools/Makefile |  2 +-
 src/config/Makefile  |  2 +-
 xxd-i.py             | 11 +++++++++
 5 files changed, 28 insertions(+), 50 deletions(-)
 create mode 100644 xxd-i.py

diff --git a/configure b/configure
index 113b119d9..04cdbb5ec 100755
--- a/configure
+++ b/configure
@@ -630,7 +630,6 @@ use_loader_path
 use_absolute_soname
 program_can_run_mpi
 program_can_run
-xxd
 make_pdfdoc
 dot
 doxygen
@@ -679,6 +678,7 @@ infodir
 docdir
 oldincludedir
 includedir
+runstatedir
 localstatedir
 sharedstatedir
 sysconfdir
@@ -804,6 +804,7 @@ datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
 localstatedir='${prefix}/var'
+runstatedir='${localstatedir}/run'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
 docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
@@ -1056,6 +1057,15 @@ do
   | -silent | --silent | --silen | --sile | --sil)
     silent=yes ;;
 
+  -runstatedir | --runstatedir | --runstatedi | --runstated \
+  | --runstate | --runstat | --runsta | --runst | --runs \
+  | --run | --ru | --r)
+    ac_prev=runstatedir ;;
+  -runstatedir=* | --runstatedir=* | --runstatedi=* | --runstated=* \
+  | --runstate=* | --runstat=* | --runsta=* | --runst=* | --runs=* \
+  | --run=* | --ru=* | --r=*)
+    runstatedir=$ac_optarg ;;
+
   -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
     ac_prev=sbindir ;;
   -sbindir=* | --sbindir=* | --sbindi=* | --sbind=* | --sbin=* \
@@ -1193,7 +1203,7 @@ fi
 for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
 		datadir sysconfdir sharedstatedir localstatedir includedir \
 		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
-		libdir localedir mandir
+		libdir localedir mandir runstatedir
 do
   eval ac_val=\$$ac_var
   # Remove trailing slashes.
@@ -1346,6 +1356,7 @@ Fine tuning of the installation directories:
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
   --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
+  --runstatedir=DIR       modifiable per-process data [LOCALSTATEDIR/run]
   --libdir=DIR            object code libraries [EPREFIX/lib]
   --includedir=DIR        C header files [PREFIX/include]
   --oldincludedir=DIR     C header files for non-gcc [/usr/include]
@@ -9533,47 +9544,7 @@ $as_echo "$as_me: A PDF version of the manual will not be generated" >&6;}
 fi
 
 ### Look for xxd
-# Extract the first word of "xxd", so it can be a program name with args.
-set dummy xxd; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if ${ac_cv_prog_xxd+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$xxd"; then
-  ac_cv_prog_xxd="$xxd" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
-    ac_cv_prog_xxd="found"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-xxd=$ac_cv_prog_xxd
-if test -n "$xxd"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $xxd" >&5
-$as_echo "$xxd" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-if test "$xxd" != found
-then
-  as_fn_error $? "xxd should be installed for PLUMED to compile properly" "$LINENO" 5
-fi
+# Test deleted, replaced by xxd-i.py
 
 
 program_can_run=""
diff --git a/configure.ac b/configure.ac
index 73a717ce7..a7978c3af 100644
--- a/configure.ac
+++ b/configure.ac
@@ -936,11 +936,7 @@ else
 fi
 
 ### Look for xxd
-AC_CHECK_PROG([xxd],[xxd],[found])
-if test "$xxd" != found
-then
-  AC_MSG_ERROR([xxd should be installed for PLUMED to compile properly])
-fi
+# Test deleted, replaced by xxd-i.py
 
 AC_SUBST(program_can_run)
 program_can_run=""
diff --git a/src/cltools/Makefile b/src/cltools/Makefile
index fbaef65d0..6fadb2410 100644
--- a/src/cltools/Makefile
+++ b/src/cltools/Makefile
@@ -6,5 +6,5 @@ include ../maketools/make.module
 Completion.o: completion.xxd
 
 completion.xxd: completion.sh ../../scripts/*.sh ../../patches/*.sh
-	{ ../maketools/make-scripts-options.sh ; cat completion.sh ; }| xxd -i > completion.xxd
+	{ ../maketools/make-scripts-options.sh ; cat completion.sh ; }| python3 ../../xxd-i.py > completion.xxd
 
diff --git a/src/config/Makefile b/src/config/Makefile
index b2edd92bf..c5e494dde 100644
--- a/src/config/Makefile
+++ b/src/config/Makefile
@@ -64,7 +64,7 @@ Config.o: Config.inc Makefile.conf.xxd version.h
 ConfigInstall.o: ConfigInstall.inc Makefile.conf.xxd version.h
 
 Makefile.conf.xxd: ../../Makefile.conf
-	cat ../../Makefile.conf | xxd -i > Makefile.conf.xxd
+	cat ../../Makefile.conf | python3 ../../xxd-i.py > Makefile.conf.xxd
 
 # file to import compilation options inside a bash script
 compile_options.sh: ../../Makefile.conf
diff --git a/xxd-i.py b/xxd-i.py
new file mode 100644
index 000000000..11fbb0f03
--- /dev/null
+++ b/xxd-i.py
@@ -0,0 +1,11 @@
+#!/usr/bin/env python3
+# Replaces xxd -i for systems without it (e.g. conda). Only stdin.
+
+import sys
+import textwrap
+
+data=sys.stdin.buffer.read()
+
+#xdata=", ".join([hex(x) for x in data])
+xdata=", ".join([f'0x{y:02x}' for y in data])
+print(textwrap.fill(xdata,75))
-- 
2.17.1

