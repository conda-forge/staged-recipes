context:
  version: 0.0.2
  python_min: "3.11"

recipe:
  name: diracx
  version: ${{ version }}

build:
  number: 0

outputs:
  # TODO: This should move to the dirac-grid feedstock but for the first release there is a bootstrap issue with DiracX
  - package:
      name: diraccommon
      version: 9.0.11

    source:
      - url: https://pypi.org/packages/source/d/diraccommon/diraccommon-9.0.11.tar.gz
        sha256: f5223f57917b5823150354933cef87e973ee126aea62c638e66a654d40c9fbbb
      - url: https://raw.githubusercontent.com/DIRACGrid/DIRAC/refs/tags/v9.0.11/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diraccfg
      - pydantic >=2.0.0
      - typing-extensions >=4.0.0

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - DIRACCommon
        pip_check: true

    about:
      homepage: https://github.com/DIRACGrid/DIRAC/tree/integration/dirac-common
      summary: Stateless utilities extracted from DIRAC for use by DiracX and other projects
      license: GPL-3.0-only
      repository: https://github.com/DIRACGrid/DIRAC
      documentation: https://dirac.readthedocs.io/


  - package:
      name: diracx-api

    source:
      - url: https://pypi.org/packages/source/d/diracx-api/diracx_api-${{ version }}.tar.gz
        sha256: b71704c7ca560eb672c2158cdc8c907b0854cca40f7fe49aae2deb5daf2213e4
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}
      - httpx
      - zstandard

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.api
        pip_check: true

    about:
      summary: Python API for interacting with DiracX services

  - package:
      name: diracx-cli

    source:
      - url: https://pypi.org/packages/source/d/diracx-cli/diracx_cli-${{ version }}.tar.gz
        sha256: b79b828943805a1d16dc5f583dcdbb60f950f415d4071f5599428aa90738297f
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      python:
        entry_points:
        - dirac = diracx.cli:app
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diraccfg
      - diracx-api ==${{ version }}
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}
      - gitpython
      - pydantic >=2.10
      - pyyaml
      - rich
      - typer >=0.15.4

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.cli
        pip_check: true
    - script:
      - dirac --help

    about:
      summary: Command line interface for DiracX

  - package:
      name: diracx-client

    source:
      - url: https://pypi.org/packages/source/d/diracx-client/diracx_client-${{ version }}.tar.gz
        sha256: a12eb7967e9ac57ab957fb84516e0c0cc8bcd043853eac2f90b581ea42117429
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - azure-core
      - diracx-core ==${{ version }}
      - httpx
      - isodate
      - pyjwt

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.client
        pip_check: true

    about:
      summary: Client library for DiracX services from OpenAPI specifications

  - package:
      name: diracx-core

    source:
      - url: https://pypi.org/packages/source/d/diracx-core/diracx_core-${{ version }}.tar.gz
        sha256: 9c6a2ddb80d3a2a00c920f305b201d4fbfa514d0a27da343bc54702eaf0721f5
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - aiobotocore >=2.15
      - botocore >=1.35
      - cachetools
      - diraccommon >=9.0.0
      - email-validator
      - gitpython
      - joserfc >=1.1.0
      - pydantic-settings
      - pydantic >=2.10
      - pyyaml
      - sh

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.core
        pip_check: true

    about:
      summary: Common code used by all DiracX packages
      license: GPL-3.0-only

  - package:
      name: diracx-db

    source:
      - url: https://pypi.org/packages/source/d/diracx-db/diracx_db-${{ version }}.tar.gz
        sha256: 9b94fe6d19b529368875b084c8337f455d5e7e277e66e619b6c18bcbdde11c96
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diracx-core ==${{ version }}
      - opensearch-py
      - aiohttp>=3.12.14,<4  # Needed for opensearch-py's async extra
      - pydantic >=2.10
      - python-dateutil
      - sqlalchemy-with-aiomysql
      - sqlalchemy-with-aiosqlite
      - uuid-utils

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.db
        pip_check: true

    about:
      summary: Data Access Layer for DiracX database functionalities
  
  - package:
      name: diracx-logic

    source:
      - url: https://pypi.org/packages/source/d/diracx-logic/diracx_logic-${{ version }}.tar.gz
        sha256: a6b6554b1cff3d8592bd5956fbf7cbc5c231c269c9f307ddf821ce9498903b38
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - cachetools
      - diraccommon >=9.0.0
      - diracx-core ==${{ version }}
      - diracx-db ==${{ version }}
      - joserfc
      - pydantic >=2.10
      - uuid-utils

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.logic
        pip_check: true

    about:
      summary: Business Logic Layer containing DiracX logic
      description: ''
      license: GPL-3.0-only

  - package:
      name: diracx-routers

    source:
      - url: https://pypi.org/packages/source/d/diracx-routers/diracx_routers-${{ version }}.tar.gz
        sha256: ace7511056525dd18f049be5977c3341ecf68430318a0e2951261ad8dab33da9
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - cachetools
      - diracx-core ==${{ version }}
      - diracx-db ==${{ version }}
      - diracx-logic ==${{ version }}
      - fastapi
      - httpx
      - joserfc
      - opentelemetry-api
      - opentelemetry-exporter-otlp
      - opentelemetry-instrumentation-fastapi
      - opentelemetry-instrumentation-logging
      - opentelemetry-sdk
      - pydantic >=2.10
      - python-dotenv
      - python-multipart
      - uvicorn

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.routers
        pip_check: true

    about:
      summary: FastAPI routers providing HTTP endpoints for DiracX services

  - package:
      name: diracx-testing

    source:
      - url: https://pypi.org/packages/source/d/diracx-testing/diracx_testing-${{ version }}.tar.gz
        sha256: 75b77935b90b0ad604b9f6ab1947f8ca5f0ff4747bbb427d75f2237882c5af84
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diracx-core ==${{ version }}
      - httpx
      - joserfc
      - pytest
      - pytest-asyncio ==1.0.0
      - pytest-cov
      - pytest-github-actions-annotate-failures
      - pytest-xdist
      - uuid-utils

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx.testing
        pip_check: true

    about:
      summary: Testing utilities and fixtures for DiracX development

  - package:
      name: diracx

    source:
      - url: https://pypi.org/packages/source/d/diracx/diracx-${{ version }}.tar.gz
        sha256: 7452c349fb47136a4bcdb23e7eabbd5bd3ed45345130349890ce30e0f56608d8
      - url: https://raw.githubusercontent.com/DIRACGrid/diracx/refs/tags/v${{ version }}/LICENSE
        sha256: bb2af8a15ea39a351e7a95d93cf8e4251c1ae6ae4cac8ee3a89cf9b155cd6e54

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python ${{ python_min }}.*
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=${{ python_min }}
      - diracx-api ==${{ version }}
      - diracx-cli ==${{ version }}
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}

    tests:
    - python:
        python_version: ${{ python_min }}.*
        imports:
        - diracx
        - diracx.core
        - diracx.api
        - diracx.cli
        - diracx.client
        pip_check: true

    about:
      summary: Client installation for users of DiracX installations

about:
  summary: A framework for managing grid-style resources
  homepage: https://diracx.diracgrid.org/
  license: GPL-3.0-only
  license_file: LICENSE

extra:
  feedstock-name: diracx
  recipe-maintainers:
    - chrisburr
