context:
  version: 0.0.2

outputs:
  # TODO: This should move to the dirac-grid feedstock but for the first release there is a bootstrap issue with DiracX
  - package:
      name: diraccommon
      version: 9.0.11

    source:
      url: https://pypi.org/packages/source/d/diraccommon/diraccommon-9.0.11.tar.gz
      sha256: f5223f57917b5823150354933cef87e973ee126aea62c638e66a654d40c9fbbb

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diraccfg
      - pydantic >=2.0.0
      - typing-extensions >=4.0.0

    tests:
    - python:
        imports:
        - DIRACCommon
        pip_check: true

    about:
      homepage: https://github.com/DIRACGrid/DIRAC/tree/integration/dirac-common
      summary: Stateless utilities extracted from DIRAC for use by DiracX and other projects
      license: GPL-3.0-only
      repository: https://github.com/DIRACGrid/DIRAC
      documentation: https://dirac.readthedocs.io/


  - package:
      name: diracx-api
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-api/diracx_api-${{ version }}.tar.gz
      sha256: b71704c7ca560eb672c2158cdc8c907b0854cca40f7fe49aae2deb5daf2213e4

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}
      - httpx
      - zstandard

    tests:
    - python:
        imports:
        - diracx.api
        pip_check: true

    about:
      summary: TODO
      license: GPL-3.0-only

  - package:
      name: diracx-cli
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-cli/diracx_cli-${{ version }}.tar.gz
      sha256: b79b828943805a1d16dc5f583dcdbb60f950f415d4071f5599428aa90738297f

    build:
      script: ${{ PYTHON }} -m pip install .
      python:
        entry_points:
        - dirac = diracx.cli:app
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diraccfg
      - diracx-api ==${{ version }}
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}
      - gitpython
      - pydantic >=2.10
      - pyyaml
      - rich
      - typer >=0.15.4

    tests:
    - python:
        imports:
        - diracx.cli
        pip_check: true
    - script:
      - dirac --help

    about:
      summary: TODO
      license: GPL-3.0-only

  - package:
      name: diracx-client
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-client/diracx_client-${{ version }}.tar.gz
      sha256: a12eb7967e9ac57ab957fb84516e0c0cc8bcd043853eac2f90b581ea42117429

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - azure-core
      - diracx-core ==${{ version }}
      - httpx
      - isodate
      - pyjwt

    tests:
    - python:
        imports:
        - diracx.client
        pip_check: true

    about:
      summary: TODO
      license: GPL-3.0-only

  - package:
      name: diracx-core
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-core/diracx_core-${{ version }}.tar.gz
      sha256: 9c6a2ddb80d3a2a00c920f305b201d4fbfa514d0a27da343bc54702eaf0721f5

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - aiobotocore >=2.15
      - botocore >=1.35
      - cachetools
      - diraccommon >=9.0.0
      - email-validator
      - gitpython
      - joserfc >=1.1.0
      - pydantic-settings
      - pydantic >=2.10
      - pyyaml
      - sh

    tests:
    - python:
        imports:
        - diracx.core
        pip_check: true

    about:
      summary: Common code used by all DiracX packages
      license: GPL-3.0-only

  - package:
      name: diracx-db
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-db/diracx_db-${{ version }}.tar.gz
      sha256: 9b94fe6d19b529368875b084c8337f455d5e7e277e66e619b6c18bcbdde11c96

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diracx-core ==${{ version }}
      - opensearch-py
      - aiohttp>=3.12.14,<4  # opensearch-py[async]
      - pydantic >=2.10
      - python-dateutil
      - sqlalchemy-with-aiomysql
      - sqlalchemy-with-aiosqlite
      - uuid-utils

    tests:
    - python:
        imports:
        - diracx.db
        pip_check: true

    about:
      summary: TODO
      license: GPL-3.0-only
  
  - package:
      name: diracx-logic
      version: ${{ version }}

    source:
    - url: https://pypi.org/packages/source/d/diracx-logic/diracx_logic-${{ version }}.tar.gz
      sha256: a6b6554b1cff3d8592bd5956fbf7cbc5c231c269c9f307ddf821ce9498903b38

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - cachetools
      - diraccommon >=9.0.0
      - diracx-core ==${{ version }}
      - diracx-db ==${{ version }}
      - joserfc
      - pydantic >=2.10
      - uuid-utils

    tests:
    - python:
        imports:
        - diracx.logic
        pip_check: true

    about:
      summary: TODO
      description: ''
      license: GPL-3.0-only

  - package:
      name: diracx-routers
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-routers/diracx_routers-${{ version }}.tar.gz
      sha256: ace7511056525dd18f049be5977c3341ecf68430318a0e2951261ad8dab33da9

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - cachetools
      - diracx-core ==${{ version }}
      - diracx-db ==${{ version }}
      - diracx-logic ==${{ version }}
      - fastapi
      - httpx
      - joserfc
      - opentelemetry-api
      - opentelemetry-exporter-otlp
      - opentelemetry-instrumentation-fastapi
      - opentelemetry-instrumentation-logging
      - opentelemetry-sdk
      - pydantic >=2.10
      - python-dotenv
      - python-multipart
      - uvicorn

    tests:
    - python:
        imports:
        - diracx.routers
        pip_check: true

    about:
      summary: TODO
      license: GPL-3.0-only

  - package:
      name: diracx-testing
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx-testing/diracx_testing-${{ version }}.tar.gz
      sha256: 75b77935b90b0ad604b9f6ab1947f8ca5f0ff4747bbb427d75f2237882c5af84

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diracx-core ==${{ version }}
      - httpx
      - joserfc
      - pytest
      - pytest-asyncio ==1.0.0
      - pytest-cov
      - pytest-github-actions-annotate-failures
      - pytest-xdist
      - uuid-utils

    tests:
    - python:
        imports:
        - diracx.testing
        pip_check: true

    about:
      summary: TODO
      license: GPL-3.0-only

  - package:
      name: diracx
      version: ${{ version }}

    source:
      url: https://pypi.org/packages/source/d/diracx/diracx-${{ version }}.tar.gz
      sha256: 7452c349fb47136a4bcdb23e7eabbd5bd3ed45345130349890ce30e0f56608d8

    build:
      script: ${{ PYTHON }} -m pip install .
      noarch: python

    requirements:
      host:
      - python >=3.11
      - hatchling
      - hatch-vcs
      - pip
      run:
      - python >=3.11
      - diracx-api ==${{ version }}
      - diracx-cli ==${{ version }}
      - diracx-client ==${{ version }}
      - diracx-core ==${{ version }}

    tests:
    - python:
        imports:
        - diracx
        - diracx.core
        - diracx.api
        - diracx.cli
        - diracx.client
        pip_check: true

    about:
      summary: Client installation for users of DiracX installations
      license: GPL-3.0-only

extra:
  recipe-maintainers:
    - chrisburr
