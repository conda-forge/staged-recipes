{% set name = "scifem" %}
{% set version = "0.2.5" %}
{% set fenics_version = "0.8" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://pypi.io/packages/source/s/scifem/scifem-{{ version }}.tar.gz
  sha256: 6e672c0dcddfb99fdf9a294498a9e11ff578fb1091b0e55fe12bb9134bf64804
  patches:
    # https://patch-diff.githubusercontent.com/raw/scientificcomputing/scifem/pull/42
    - 42.patch

build:
  number: 0
  skip: true  # [win or py<310]
requirements:
  build:
    - {{ compiler('c') }}
    - {{ stdlib("c") }}
    - {{ compiler('cxx') }}
    - cmake
    - make
    - pkg-config
    - {{ mpi }}  # [mpi == 'openmpi' and build_platform != target_platform]
    - cross-python_{{ target_platform }}  # [build_platform != target_platform]
    - python  # [build_platform != target_platform]
    - nanobind  # [build_platform != target_platform]
  host:
    - fenics-libbasix {{ fenics_version }}
    - fenics-basix {{ fenics_version }}
    - fenics-libdolfinx {{ fenics_version }}
    - fenics-dolfinx {{ fenics_version }}
    - {{ mpi }}
    - petsc
    - petsc * {{ scalar }}_*
    - pip
    - python
    - scikit-build-core
    - nanobind
  run:
    - python
    - fenics-basix
    - fenics-dolfinx
    - adios2 * mpi_{{ mpi }}_*
  run_constrained:
    # require mpi build of h5py
    - h5py * mpi_{{ mpi }}_*

test:
  source_files:
    - tests
  requires:
    - pip
    - pytest
    - petsc4py
    - h5py
  commands:
    - pytest -vs tests
    - MPIEXEC_TIMEOUT=300 mpiexec -n 2 pytest -m "not serial" tests
    - pip check

about:
  home: https://scientificcomputing.github.io/scifem
  summary: Scientific Computing Tools for Finite Element Methods
  description: |
    This package contains a collection of tools for scientific computing with a focus on finite element methods.
    The tools are written in Python and are intended to be used in conjunction with the dolfinx.
  license: MIT
  license_family: MIT
  license_file: LICENSE
  doc_url: https://scientificcomputing.github.io/scifem
  dev_url: https://github.com/scientificcomputing/scifem

extra:
  recipe-maintainers:
    - finsberg
    - jorgensd
    - minrk
