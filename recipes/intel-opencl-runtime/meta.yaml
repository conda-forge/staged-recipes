# use this if our build script changes and we need to increment beyond intel's version
{% set dst_build_number = '0' %}
{% set version = "2022.0.1" %}         # [linux]
{% set version = "2022.0.0" %}         # [win]
{% set tbb_version = "2021.0.0" %}
{% set intel_build_number = "3633" %}  # [linux]
{% set intel_build_number = "3663" %}  # [win]

package:
  name: intel-opencl-rt
  version: {{ version }}

source:
  - url: https://anaconda.org/intel/intel-opencl-rt/{{ version }}/download/{{ target_platform }}/intel-opencl-rt-{{ version }}-intel_{{ intel_build_number }}.tar.bz2
    sha256: 0d2c3b078cbf72db2354965b0a8054178bc02c225642979ffa3aafb027a4796d  # [linux]
    sha256: 7581afb3c1a478538f9dd89fe91e7a5eab00c0f78f5f29b24af0f6e64b614195  # [win]
    folder: intel-opencl-rt

build:
  number: {{ intel_build_number|int + dst_build_number|int }}
  binary_relocation: False
  detect_binary_files_with_prefix: False
  skip: True    # [osx or not x86]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - sysroot_linux-64 2.17  # [linux]
    - patchelf               # [linux]
  host:
    - tbb-devel {{ tbb_version.split('.')[0] }}.*
    - ocl-icd  # [linux]
    - khronos-opencl-icd-loader  # [osx or win]
    - zlib
    - libxml2

test:
  requires:
    - pyopencl
    - curl
  commands:
    - test -f $PREFIX/lib/intel-ocl-cpu/libintelocl.so          # [linux]
    - export OCL_ICD_DEBUG=7                                    # [linux]
    - curl -O https://raw.githubusercontent.com/inducer/pyopencl/master/examples/demo.py
    - export PYOPENCL_CTX=intel  # [unix]
    - set PYOPENCL_CTX=intel     # [win]
    - python demo.py

about:
  home: https://software.intel.com/content/www/us/en/develop/tools/opencl-cpu-runtime.html
  license: LicenseRef-ProprietaryIntel
  summary: 'Intel OpenCL runtime for CPUs'
  license_file:
    - intel-opencl-rt/info/licenses/license.txt
    - intel-opencl-rt/info/licenses/tpp.txt

extra:
  recipe-maintainers:
    - isuruf
    - napetrov
