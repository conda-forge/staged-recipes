# use this if our build script changes and we need to increment beyond intel's version
{% set dst_build_number = '0' %}
{% set version = "2021.3.0" %}
{% set intel_build_number = "3350" %}  # [linux]
{% set intel_build_number = "3372" %}  # [win]

package:
  name: intel-opencl-rt
  version: {{ version }}

source:
  - url: https://anaconda.org/intel/intel-opencl-rt/{{ version }}/download/{{ target_platform }}/intel-opencl-rt-{{ version }}-intel_{{ intel_build_number }}.tar.bz2
    sha256: 004237d96467c8d13eae62b8491537d0fd90366c194f03c7d8693b887f7c1482  # [linux]
    sha256: 8cd4da04878bdc9b9aa01fc75d738ae504b7231852430e90f00cb20a48c17217  # [win]
    folder: intel-opencl-runtime

build:
  number: {{ intel_build_number|int + dst_build_number|int }}
  binary_relocation: False
  detect_binary_files_with_prefix: False
  skip: True    # [osx or not x86]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - sysroot_linux-64 2.17  # [linux]
  host:
    - tbb-devel {{ version.split('.')[0] }}.*
    - ocl-icd  # [linux]
    - khronos-opencl-icd-loader  # [osx or win]
    - zlib
    - libxml2

test:
  requires:
    - pyopencl
    - curl
  commands:
    - test -f $PREFIX/lib/intel-ocl-cpu/libintelocl.so          # [linux]
    - export OCL_ICD_DEBUG=7                                    # [linux]
    - curl -O https://raw.githubusercontent.com/inducer/pyopencl/master/examples/demo.py
    - export PYOPENCL_CTX=intel  # [unix]
    - set PYOPENCL_CTX=intel     # [win]
    - python demo.py

about:
  home: https://software.intel.com/content/www/us/en/develop/tools/opencl-cpu-runtime.html
  license: LicenseRef-ProprietaryIntel
  summary: 'Intel OpenCL runtime for CPUs'
  license_file:
    - intel-opencl-runtime/info/licenses/license.txt
    - intel-opencl-runtime/info/licenses/tpp.txt

extra:
  recipe-maintainers:
    - isuruf
    - napetrov
