{% set name = "gau2grid" %}
{% set version = "2.0.2" %}
{% set sha256 = "4f840735d30c19f235795291bccda01cbd74a604f0ee6ad6e4bd91b8ca7ff7d3" %}

package:
    name: {{ name|lower }}
    version: {{ version }}

source:
    #url: https://github.com/dgasmith/{{ name }}/archive/v{{ version }}.tar.gz
    url: https://github.com/dgasmith/{{ name }}/archive/master.tar.gz
    #git_tag: v{{ version }}
    sha256: {{ sha256 }}

build:
    number: 0
    binary_relocation: true
    skip: true  # [py2k or (win and vc<14)]

requirements:
    build:
        - cmake >=3.0
        - {{ compiler('c') }}
        - ninja  # [win]
        - numpy
    host:
        - numpy
        - python
#        - pip  # [win]
#        - cython  # [win]
        - setuptools  # [win]
        - setuptools_scm  # [win]

outputs:
    - name: gau2grid
      build:
          run_exports:
              - {{ pin_subpackage('gau2grid', max_pin='x') }}
      requirements:
          build:
              - {{ compiler('c') }}
              - cmake >=3.0
              - ninja  # [win]

#              - pip  # [win]
#              - cython  # [win]
              - setuptools  # [win]
              - setuptools_scm  # [win]
              - numpy
          host:
              - numpy
              - python
      files:
          - include/gau2grid
          - lib/libgg*  # [unix]
          - lib/gg*     # [win]
          - share/cmake/gau2grid

#Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/include/gau2grid/gau2grid.h
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/include/gau2grid/gau2grid_pragma.h
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/share/cmake/gau2grid/gau2gridConfig.cmake
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/share/cmake/gau2grid/gau2gridConfigVersion.cmake
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/share/cmake/gau2grid/gau2gridTargets.cmake
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/share/cmake/gau2grid/gau2gridTargets-release.cmake
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/codegen.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/c_generator.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/c_pragma.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/c_util_generator.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/c_wrapper.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/docs_generator.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/extras.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/order.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/python_reference.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/RSH.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/ref_basis.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/test_c_code.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/test_c_generator.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/test_helper.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/test_order.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/test_rsh.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/tests/__init__.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/utility.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/_version.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/__init__.py
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/__pycache__
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/gg.dll
#  -- Installing: C:/bld/gau2grid_1571859534166/_h_env/Library/lib/python3.7/site-packages/gau2grid/LICENSE
#Resource usage statistics from building gau2grid:
#   Process count: 7
#
#ob C:\bld\gau2grid_1571859534166\_h_env\include/gau2grid did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env
#ERROR:conda_build.utils:Glob C:\bld\gau2grid_1571859534166\_h_env\include/gau2grid did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env
#Glob C:\bld\gau2grid_1571859534166\_h_env\lib/gg* did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env
#ERROR:conda_build.utils:Glob C:\bld\gau2grid_1571859534166\_h_env\lib/gg* did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env
#
#Glob C:\bld\gau2grid_1571859534166\_h_env\lib/python3.7/site-packages/gau2grid did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env
#ERROR:conda_build.utils:Glob C:\bld\gau2grid_1571859534166\_h_env\lib/python3.7/site-packages/gau2grid did not match in root_dir C:\bld\gau2grid_1571859534166\_h_env

      test:
          commands:
              # Verify library
              - test -L $PREFIX/lib/libgg$SHLIB_EXT
              # Inspect linkage
              - ldd -v $PREFIX/lib/libgg$SHLIB_EXT                 # [linux]
              - otool -L $PREFIX/lib/libgg$SHLIB_EXT               # [osx]
              - conda inspect linkages --show-files --groupby=dependency gau2grid
              - conda inspect objects -p $PREFIX $PKG_NAME         # [osx]
      about:
          home: https://github.com/dgasmith/gau2grid
          dev_url: https://github.com/dgasmith/gau2grid
          doc_url: https://github.com/dgasmith/gau2grid/blob/master/README.md
          doc_source_url: https://github.com/dgasmith/gau2grid/blob/master/docs/source/index.rst
          license: BSD-3-Clause
          license_url: https://opensource.org/licenses/BSD-3-Clause
          license_file: LICENSE
          license_family: BSD
          summary: "D.G.A. Smith's C library for fast computation of a Gaussian and its derivative on a grid"
          description: >
            A collocation code for computing gaussians on a grid of the form:
            ```
            out_Lp = x^l y^m z^n \sum_i coeff_i e^(exponent_i * (|center - p|)^2)
            ```
            , where the returned matrix dimension are the angular momentum (L) by number of requested points (p).

    - name: pygau2grid
      build:
          ignore_run_exports:
              # these needed as tools to build and interpreter/library to run, but version generic in both cases
              - numpy
              - python
#w          ignore_run_exports:
#w              - numpy
      requirements:
          build:
              - {{ compiler('c') }}
              - cmake >=3.0
              - ninja  # [win]
              - numpy
          host:
#w              - numpy
              - numpy #appveyor wants
              - python
#              - pip  # [win]
#              - cython  # [win]
              - setuptools  # [win]
              - setuptools_scm  # [win]
          run:
#w              - numpy
              - numpy
#              - {{ pin_compatible('python', max_pin='x.x') }}
              - python
      files:
          - lib/python{{ PY_VER }}/site-packages/gau2grid
      test:
          requires:
              - pytest
          commands:
              - export PYLIB_EXT=`$PYTHON -c 'from numpy import distutils; print(distutils.misc_util.get_shared_lib_extension(is_python_ext=False))'`  # [unix]
              - set PYLIB_EXT=`$PYTHON -c 'from numpy import distutils; print(distutils.misc_util.get_shared_lib_extension(is_python_ext=False))'`  # [win]
              # Verify library
              - test -f $SP_DIR/gau2grid/gg$PYLIB_EXT
              # Inspect linkage
              - ldd -v $SP_DIR/gau2grid/gg$PYLIB_EXT  # [linux]
              - otool -L $SP_DIR/gau2grid/gg$PYLIB_EXT  # [osx]
              - conda inspect linkages --show-files --groupby=dependency pygau2grid
              - conda inspect objects -p $PREFIX $PKG_NAME           # [osx]
              # Actually test
              - export GAU2GRID_FORCE_C_TEST=1  # [unix]
              - set GAU2GRID_FORCE_C_TEST=1  # [win]
              - ls -l $SP_DIR/gau2grid  # [unix]
              - dir $SP_DIR/gau2grid  # [win]
              - python -c "import gau2grid as gg; print(f'*** gau2grid {gg.__file__} {gg.__version__} built successfully, hooray')"
              - python -c "import sys; import gau2grid as gg; sys.exit(gg.test())"
      about:
          home: https://github.com/dgasmith/gau2grid
          dev_url: https://github.com/dgasmith/gau2grid
          doc_url: https://github.com/dgasmith/gau2grid/blob/master/README.md
          doc_source_url: https://github.com/dgasmith/gau2grid/blob/master/docs/source/index.rst
          license: BSD-3-Clause
          license_url: https://opensource.org/licenses/BSD-3-Clause
          license_file: LICENSE
          license_family: BSD
          summary: "D.G.A. Smith's C-based python module for fast computation of a Gaussian and its derivative on a grid"
          description: >
            A collocation code for computing gaussians on a grid of the form:
            ```
            out_Lp = x^l y^m z^n \sum_i coeff_i e^(exponent_i * (|center - p|)^2)
            ```
            , where the returned matrix dimension are the angular momentum (L) by number of requested points (p).

about:
  home: https://github.com/dgasmith/gau2grid
  license: BSD-3-Clause
  license_file: LICENSE
  summary: "D.G.A. Smith's C library for fast computation of a Gaussian and its derivative on a grid"

extra:
  recipe-maintainers:
    - dgasmith
    - loriab
