{% set name = "topaz" %}
{% set version = "0.3.13" %}  # Update to latest release if needed
{% set sha256 = "108912a6b60c909fe443a92ae80ceb69c4d0f2f1cecc78097cd4c11417cd41ef" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://github.com/tbepler/topaz/archive/refs/tags/v{{ version }}.tar.gz
  sha256:  {{ sha256 }}

build:
  noarch: python
  script: python -m pip install . --no-deps --ignore-installed -vv

requirements:
  host:
    - python>=3.8,<=3.13
    - pip
    - setuptools
    - wheel
  run:
    - python >=3.8,<=3.13
    - future
    - pytorch >=1.0  # CPU or CUDA variant selected by solver on conda-forge
    - torchvision
    - numpy >=1.11
    - tqdm >=4.65.0
    - scipy >=0.17.0
    - pandas >=0.20.3
    - h5py >=3.7.0
    - pillow >=6.2.0
    - scikit-learn >=0.19.0
  run_constrained:
    # Prefer CUDA-enabled PyTorch when a CUDA runtime is present in the env.
    # This mirrors patterns used across conda-forge GPU-enabled packages.
    - cuda-version >=11.8  # [linux]

test:
  imports:
    - topaz
  commands:
    - topaz --help

about:
  home: https://github.com/tbepler/topaz
  license: GPL-3.0
  license_file: LICENSE
  summary: "Deep learning-based particle picker for cryo-EM."


outputs:
  - name: {{ name }}
    version: {{ version }}
    build:
      noarch: python
      script: python -m pip install . --no-deps --ignore-installed -vv
    requirements:
      host:
        - python>=3.8,<=3.13
        - pip
        - setuptools
        - wheel
      run:
        - python >=3.8,<=3.13
        - future
        - pytorch >=2.0
        - torchvision
        - numpy >=1.11
        - tqdm >=4.65.0
        - scipy >=0.17.0
        - pandas >=0.20.3
        - h5py >=3.7.0
        - pillow >=6.2.0
        - scikit-learn >=0.19.0
      run_constrained:
        # Prefer CUDA-enabled PyTorch when a CUDA runtime is present in the env.
        # This mirrors patterns used across conda-forge GPU-enabled packages.
        - cuda-version >=11.8  # [linux]
    test:
      imports:
        - topaz
      commands:
        - topaz --help
    about:
      home: https://github.com/tbepler/topaz
      license: GPL-3.0
      license_file: LICENSE
      summary: "Deep learning-based particle picker for cryo-EM."
    extra:
      recipe-maintainers:
        - PertuyF

  - name: {{ name }}-gpu
    version: {{ version }}
    build:
      noarch: generic
    requirements:
      run:
        - {{ name }} =={{ version }}
        - cudatoolkit >=11.0
    test:
      commands:
        - topaz --help
    about:
      home: https://github.com/tbepler/topaz
      license: GPL-3.0
      license_file: LICENSE
      summary: "Metapackage for topaz with CUDA runtime."
    extra:
      recipe-maintainers:
        - PertuyF
