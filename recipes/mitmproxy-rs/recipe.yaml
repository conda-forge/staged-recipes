context:
  version: 0.12.7

recipe:
  name: mitmproxy-rs
  version: ${{ version }}

source:
  - url: https://github.com/mitmproxy/mitmproxy_rs/archive/refs/tags/v${{ version }}.tar.gz
    sha256: aadc49063b9ea1bfa5dad7ea707971de9be1ba42d578f54e5113ca495e47a955

build:
  number: 0

outputs:
  - package:
      name: mitmproxy-linux
    build:
      skip:
        - not linux
        - match(python, "<3.12")
      script:
        - mkdir -p ./custom-build-tools
        - cp "${RECIPE_DIR}/cargo" ./custom-build-tools/cargo
        - export PATH="$(pwd)/custom-build-tools:${PATH}"
        - export CARGO_BUILD_RUSTFLAGS=""
        - export LDFLAGS=""
        - env
        - ${{ PYTHON }} -m pip install ./mitmproxy-linux
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
        - ${{ compiler('c') }}
        - ${{ stdlib('c') }}
        - ${{ compiler('rust') }}
        - rust-src
        - if: build_platform != target_platform
          then:
            - maturin >=1.10.1,<2
        - cargo-bundle-licenses
        - bpf-linker
      host:
        - python
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
        - python
    tests:
      - python:
          imports:
            - mitmproxy_linux
          pip_check: true
  - package:
      name: mitmproxy-macos
    build:
      skip:
        - not osx
        - match(python, "<3.12")
      script:
        file: build_mitmproxy_macos
    requirements:
      build:
        - ${{ stdlib('c') }}
        - ${{ compiler('rust') }}
        - if: build_platform != target_platform
          then:
            - maturin >=1.10.1,<2
        - cargo-auditable
        - cargo-bundle-licenses
      host:
        - python
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
        - python
    tests:
      - python:
          imports:
            - mitmproxy_macos
          pip_check: true
      - package_contents:
          site_packages:
            - "mitmproxy_macos/Mitmproxy Redirector.app.tar"
            - mitmproxy_macos/macos-certificate-truster.app/*
  - package:
      name: mitmproxy-windows
    build:
      skip:
        - not win
        - match(python, "<3.12")
      script:
        - cargo auditable build --release --package windows-redirector
        - ${{ PYTHON }} -m pip install ./mitmproxy-windows
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
        - ${{ stdlib('c') }}
        - ${{ compiler('rust') }}
        - if: build_platform != target_platform
          then:
            - maturin >=1.10.1,<2
        - cargo-auditable
        - cargo-bundle-licenses
      host:
        - python
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
        - python
    tests:
      - python:
          imports:
            - mitmproxy_windows
          pip_check: true
  - package:
      name: mitmproxy-rs
    build:
      skip: match(python, "<3.12")
      script:
        - if: linux
          then:
            # fix: enable BSD extensions to provide le16toh/be16toh
            # required by tree-sitter 0.25.6
            # https://github.com/tree-sitter/tree-sitter/issues/4271
            - export CFLAGS="$CFLAGS -D_BSD_SOURCE"
        - ${{ PYTHON }} -m pip install ./mitmproxy-rs
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
        - ${{ compiler('c') }}
        - ${{ stdlib('c') }}
        - ${{ compiler('rust') }}
        - if: build_platform != target_platform
          then:
            - maturin >=1.10.1,<2
        - cargo-bundle-licenses
      host:
        - python
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
        - python
        - if: win
          then:
            - ${{ pin_subpackage('mitmproxy-windows', exact=True) }}
        - if: linux
          then:
            - ${{ pin_subpackage('mitmproxy-linux', exact=True) }}
        - if: osx
          then:
            - ${{ pin_subpackage('mitmproxy-macos', exact=True) }}

    tests:
      - python:
          imports:
            - mitmproxy_rs
          pip_check: true

about:
  summary: This package contains mitmproxy's Rust bits.
  description: |+
    # mitmproxy_rs

    This package contains mitmproxy's Rust bits.

    [![dev documentation](https://shields.mitmproxy.org/badge/docs-Python%20API-blue.svg)](https://mitmproxy.github.io/mitmproxy_rs/)

    https://github.com/mitmproxy/mitmproxy_rs

  license: MIT
  homepage: https://github.com/mitmproxy/mitmproxy_rs
  repository: https://github.com/mitmproxy/mitmproxy-rs
  license_file:
    - LICENSE
    - THIRDPARTY.yml

extra:
  feedstock-name: mitmproxy-rs
  recipe-maintainers:
    - moritzwilksch
    - ytausch
