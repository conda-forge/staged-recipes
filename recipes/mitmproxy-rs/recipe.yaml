context:
  version: 0.12.7

recipe:
  name: mitmproxy-rs
  version: ${{ version }}

source:
  - url: https://github.com/mitmproxy/mitmproxy_rs/archive/refs/tags/v${{ version }}.tar.gz
    sha256: aadc49063b9ea1bfa5dad7ea707971de9be1ba42d578f54e5113ca495e47a955

outputs:
  - package:
      name: mitmproxy-linux
    build:
      skip: not linux
      script:
        - mkdir -p ./custom-build-tools
        - cp "${RECIPE_DIR}/cargo" ./custom-build-tools/cargo
        - export PATH="$(pwd)/custom-build-tools:${PATH}"
        - export CARGO_BUILD_RUSTFLAGS=""
        - export LDFLAGS=""
        - env
        - ${{ PYTHON }} -m pip install ./mitmproxy-linux
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
      - ${{ compiler('c') }}
      - ${{ stdlib('c') }}
      - ${{ compiler('rust') }}
      - rust-src
      - if: build_platform != target_platform
        then:
          - maturin >=1.10.1,<2
      - cargo-bundle-licenses
      - bpf-linker
      host:
        - python >=3.12
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
      - python >=3.12
  - package:
      name: mitmproxy-macos
    build:
      skip: not osx
      script:
        - if: target_platform == "osx-64"
          then:
            - export CARGO_BUILD_TARGET=x86_64-apple-darwin
        - if: target_platform == "osx-arm64"
          then:
            - export CARGO_BUILD_TARGET=aarch64-apple-darwin
        - cargo auditable build --release --package macos-certificate-truster --target "$CARGO_BUILD_TARGET"
        - lipo -create -output target/release/macos-certificate-truster "target/$CARGO_BUILD_TARGET/release/macos-certificate-truster"
        - |
          (
            export LD="${CC_FOR_BUILD}" && \
            cd mitmproxy-macos/redirector && \
            mkdir build && mkdir dist && \
            # 1. Create an unsigned .xcarchive
            xcodebuild \
              -scheme macos-redirector \
              -archivePath build/macos-redirector.xcarchive \
              CODE_SIGNING_ALLOWED=NO \
              CODE_SIGN_IDENTITY="" \
              archive && \
            # 2. Copy the .app out of the .xcarchive (the .xcarchive is just a folder)
            cp -R \
              build/macos-redirector.xcarchive/Products/Applications/"Mitmproxy Redirector.app" \
              build/"Mitmproxy Redirector.app" && \
            # 3. Create the .app.tar bundle in dist
            tar --create \
              --file "dist/Mitmproxy Redirector.app.tar" \
              --cd build \
              "Mitmproxy Redirector.app"
            rm -rf build
          )
        - ${{ PYTHON }} -m pip install ./mitmproxy-macos
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
      - ${{ stdlib('c') }}
      - ${{ compiler('rust') }}
      - if: build_platform != target_platform
        then:
          - maturin >=1.10.1,<2
      - cargo-auditable
      - cargo-bundle-licenses
      host:
        - python >=3.12
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
      - python >=3.12
  - package:
      name: mitmproxy-windows
    build:
      skip: not win
      script:
        - cargo auditable build --release --package windows-redirector
        - ${{ PYTHON }} -m pip install ./mitmproxy-windows
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
      - ${{ stdlib('c') }}
      - ${{ compiler('rust') }}
      - if: build_platform != target_platform
        then:
          - maturin >=1.10.1,<2
      - cargo-auditable
      - cargo-bundle-licenses
      host:
        - python >=3.12
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
      - python >=3.12
  - package:
      name: mitmproxy-rs
    build:
      script:
        - if: linux
          then:
            # fix: enable BSD extensions to provide le16toh/be16toh
            # required by tree-sitter 0.25.6
            # https://github.com/tree-sitter/tree-sitter/issues/4271
            - export CFLAGS="$CFLAGS -D_BSD_SOURCE"
        - ${{ PYTHON }} -m pip install ./mitmproxy-rs
        - cargo-bundle-licenses --format yaml --output ./THIRDPARTY.yml
    requirements:
      build:
      - ${{ compiler('c') }}
      - ${{ stdlib('c') }}
      - ${{ compiler('rust') }}
      - if: build_platform != target_platform
        then:
          - maturin >=1.10.1,<2
      - cargo-bundle-licenses
      host:
        - python >=3.12
        - hatchling
        - pip
        - maturin >=1.10.1,<2
      run:
        - python >=3.12
        - if: win
          then:
            - ${{ pin_subpackage('mitmproxy-windows', exact=True) }}
        - if: linux
          then:
            - ${{ pin_subpackage('mitmproxy-linux', exact=True) }}
        - if: osx
          then:
            - ${{ pin_subpackage('mitmproxy-macos', exact=True) }}

    tests:
    - python:
        imports:
        - mitmproxy_rs
        pip_check: true

about:
  description: |+
    # mitmproxy_rs

    This package contains mitmproxy's Rust bits.

    [![dev documentation](https://shields.mitmproxy.org/badge/docs-Python%20API-blue.svg)](https://mitmproxy.github.io/mitmproxy_rs/)

    https://github.com/mitmproxy/mitmproxy_rs

  license: MIT
  repository: https://github.com/mitmproxy/mitmproxy-rs
  license_file:
    - LICENSE
    - THIRDPARTY.yml

extra:
  feedstock-name: mitmproxy-rs
  recipe-maintainers:
    - moritzwilksch
    - ytausch
