{% set name = "gym-ignition-split" %}
{% set version = "1.3.0.post0" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  # url: https://github.com/robotology/gym-ignition/archive/refs/tags/v{{ version }}.tar.gz
  # sha256: 6ae47711b0941f47030c1e9b7821d1259aa7e622d07914a261f1470d41d1524c
  git_url: https://github.com/robotology/gym-ignition.git
  git_rev: feature/conda-forge

build:
  number: 1

outputs:

  - name: libscenario
    script: build_libscenario.sh  # [unix]
    script: build_libscenario.bat  # [win]
    build:
      skip: true  # [win or osx]
      # Note: run_exports does not work in the subpackages of the same recipe
      #       https://github.com/conda/conda-build/issues/3478
      run_exports:
        - {{ pin_subpackage("libscenario", max_pin="x.x") }}
    requirements:
      build:
        - cmake
        - ninja
        - pkg-config
        - clang  # [win]
        - vs2019_win-32  # [win32]
        - vs2019_win-64  # [win64]
        - {{ compiler("c") }}
        - {{ compiler("cxx") }}
        - {{ cdt("mesa-libgl-devel") }}  # [linux]
        - sed  # [unix]
        - m2-sed  # [win]
        - diffutils  # [unix]
        - m2-diffutils  # [win]
      host:
        - eigen
        - idyntree
        - libignition-gazebo6
      run:
        - __osx >={{ MACOSX_DEPLOYMENT_TARGET|default("10.9") }}  # [osx and x86_64]
        # Require idyntree x.x since idyntree-feedstock just requires x
        - {{ pin_compatible('idyntree', max_pin="x.x") }}
        # These should be exported by libignition-gazebo6
        - {{ pin_compatible('libignition-common4') }}
        - {{ pin_compatible('libignition-fuel-tools7') }}
        - {{ pin_compatible('libignition-math6') }}
        - {{ pin_compatible('libignition-msgs8') }}
        - {{ pin_compatible('libignition-physics5') }}
        - {{ pin_compatible('libignition-plugin1') }}
        - {{ pin_compatible('libignition-transport11') }}
        - {{ pin_compatible('libsdformat12') }}
        # Not sure why conda render just pins x instead of x.x like libprotobuf-feedstock.
        # Maybe because there's no explicit protobuf in host.
        - {{ pin_compatible('libprotobuf', max_pin="x.x") }}
    test:
      commands:
        # Inspect activate scripts
        - env | grep IGN_GAZEBO_SYSTEM_PLUGIN_PATH  # [unix]
        - set IGN_GAZEBO_SYSTEM_PLUGIN_PATH  # [win]
        # Check existence of ScenarIO Gazebo library
        - test -f ${PREFIX}/lib/libGazeboSimulator.so  # [linux]
        - test -f ${PREFIX}/lib/libGazeboSimulator.dylib  # [osx]
        - if not exist %PREFIX%\\Library\\lib\\GazeboSimulator.lib exit 1  # [win]
        # Check existence of ScenarIO and ScenarIO Gazebo CMake targets
        - test -f ${PREFIX}/lib/cmake/Scenario/ScenarioConfig.cmake  # [unix]
        - test -f ${PREFIX}/lib/cmake/ScenarioGazebo/ScenarioGazeboConfig.cmake  # [unix]
        - if not exist %PREFIX%\\Library\\lib\\cmake\\Scenario\\ScenarioConfig.cmake exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\cmake\\ScenarioGazebo\\ScenarioGazeboConfig.cmake exit 1  # [win]

  - name: scenariopy
    script: build_scenariopy.sh  # [unix]
    script: build_scenariopy.bat  # [win]
    build:
      skip: true  # [win or osx or py<38]
    requirements:
      build:
        - clang  # [win]
        - vs2019_win-32  # [win32]
        - vs2019_win-64  # [win64]
        - cmake
        - {{ compiler("c") }}
        - {{ compiler("cxx") }}
        - ninja
        - pkg-config
        - swig
        - sed  # [unix]
        - m2-sed  # [win]
        - diffutils  # [unix]
        - m2-diffutils  # [win]
        # https://conda-forge.org/docs/maintainer/knowledge_base.html#libgl
        # Should these be handled by the Ignition Gazebo recipe? 
        # Without them, CMake fails with: Failed to find "GL/gl.h".
        - {{ cdt('mesa-libgl-devel') }}  # [linux]
        - {{ cdt('mesa-dri-drivers') }}  # [linux]
        - {{ cdt('libselinux') }}  # [linux]
        - {{ cdt('libxdamage') }}  # [linux]
        - {{ cdt('libxxf86vm') }}  # [linux]
        - {{ cdt('libxext') }}     # [linux]
      host:
        - build
        - cmake-build-extension
        - idyntree
        - libignition-gazebo6
        - pip
        - python
        # https://conda-forge.org/docs/maintainer/knowledge_base.html#libgl
        - xorg-libxfixes  # [linux]
        # Here just to make DSO happy, it is a run-only requirement
        - {{ pin_subpackage("libscenario", exact=True) }}
      run:
        # Require idyntree x.x since idyntree-feedstock just requires x
        - {{ pin_compatible('idyntree', max_pin="x.x") }}
        # Manually specify the run_exports of libscenario since they are not
        # applied to subpackages of the same recipe
        # https://github.com/conda/conda-build/issues/3478
        # Here we also need to pin an exact version and not just a compatible one
        - {{ pin_subpackage("libscenario", exact=True) }}
        - packaging
        - python
    test:
      imports:
        - scenario
      commands:
        - pip check
        - test $(pip list | grep scenario | tr -s " " | grep $PKG_VERSION | wc -l) -eq 1  # [unix]
      requires:
        - pip

  - name: scenario
    script: build_scenario.sh  # [unix]
    script: build_scenario.bat  # [win]
    build:
      skip: true  # [win or osx or py<38]
    requirements:
      run:
        - {{ pin_subpackage("libscenario", exact=True) }}
        - {{ pin_subpackage("scenariopy", exact=True) }}
    test:
      imports:
        - scenario
      commands:
        - pip check
        # Inspect activate scripts
        - env | grep IGN_GAZEBO_SYSTEM_PLUGIN_PATH  # [unix]
        - set IGN_GAZEBO_SYSTEM_PLUGIN_PATH # [win]
        # Check existence of ScenarIO Gazebo library
        - test -f ${PREFIX}/lib/libGazeboSimulator.so  # [linux]
        - test -f ${PREFIX}/lib/libGazeboSimulator.dylib  # [osx]
        - if not exist %PREFIX%\\Library\\lib\\GazeboSimulator.lib exit 1  # [win]
        # Check existence of ScenarIO and ScenarIO Gazebo CMake targets
        - test -f ${PREFIX}/lib/cmake/Scenario/ScenarioConfig.cmake  # [unix]
        - test -f ${PREFIX}/lib/cmake/ScenarioGazebo/ScenarioGazeboConfig.cmake  # [unix]
        - if not exist %PREFIX%\\Library\\lib\\cmake\\Scenario\\ScenarioConfig.cmake exit 1  # [win]
        - if not exist %PREFIX%\\Library\\lib\\cmake\\ScenarioGazebo\\ScenarioGazeboConfig.cmake exit 1  # [win]
      requires:
        - pip

  - name: gym-ignition
    script: build_gym_ignition.sh  # [unix]
    script: build_gym_ignition.bat  # [win]
    build:
      skip: true  # [win or osx or py<38]
      noarch: python
    requirements:
      build:
        - sed  # [unix]
        - m2-sed  # [win]
        - diffutils  # [unix]
        - m2-diffutils  # [win]
      host:
        - pip
        - python
      run:
        - gym
        - gym-ignition-models
        - idyntree
        - lxml
        - numpy
        - python
        - {{ pin_subpackage("scenariopy", max_pin="x.x") }}
        - scipy
    test:
      source_files:
        - tests
        - setup.cfg
      imports:
        - gym_ignition
      commands:
        # - pip check (requires https://github.com/conda-forge/idyntree-feedstock/pull/8)
        - test $(pip list | grep gym-ignition | tr -s " " | grep $PKG_VERSION | wc -l) -eq 1  # [unix]
        - sed -i "s|def test_angular_acceleration|def _test_angular_acceleration|g" tests/test_scenario/test_link_velocities.py
        - pytest  # [linux]
      requires:
        - pip
        - pytest
        - pytest-icdiff
        - sed  # [unix]
        - m2-sed  # [win]

about:
  home: https://github.com/robotology/gym-ignition
  summary: A toolkit for developing OpenAI Gym environments simulated with Ignition Gazebo.
  dev_url: https://github.com/robotology/gym-ignition
  license: LGPL-2.1-or-later
  license_file: LICENSE

extra:
  recipe-maintainers:
    - diegoferigo
