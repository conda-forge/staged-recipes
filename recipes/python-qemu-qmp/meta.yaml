{% set name = "python-qemu-qmp" %}
{% set version = "0.0.3" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://gitlab.com/qemu-project/python-qemu-qmp/-/archive/v{{ version }}/python-qemu-qmp-v{{ version }}.tar.gz
  sha256: a83de098aa003842b081ca82698af6ed0a5dbd6ee9ebb51c20988f5c4e9b56c2
  patches:
    - update-setup.cfg-version.patch

build:
  noarch: python  # [not win]
  script:
    # Verify that setup.cfg version matches meta.yaml version
    - grep -q "version = {{ version }}" ${SRC_DIR}/setup.cfg || (echo "Version mismatch" && exit 1)  # [unix]
    - findstr /C:"version = {{ version }}" %SRC_DIR%\setup.cfg >nul || (echo Version mismatch && exit /b 1)  # [win]
    - {{ PYTHON }} -m pip install . -vv
  number: 0
  entry_points:
    - qemu-shell = qemu.qmp.qmp_shell:main
    - qemu-shell-wrap = qemu.qmp.qmp_shell:main_wrap
    # This requires missing conda package urwind
    # - qemu-tui = qemu.qmp.qmp_tui:main

requirements:
  host:
    - python >3.6
    - pip
    - setuptools
    # Upstream mentions version set by setuptools_scm, but requires using a custom packaging script
    # - setuptools_scm
  run:
    - pygments
    - python >3.6

test:
  imports:
    - qemu.qmp
  requires:
    - pyreadline  # [win]
    - pip
  commands:
    - pip check
    - qemu-shell --help
    - qemu-shell-wrap --help
    # This requires missing conda package urwind
    # - qemu-tui --help

about:
  home: https://gitlab.com/qemu-project/python-qemu-qmp
  summary: 'qemu.qmp: QEMU Monitor Protocol Library'
  description: |
    qemu.qmp is a QEMU Monitor Protocol (“QMP”) library written in Python, using asyncio. It is used to send
    QMP messages to running QEMU emulators. It requires Python 3.7+ and has no mandatory dependencies.
    This library can be used to communicate with QEMU emulators, the QEMU Guest Agent (QGA),
    the QEMU Storage Daemon (QSD), or any other utility or application that speaks QMP.
  license: GPL-2.0-only
  license_file:
    - LICENSE
    - LICENSE_GPL2

extra:
  recipe-maintainers:
    - MementoRC
