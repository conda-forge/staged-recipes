{% set name = "libsecp256k1" %}
{% set version = "0.3.2" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/bitcoin-core/secp256k1/archive/refs/tags/v{{ version }}.tar.gz
  sha256: ef2e1061951b8cf94a7597b4e60fd7810613e327e25305e8d73dfdff67d12190

build:
  number: 0
  missing_dso_whitelist:
    - /lib64/libc.so.6

requirements:
  build:
    - make
    - cmake
    - {{ compiler('c') }}

test:
  commands:
    - test -f ${PREFIX}/lib/libsecp256k1.so.2.0.2  # [linux]
    - test -f ${PREFIX}/lib/libsecp256k1.so.2  # [linux]
    - test -f ${PREFIX}/lib/libsecp256k1.so  # [linux]
    - test -f ${PREFIX}/lib/libsecp256k1.dylib  # [osx]
    - test -f ${PREFIX}/include/secp256k1.h  # [not win]
    - test -f ${PREFIX}/include/secp256k1_preallocated.h  # [not win]
    - test -f ${PREFIX}/include/secp256k1_ecdh.h  # [not win]
    - test -f ${PREFIX}/include/secp256k1_extrakeys.h  # [not win]
    - test -f ${PREFIX}/include/secp256k1_schnorrsig.h  # [not win]
    - test -f ${LIBRARY_PREFIX}/lib/libsecp256k1.lib  # [win]
    - test -f ${LIBRARY_PREFIX}/bin/libsecp256k1-2.dll  # [win]
    - test -f ${LIBRARY_PREFIX}/include/secp256k1.h  # [win]

outputs:
  - name: libsecp256k1
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1", exact=True) }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=OFF \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=OFF \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=OFF \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=OFF"

  - name: libsecp256k1-with-extrakeys
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1-with-extrakeys", max_pin="x.x") }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=OFF \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=OFF \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=ON \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=OFF"

  - name: libsecp256k1-with-schnorr
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1-with-schnorr", max_pin="x.x") }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=OFF \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=OFF \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=OFF \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=ON"

  - name: libsecp256k1-with-ecdh
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1-with-ecdh", max_pin="x.x") }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=ON \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=OFF \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=OFF \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=OFF"

  - name: libsecp256k1-with-ecdh-recovery
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1-with-ecdh-recovery", max_pin="x.x") }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=ON \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=ON \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=OFF \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=OFF"

  - name: libsecp256k1-with-all
    build:
      run_exports:
        - {{ pin_subpackage("libsecp256k1-with-all", max_pin="x.x") }}
      script_env:
        SECP256K1_OPTIONS="-DSECP256K1_ENABLE_MODULE_ECDH=ON \
                           -DSECP256K1_ENABLE_MODULE_RECOVERY=ON \
                           -DSECP256K1_ENABLE_MODULE_EXTRAKEYS=ON \
                           -DSECP256K1_ENABLE_MODULE_EXPERIMENTAL=ON \
                           -DSECP256K1_ENABLE_MODULE_SCHNORRSIG=ON"

about:
  home: https://github.com/bitcoin-core/secp256k1
  summary: 'Optimized C library for ECDSA signatures and secret/public key operations on curve secp256k1.'
  description: |
    This library is intended to be the highest quality publicly available 
    library for cryptography on the secp256k1 curve. However, the primary 
    focus of its development has been for usage in the Bitcoin system and 
    usage unlike Bitcoin's may be less well tested, verified, or suffer 
    from a less well thought out interface. Correct usage requires some 
    care and consideration that the library is fit for your application's purpose.
  license: MIT
  license_file: LICENSE.txt

extra:
  recipe-maintainers:
    - https://github.com/MementoRC
