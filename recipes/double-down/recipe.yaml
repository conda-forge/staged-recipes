schema_version: 1

context:
  version: "1.1.0"

package:
  name: double-down
  version: ${{ version }}

source:
  url: https://github.com/pshriwise/double-down/archive/v${{ version }}.tar.gz
  sha256: 427e5e4ba59c53bddb1991cb34d86a52c11162175bfc6f802abccb5745cea3ba
  target_directory: source
  # c.f. https://github.com/pshriwise/double-down/pull/51
  patches:
    - cmake-policy-max.patch

build:
  number: 0
  skip: win
  script:
    - cmake ${CMAKE_ARGS} -DCMAKE_INSTALL_PREFIX=$PREFIX -S source -B build
    - cmake -LH build
    - cmake --build build --parallel="${CPU_COUNT}"
    - if: build_platform == target_platform
      then: ctest --test-dir build --output-on-failure
    - cmake --install build

requirements:
  build:
    - ${{ stdlib("c") }}
    - ${{ compiler("cxx") }}
    - cmake
    - make
  host:
    - eigen
    - moab
    - embree
  run:
    - eigen
    - moab
    - embree
  run_exports:
    - ${{ pin_subpackage('double-down', upper_bound='x.x') }}

tests:
  - package_contents:
      strict: true
      files:
        - lib/cmake/dd/ddTargets.cmake
        - lib/cmake/dd/ddTargets-release.cmake
        - lib/cmake/dd/ddConfig.cmake
        - lib/cmake/dd/ddConfigVersion.cmake
        - tools/ray_fire
        - tools/closest_to_location
      include:
        - double_down/RTI.hpp
        - double_down/primitives.hpp
        - double_down/ray.h
        - double_down/MOABRay.h
        - double_down/MOABDirectAccess.h
        - double_down/Vec3da.h
        - double_down/constants.h
        - double_down/sys.h
        - double_down/Vec3fa.h
        - double_down/Vec3ba.h
        - double_down/Vec3.h
        - double_down/embree3.hpp
        - double_down/embree4.hpp
        - double_down/embree_interface.hpp
        - double_down/version.h
      lib:
        - dd

about:
  summary: "double-down: A double precision interface to Embree"
  description: |
    double-down is a double precision interface to Embree via the Mesh Oriented
    dAtaBase (MOAB).

    Geometric primitives (triangle elements) with double precision vertices are
    stored in MOAB.
    Custom primitive types are defined in Embree as user-defined geometry
    primitives.
    These primitives interface with the MOAB instance to provide robust bounding
    boxes and double precision intersection methods for rays.

    Ray values come in and out of the interface in double precision, making
    them useful for scientific purposes while maintaining the performance
    provided by the dedicated Intel developer team behind Embree.
  license: MIT
  license_file: source/LICENSE
  homepage: https://github.com/pshriwise/double-down
  repository: https://github.com/pshriwise/double-down
  documentation: https://double-down.readthedocs.io/

extra:
  recipe-maintainers:
    - pshriwise
