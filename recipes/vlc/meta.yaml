# Their website is wrong and points to 3.0.20 which is too old
{% set version = "3.0.21" %}

package:
  name: libvlc
  version: {{ version }}

source:
  # For version 3.0.21, there seems to be a fixup release
  # -1 is for a fixing build issues on windows
  # see release notes
  url: https://download.videolan.org/pub/videolan/vlc/{{ version }}/vlc-{{ version }}.tar.xz
  sha256: 24dbbe1d7dfaeea0994d5def0bbde200177347136dbfe573f5b6a4cee25afbb0
  patches:
  {% if version.startswith("4") %}
    - patches/7114-fix_undefined_variable.patch
  {% endif %}
    # Mostly taken from Fedora's package
    # https://src.fedoraproject.org/rpms/vlc

    # opus_header: fix channel mapping family 1 parsing (rhbz#2307919)
    # https://code.videolan.org/videolan/vlc/-/merge_requests/5590
    # - patches/5590.patch
    #  # add support for ffmpeg 7.0 (without VAAPI)
    #  # https://code.videolan.org/videolan/vlc/-/merge_requests/5574
    #  - patches/5574.patch
    #  # mux: avformat: fix avio callbacks signature with ffmpeg 6.1
    #  # https://code.videolan.org/videolan/vlc/-/merge_requests/6168
    #  - patches/6168.patch
    #  # ffmpeg: backport more channel checks
    #  # https://code.videolan.org/videolan/vlc/-/merge_requests/6273
    #  - patches/6273.patch
    #  # avcodec: vaapi: support VAAPI with latest FFmpeg
    #  # https://code.videolan.org/videolan/vlc/-/merge_requests/6606
    #  - patches/6606.patch
    #  # nfs: fix libnfs API v2 support (rhbz#2341791)
    #  # https://code.videolan.org/videolan/vlc/-/merge_requests/6527
    #  - patches/6527.patch
    - patches/0001-avcodec-avoid-signedness-mismatch-warning.patch
    - patches/0002-avcodec-use-p_dec-fmt_out-instead-of-context-channel.patch
    - patches/0003-avcodec-audio-decoder-to-use-ch_layout.patch
    - patches/0004-avcodec-use-p_enc-audio-channels-instead-of-context-.patch
    - patches/0005-codec-avcodec-map-AYUV-as-RAWVIDEO-with-ffmpeg-6.0.patch
    - patches/0006-avcodec-encoder-fix-channel_layout-conditionals.patch
    - patches/0007-codec-avcodec-fix-audio-channel_layout-conditionals.patch
    - patches/0008-demux-mux-avformat-use-ch_layout-from-ffmpeg-5.1.patch
    - patches/0009-avcodec-add-handling-of-new-ch_layout-in-audio-encod.patch
    - patches/0010-avcodec-use-ch_layout-for-channel-layout-in-audio-en.patch
    - patches/0011-codec-avcodec-bypass-removed-define-for-Intel-workar.patch
    - patches/0012-opus_header-fix-channel-mapping-family-1-parsing.patch
    - patches/0013-mux-avformat-fix-avio-callbacks-signature-with-ffmpe.patch
    - patches/0014-avcommon-rename-LIBAVUTIL_VERSION_CHECK-to-LIBAV_UTI.patch
    - patches/0015-avcommon-use-a-specific-macro-to-check-the-FFmpeg-li.patch
    - patches/0016-avcommon-rename-LIBAVFORMAT_VERSION_CHECK-to-LIBAV_F.patch
    - patches/0017-avcommon-use-a-specific-macro-to-check-the-FFmpeg-li.patch
    - patches/0018-avcommon-rename-LIBAVCODEC_VERSION_CHECK-to-LIBAV_CO.patch
    - patches/0019-avcommon-use-a-specific-macro-to-check-the-FFmpeg-li.patch
    - patches/0020-codec-avcodec-check-open-codec-return-value.patch
    - patches/0021-avcodec-use-ARRAY_SIZE-instead-of-custom-code.patch
    - patches/0022-avcodec-audio-make-channel-mapping-array-0-terminate.patch
    - patches/0023-codec-avcodec-fix-ch_layout-requirement.patch
    - patches/0024-ffmpeg-fix-libavutil-version-check-for-av_channel_la.patch
    - patches/0025-ffmpeg-fix-libavcodec-version-check-for-AVCodecParam.patch
    - patches/0026-avcodec-fix-libavcodec-version-check-for-AVCodecCont.patch
    - patches/0027-ffmpeg-fix-libavutil-version-check-for-AVFrame.ch_la.patch
    - patches/0028-avcodec-add-a-define-to-test-for-AVCodecContext.ch_l.patch
    - patches/0029-nfs-fix-libnfs-API-v2-support.patch
    - patches/0030-avcodec-vaapi-Support-VAAPI-with-latest-FFmpeg.patch

    # https://code.videolan.org/videolan/vlc/-/merge_requests/7116
    # https://code.videolan.org/videolan/vlc/-/issues/29101
    - patches/0031-demux-libmp4-Apply-flip-operations-from-the-display-.patch
    - patches/0032-demux-mp4-remove-junk-debug.patch
    - patches/0033-mp4-remove-unused-variable.patch

    # https://fedoraproject.org/wiki/Changes/CryptoPolicy
    - patches/Use-SYSTEM-wide-ciphers-for-gnutls.patch
   #  # Fix building with fdk-aac-2.0; backport for 3.0 from flathub
   #  - patches/fdk-aac2.patch
   #  # port from intel-mediasdk to oneVPL
   #  - patches/oneVPL.patch
   #  # fix appstreamcli validate to show in Software (rhbz#2258611)
   #  - patches/appdata.patch
   #  # port from libidn to libidn2
   #  - patches/libidn2.patch
   #  # fix deprecated lua math functions (rhbz#2280091)
   #  - patches/lua-math.patch
   #  # update to freerdp2 api; backport from master
   #  - patches/freerdp2.patch
   #  # fix build with live555-2024.11.28
   #  - patches/live555.patch
   #  # avoid "stale plugin cache" warnings in flatpaks
   #  - patches/flatpak-cache.patch

build:
  number: 0
  skip: true  # [not linux]
  script: build_vlc.sh
  run_exports:
    - {{ pin_subpackage('libvlc', max_pin='x.x') }}

requirements:
  build:
    - {{ compiler('cxx') }}
    - {{ compiler('c') }}
    - {{ stdlib('c') }}
    - pkg-config
    - automake
    - make
    - lua
    - libtool
    - gnuconfig
    - autoconf
    - scdoc
    - bison
    - flex
  host:
    - libarchive
    - gnutls
    - libssh2
    # used for idna
    - icu
    # zlib needed to find libssh2
    - zlib
    - lua
    - libflac
    - pulseaudio-client
    - jack
    - dav1d-dev
    - libopus
    - libvorbis
    - libogg
    - libxml2
    - alsa-lib
    - libflac
    - libiconv
    - mpg123
    - libjpeg-turbo
    # What value does opencv bring to vlc???
    # - libopencv
    # limit opencv to headless to avoid pulling in the whole thing
    # - libopencv *=headless*
    - ffmpeg
    # Specify LGPL so as not get the whole thing to be GPL'ed
    - ffmpeg  *=lgpl*
{%- if version.startswith("3") %}
    - qt-main
{%- else %}
    - qt6-main
{%- endif %}
    - glib
    - gstreamer
    - gst-plugins-base
    - ncurses
    - libprotobuf
    - libudev             # [linux]
    - libgl-devel         # [linux]
    - libva               # [linux]
    - libvpx              # [linux]
    - xcb-util-keysyms    # [linux]
    - aom                 # [linux]
    - dbus                # [linux]
    - xorg-libx11         # [linux]
    - libxcb              # [linux]
    - xorg-xorgproto      # [linux]
    - libgl-devel         # [linux]

test:
  commands:
    - test -f ${PREFIX}/lib/libvlc.so
    - test -f ${PREFIX}/lib/libvlccore.so
    # SO Name seems to be quite strict, I think VLC is pretty "stable"
    # but lets add this just to check
    - test -f ${PREFIX}/lib/libvlc.so.5.6.1
    - test -f ${PREFIX}/lib/libvlccore.so.9.0.1

outputs:
  - name: libvlc
  - name: vlc-bin
    script: build_vlc.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ stdlib('c') }}
        - pkg-config
        - automake
        - make
        - lua
        - libtool
        - gnuconfig
        - autoconf
        - scdoc
        - bison
        - flex
      host:
        - {{ pin_subpackage('libvlc', exact=True) }}
        - libarchive
        - gnutls
        - libssh2
        # used for idna
        - icu
        # zlib needed to find libssh2
        - zlib
        - lua
        - libflac
        - pulseaudio-client
        - jack
        - dav1d-dev
        - libopus
        - libvorbis
        - libogg
        - libxml2
        - alsa-lib
        - libflac
        - libiconv
        - mpg123
        - libjpeg-turbo
        - libopencv
        # limit opencv to headless to avoid pulling in the whole thing
        - libopencv *=headless*
        - ffmpeg
        # Specify LGPL so as not get the whole thing to be GPL'ed
        - ffmpeg  *=lgpl*
        - ncurses
        - qt-main
        - glib
        - gstreamer
        - gst-plugins-base
        - libprotobuf
        - libudev             # [linux]
        - libudev             # [linux]
        - libgl-devel         # [linux]
        - libva               # [linux]
        - libvpx              # [linux]
        - xcb-util-keysyms    # [linux]
        - aom                 # [linux]
        - dbus                # [linux]
        - xorg-libx11         # [linux]
        - libxcb              # [linux]
        - xorg-xorgproto      # [linux]
        - libgl-devel         # [linux]
      run:
        - {{ pin_subpackage('libvlc', exact=True) }}
    test:
      commands:
        - vlc --version
        - cvlc --version
        - nvlc --version
        - qvlc --version
  - name: vlc
    requirements:
      run:
        - {{ pin_subpackage('libvlc', exact=True) }}
        - {{ pin_compatible('vlc-bin'), exact=True }}
    test:
      commands:
        - vlc --version
        - cvlc --version
        - nvlc --version
        - qvlc --version

about:
  home: https://videolan.org/
  summary: VLC is a free and open source cross-platform multimedia player and framework that plays most multimedia files as well as DVDs, Audio CDs, VCDs, and various streaming protocols.
  description: |
    VLC is a libre and open source media player and multimedia engine,
    focused on playing everything, and running everywhere.

    VLC can play most multimedia files, discs, streams, devices and is also able to
    convert, encode, stream and manipulate streams into numerous formats.

    VLC is used by many over the world, on numerous platforms, for very different use cases.
    The engine of VLC can be embedded into 3rd party applications, and is called libVLC.

    VLC is part of the VideoLAN project and
    is developed and supported by a community of volunteers.

    The VideoLAN project was started at the university Ã‰cole Centrale Paris who
    relicensed VLC under the GPLv2 license in February 2001. Since then, VLC has
    been downloaded billions of times.

  license: GPL-2.0-or-later AND LGPL-2.1-only
  license_file:
    - COPYING
    - COPYING.LIB
  dev_url: https://code.videolan.org/videolan/vlc

extra:
  recipe-maintainers:
    - hmaarrfk
