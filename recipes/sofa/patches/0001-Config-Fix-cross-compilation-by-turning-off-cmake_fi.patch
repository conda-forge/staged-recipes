From d82a6f97b88219da3db4d3cc1768178d46aeff6b Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Wed, 3 May 2023 19:59:48 +0200
Subject: [PATCH] [Config] Fix cross-compilation by turning off
 cmake_find_root_path for embedded external libs

---
 Sofa/framework/Config/cmake/Modules/FindDiffLib.cmake | 5 +++++
 Sofa/framework/Config/cmake/Modules/FindJson.cmake    | 5 +++++
 Sofa/framework/Config/cmake/Modules/FindSTB.cmake     | 5 +++++
 3 files changed, 15 insertions(+)

diff --git a/Sofa/framework/Config/cmake/Modules/FindDiffLib.cmake b/Sofa/framework/Config/cmake/Modules/FindDiffLib.cmake
index 51b4e5f8ad..76aff96952 100644
--- a/Sofa/framework/Config/cmake/Modules/FindDiffLib.cmake
+++ b/Sofa/framework/Config/cmake/Modules/FindDiffLib.cmake
@@ -1,5 +1,10 @@
 find_path(DIFFLIB_INCLUDE_DIR difflib.h
 		  HINTS ${DIFFLIB_ROOT}
+		  # If cross-compiling and typically use CMAKE_FIND_ROOT_PATH variable,
+		  # each of its directory entry will be prepended to PATHS locations, and
+		  # JSON_ROOT is set as an absolute path. So we have to disable this behavior
+		  # for such external libs
+		  NO_CMAKE_FIND_ROOT_PATH
 	)
 
 include(FindPackageHandleStandardArgs)
diff --git a/Sofa/framework/Config/cmake/Modules/FindJson.cmake b/Sofa/framework/Config/cmake/Modules/FindJson.cmake
index d6257708f3..0ccf74675f 100644
--- a/Sofa/framework/Config/cmake/Modules/FindJson.cmake
+++ b/Sofa/framework/Config/cmake/Modules/FindJson.cmake
@@ -67,6 +67,11 @@ else()
         PATH_SUFFIXES
             nlohmann
             include/nlohmann
+        # If cross-compiling and typically use CMAKE_FIND_ROOT_PATH variable,
+        # each of its directory entry will be prepended to PATHS locations, and
+        # JSON_ROOT is set as an absolute path. So we have to disable this behavior
+        # for such external libs
+        NO_CMAKE_FIND_ROOT_PATH
         )
         
     if(JSON_INCLUDE_DIR)
diff --git a/Sofa/framework/Config/cmake/Modules/FindSTB.cmake b/Sofa/framework/Config/cmake/Modules/FindSTB.cmake
index 4625b6780b..4541a6a4da 100644
--- a/Sofa/framework/Config/cmake/Modules/FindSTB.cmake
+++ b/Sofa/framework/Config/cmake/Modules/FindSTB.cmake
@@ -1,5 +1,10 @@
 find_path(STB_INCLUDE_DIR stb_image.h
 		  HINTS ${STB_ROOT}
+		  # If cross-compiling and typically use CMAKE_FIND_ROOT_PATH variable,
+		  # each of its directory entry will be prepended to PATHS locations, and
+		  # JSON_ROOT is set as an absolute path. So we have to disable this behavior
+		  # for such external libs
+		  NO_CMAKE_FIND_ROOT_PATH
 	)
 
 include(FindPackageHandleStandardArgs)
-- 
2.34.1

