From 03ed71f9a3278e737f91065d3a54ee148e1962b0 Mon Sep 17 00:00:00 2001
From: Olivier Roussel <olivier.roussel@inria.fr>
Date: Wed, 3 Jan 2024 17:29:11 +0100
Subject: [PATCH] Allow components to be compiled out of SOFA

---
 Sofa/GL/CMakeLists.txt         |  9 +++++++++
 Sofa/GUI/Common/CMakeLists.txt |  9 +++++++++
 Sofa/GUI/Qt/CMakeLists.txt     | 12 ++++++++++++
 3 files changed, 30 insertions(+)

diff --git a/Sofa/GL/CMakeLists.txt b/Sofa/GL/CMakeLists.txt
index c0d94be07f..1f02ba513e 100644
--- a/Sofa/GL/CMakeLists.txt
+++ b/Sofa/GL/CMakeLists.txt
@@ -3,6 +3,15 @@ project(Sofa.GL LANGUAGES CXX)
 
 set(SOFAGLSRC_ROOT "src/sofa/gl")
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+endif()
+
 sofa_find_package(OpenGL REQUIRED BOTH_SCOPES)
 sofa_find_package(GLEW BOTH_SCOPES REQUIRED)
 sofa_find_package(Sofa.Helper REQUIRED)
diff --git a/Sofa/GUI/Common/CMakeLists.txt b/Sofa/GUI/Common/CMakeLists.txt
index f6cb2e6dd6..7a63d35285 100644
--- a/Sofa/GUI/Common/CMakeLists.txt
+++ b/Sofa/GUI/Common/CMakeLists.txt
@@ -1,6 +1,15 @@
 cmake_minimum_required(VERSION 3.12)
 project(Sofa.GUI.Common LANGUAGES CXX)
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+endif()
+
 find_package(cxxopts 3.1 QUIET)
 if(NOT cxxopts_FOUND AND SOFA_ALLOW_FETCH_DEPENDENCIES)
     message("Sofa.GUI.Common: DEPENDENCY cxxopt NOT FOUND. SOFA_ALLOW_FETCH_DEPENDENCIES is ON, fetching cxxopt...")
diff --git a/Sofa/GUI/Qt/CMakeLists.txt b/Sofa/GUI/Qt/CMakeLists.txt
index 2bb1b2d8ba..b5b0269169 100644
--- a/Sofa/GUI/Qt/CMakeLists.txt
+++ b/Sofa/GUI/Qt/CMakeLists.txt
@@ -1,6 +1,17 @@
 cmake_minimum_required(VERSION 3.12)
 project(Sofa.GUI.Qt LANGUAGES CXX)
 
+# Detect if component is compiled outside SOFA
+if ("${CMAKE_PROJECT_NAME}" STREQUAL "${PROJECT_NAME}")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/Modules")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake")
+  list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../../framework/Config/cmake/Modules")
+
+  include(SofaMacros)
+
+  sofa_find_package(Sofa.GUI.Common REQUIRED)
+endif()
+
 # Qt dependencies
 set(QT_TARGETS "")
 set(QT_USE_IMPORTED_TARGETS 1)
@@ -318,6 +329,7 @@ add_library(${PROJECT_NAME} SHARED ${MOC_HEADER_FILES} ${HEADER_FILES} ${MOC_FIL
 # For files generated by the moc
 target_include_directories(${PROJECT_NAME} PUBLIC "$<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}>")
 
+target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.GL)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.GUI.Common)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.Component.Visual)
 target_link_libraries(${PROJECT_NAME} PUBLIC Sofa.Component.SceneUtility)
-- 
2.34.1

