{% set name = "libzmq" %}
{% set version = "4.3.5" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/zeromq/libzmq/archive/refs/tags/v4.3.5.tar.gz
  sha256: 6c972d1e6a91a0ecd79c3236f04cf0126f2f4dfbbad407d72b4606a7ba93f9c6

build:
  number: 0

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    - cmake
    - ninja
  host:

test:
  source_files:
    - build-release/platform.hpp
    - external
    - include
    - src
    - tests
  requires:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    - cmake
    - ninja
  commands:
    # Installation tests
    - test -f $PREFIX/lib/pkgconfig/libzmq.pc
    - test -f $PREFIX/bin/local_lat
    - test -f $PREFIX/bin/remote_lat
    - test -f $PREFIX/bin/local_thr
    - test -f $PREFIX/bin/remote_thr
    - test -f $PREFIX/bin/inproc_lat
    - test -f $PREFIX/bin/inproc_thr
    - test -f $PREFIX/bin/proxy_thr
    - test -f $PREFIX/lib/libzmq.so.5.2.5
    - test -f $PREFIX/lib/libzmq.so.5
    - test -f $PREFIX/lib/libzmq.so
    - test -f $PREFIX/include/zmq.h
    - test -f $PREFIX/include/zmq_utils.h
    - test -f $PREFIX/share/zmq/AUTHORS.txt
    - test -f $PREFIX/share/zmq/LICENSE.txt
    - test -f $PREFIX/share/zmq/NEWS.txt
    - test -f $PREFIX/lib/cmake/ZeroMQ/ZeroMQTargets.cmake
    - test -f $PREFIX/lib/cmake/ZeroMQ/ZeroMQTargets-release.cmake
    - test -f $PREFIX/lib/cmake/ZeroMQ/ZeroMQConfig.cmake
    - test -f $PREFIX/lib/cmake/ZeroMQ/ZeroMQConfigVersion.cmake

    # Testsuite
    - cp build-release/platform.hpp $SRC_DIR/src
    - sed -i -E 's@\binclude_directories\((.*)\)@include_directories(\1 "${ZeroMQ_SOURCE_DIR}/../external/unity")@' $SRC_DIR/tests/CMakeLists.txt
    - mkdir build-test
    - cd build-test
    - cmake $SRC_DIR/tests -Wno-dev -D BUILD_SHARED=ON -D CMAKE_PREFIX_PATH=$SRC_DIR/external/unity -D ZeroMQ_SOURCE_DIR=$SRC_DIR/build-release -D ZeroMQ_BINARY_DIR=${PREFIX} -G Ninja
    - cmake --build . --config Release
    - ctest -C Release --output-on-failure

about:
  home: https://github.com/zeromq/libzm
  summary: 'The ZeroMQ lightweight messaging kernel'
  description: |
    The ZeroMQ lightweight messaging kernel is a library which extends the standard
    socket interfaces with features traditionally provided by specialised messaging
    middleware products. ZeroMQ sockets provide an abstraction of asynchronous message
    queues, multiple messaging patterns, message filtering (subscriptions), seamless
    access to multiple transport protocols and more.
  license: Mozilla Public License 2.0
  license_file: LICENSE
  doc_url: https://zeromq.org/

extra:
  recipe-maintainers:
    - MementoRC
