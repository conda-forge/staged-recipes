{% set name = "openvino" %}
{% set version = "2022.3.0" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  # - path: ../../../{{ name }}
  #   folder: openvino_sources
  - url: https://github.com/ilya-lavrenov/openvino/archive/fd8d8a78b5328b0b02fa0cc67bf41e1bbf2f4d16.tar.gz
    sha256: 761c1df0ed406da1426ce2ffa2c5319fd7bdb99764c43a5d8303ebe83aafd23c
    folder: openvino_sources
    patches:
      - patches/0001-dependencies.patch
  - url: https://github.com/openvinotoolkit/openvino_contrib/archive/1ca3a1ebd01ad76231042b68f6260976cebd662d.tar.gz
    sha256: 49ed81e415c25fdb04e80a82b31441dae2b5d9067a70662f79b885c70f3e2581
    folder: openvino_sources/openvino_contrib
  - url: https://github.com/ARM-software/ComputeLibrary/archive/refs/tags/v22.08.tar.gz
    sha256: ac2ce7b5636e99f175b084362f83fe24d72e6ceb0bd62ee5866772f7355d024d
    folder: openvino_contrib/modules/arm_plugin/thirdparty/ComputeLibrary
  - url: https://github.com/onnx/onnx/archive/refs/tags/v1.12.0.tar.gz
    sha256: 052ad3d5dad358a33606e0fc89483f8150bb0655c99b12a43aa58b5b7f0cc507
    folder: openvino_sources/thirdparty/onnx/onnx
  - url: https://github.com/herumi/xbyak/archive/refs/tags/v6.63.tar.gz
    sha256: 16c60f0682502624115c4dc9fec66782ae68ef32e469946f50cd169179ea92bb
    folder: openvino_sources/thirdparty/xbyak
  - url: https://github.com/intel/ittapi/archive/refs/tags/v3.23.0.tar.gz
    sha256: 9af1231808c602c2f7a66924c8798b1741d3aa4b15f3874d82ca7a89b5dbb1b1
    folder: openvino_sources/thirdparty/ittapi/ittapi
  - url: https://github.com/opencv/ade/archive/refs/tags/v0.1.1f.tar.gz
    sha256: c316680efbb5dd3ac4e10bb8cea345cf26a6a25ebc22418f8f0b8ca931a550e9
    folder: openvino_sources/thirdparty/ade
  - url: https://github.com/openvinotoolkit/oneDNN/archive/6df930dab5ab0a7dfaea6100acd03b479e2fa0a8.tar.gz
    sha256: 8667b6497205a7fa50a378fd5eeb175584ce4ade88ba5f36e7f4de3831576e43
    folder: openvino_sources/src/plugins/intel_cpu/thirdparty/onednn
  - url: https://github.com/oneapi-src/oneDNN/archive/b5faa77a4a651f1e44fa77348eded54ea3ec3eef.tar.gz
    sha256: cc2faf62420b95f6c81835078910e32ee1cb12738531f4af02d06fcaa2a6a12d
    folder: openvino_sources/src/plugins/intel_gpu/thirdparty/onednn_gpu
  - url: https://github.com/protocolbuffers/protobuf/releases/download/v21.7/protobuf-cpp-3.21.7.tar.gz
    sha256: 70de993af0b4f2ddacce59e62ba6d7b7e48faf48beb1b0d5f1ac0e1fb0a68423
    folder: openvino_sources/thirdparty/protobuf/protobuf
  - url: https://github.com/KhronosGroup/OpenCL-Headers/archive/refs/tags/v2022.09.30.tar.gz
    sha256: 0ae857ecb28af95a420c800b21ed2d0f437503e104f841ab8db249df5f4fbe5c
    folder: openvino_sources/thirdparty/ocl/cl_headers
  - url: https://github.com/KhronosGroup/OpenCL-CLHPP/archive/refs/tags/v2022.09.30.tar.gz
    sha256: 999dec3ebf451f0f1087e5e1b9a5af91434b4d0c496d47e912863ac85ad1e6b2
    folder: openvino_sources/thirdparty/ocl/clhpp_headers
  - url: https://github.com/KhronosGroup/OpenCL-ICD-Loader/archive/refs/tags/v2022.09.30.tar.gz
    sha256: e9522fb736627dd4feae2a9c467a864e7d25bb715f808de8a04eea5a7d394b74
    folder: openvino_sources/thirdparty/ocl/icd_loader
  - url: https://github.com/nlohmann/json/archive/refs/tags/v3.11.2.tar.gz
    sha256: d69f9deb6a75e2580465c6c4c5111b89c4dc2fa94e3a85fcd2ffcd9a143d9273
    folder: openvino_sources/thirdparty/json/nlohmann_json
  - url: https://github.com/pboettch/json-schema-validator/archive/refs/tags/2.1.0.tar.gz
    sha256: 83f61d8112f485e0d3f1e72d51610ba3924b179926a8376aef3c038770faf202
    folder: openvino_sources/thirdparty/json/nlohmann_json_schema_validator

build:
  number: 0

requirements:
  build:
    # build
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - git
    - cmake >=3.13
    - ccache
    - ninja  # [win]
    - make  # [not win]
    - python >=3.7
    - nlohmann_json
    - json_schema_validator
    - scons  # [aarch64 or arm64]
    # - libprotobuf-static
    - sysroot_linux-64 =2.17  # [linux and x86_64]
  host:
    # core
    - tbb-devel >=2021.5
    - pugixml # static version is provided
  # TODO: fix to enable openvino meta-package
  # run:
  #   - libopenvino
  #   - libopenvino-plugins
  #   - libopenvino-dev

outputs:
  - name: libopenvino
    version: {{ version }}
    script: install.sh
    about:
      summary: OpenVINO Core Runtime library
    build:
      run_exports:
        - {{ pin_subpackage('libopenvino', exact=True) }}
    requirements:
      host:
        - libhwloc >=2.5 # starting from this version hwloc supports Apple Silicon
      run:
        - tbb >=2021.5 # TBB does not provide 'run_exports', otherwise we can put it into 'host'
    test:
      commands:
        {% set openvino_libs = [] %}
        {{ openvino_libs.append("") or "" }}
        {{ openvino_libs.append("_c") or "" }}
        {{ openvino_libs.append("_ir_frontend") or "" }}
        {{ openvino_libs.append("_paddle_frontend") or "" }}
        {{ openvino_libs.append("_onnx_frontend") or "" }}
        {% for openvino_lib in openvino_libs %}
        - test -f $PREFIX/lib/libopenvino{{ openvino_lib }}${SHLIB_EXT}.{{ version }}  # [unix]
        - test -f $PREFIX/lib/openvino{{ openvino_lib }}${SHLIB_EXT}  # [win]
        {% endfor %}

  - name: libopenvino-plugins
    version: {{ version }}
    script: install_plugins.sh
    about:
      summary: OpenVINO Inference Plugins
    build:
      run_exports:
        - {{ pin_subpackage('libopenvino-plugins', exact=True) }}
    requirements:
      run:
        - {{ pin_subpackage('libopenvino', exact=True) }}
        - ocl-icd-system  # [linux and x86_64]
        - tbb >=2021.5 # TBB does not provide 'run_exports', otherwise we can put it into 'host'
    test:
      commands:
        {% set openvino_plugin_libs = [] %}
        {{ openvino_plugin_libs.append("intel_cpu") or "" }}
        {{ openvino_plugin_libs.append("intel_gpu") or "" }}
        {{ openvino_plugin_libs.append("auto") or "" }}
        {{ openvino_plugin_libs.append("auto_batch") or "" }}
        {{ openvino_plugin_libs.append("hetero") or "" }}
        {% for openvino_plugin_lib in openvino_plugin_libs %}
        - test -f $PREFIX/lib/openvino-{{ version }}/libopenvino_{{ openvino_plugin_lib }}_plugin${SHLIB_EXT}  # [unix]
        - test -f $PREFIX/lib/openvino-{{ version }}/openvino_{{ openvino_plugin_lib }}_plugin${SHLIB_EXT}  # [win]
        {% endfor %}

  - name: libopenvino-dev
    version: {{ version }}
    script: install_dev.sh
    about:
      summary: OpenVINO Runtime Development files
    test:
      requires:
        - {{ compiler('cxx') }}
        - {{ compiler('c') }}
        - ninja  # [win]
        - make  # [not win]
        - cmake >=3.13
        - pkg-config # to find zlib
        - zlib
        - nlohmann_json
        - opencv
        - gflags
      source_files:
        - openvino_sources/samples
        - openvino_sources/thirdparty/cnpy
      commands:
        - mkdir -p openvino_sources/samples/cpp/thirdparty
        - cp -R openvino_sources/thirdparty/cnpy openvino_sources/samples/cpp/thirdparty/cnpy
        - cmake -S openvino_sources/samples/cpp -B samples_cpp_build
        - cmake --build samples_cpp_build --parallel $CPU_COUNT
        - samples_cpp_build/intel64/hello_query_device

about:
  home: https://github.com/openvinotoolkit/openvino
  summary: 'Intel® Distribution of OpenVINO™ Toolkit'
  description: |
    Intel® Distribution of OpenVINO™ toolkit is an open-source toolkit for
    optimizing and deploying AI inference. It can be used to develop
    applications and solutions based on deep learning tasks, such as:
    emulation of human vision, automatic speech recognition, natural
    language processing, recommendation systems, etc. It provides
    high-performance and rich deployment options, from edge to cloud
  license: Apache-2.0
  license_family: Apache
  license_file:
    - LICENSE
    - licensing/third-party-programs.txt
    - licensing/onednn_third-party-programs.txt
    - licensing/runtime-third-party-programs.txt
    - licensing/tbb_third-party-programs.txt
  doc_url: https://docs.openvino.ai/latest/index.html
  dev_url: https://github.com/openvinotoolkit/openvino

extra:
  recipe-maintainers:
    - ilya-lavrenov
