{% set version = "0.17.2" %}

package:
  name: mklml
  version: {{ version }}

source:
  url: https://github.com/intel/mkl-dnn/archive/v{{ version }}.tar.gz
  fn: mkl-dnn-{{ version }}.tar.gz
  sha256: 56c3e22d4fad816059cc58fd8e78ab3bacbec76a6bbded7eaead66220d8e5134
  patches:
    # this patch moves the dll to the bin location
    # https://github.com/intel/mkl-dnn/pull/346
    - 346-unify-install-command.patch

{% set cmake_install_prefix = LIBRARY_PREFIX %}  # [win]
{% set cmake_install_prefix = PREFIX %}          # [unix]

build:
  skip: true  # [win and vc<14]
  # Why do I have to skip windows 32? Conda forge builds this?
  skip: true  # [win32]
  number: 0
  script:
    - echo on  # [win]
    - set -ex  # [unix]
    # they have pragmas around the warning that causes the failure,
    # but it doesn't seem to be working, at least with toolchain compilers
    - export CXXFLAGS="${CXXFLAGS} -Wno-array-bounds -Wno-error=array-bounds"  # [unix]
    # Compiler is out of heap space???? on windows, for release builds
    # appveyor seems to run out of heap space with this option enabled.
    # we can try azure once the recipe gets it's own feedstock
    # https://ci.appveyor.com/project/conda-forge/staged-recipes/builds/21349190#L1123
    - set "LDFLAGS_SHARED=%LDFLAGS_SHARED% /LTCG:OFF"     # [win]
    # It seems their make file doesn't look for LDFLAGS_SHARED
    - set "LDFLAGS=%LDFLAGS_SHARED% %LDFLAGS%"            # [win]
    - mkdir build
    - cd build
    - cmake -LAH -G "Ninja" -DWITH_TEST=0 -DWITH_EXAMPLE=0 -DCMAKE_BUILD_TYPE="Release" -DCMAKE_INSTALL_PREFIX={{ cmake_install_prefix }} ..
    - ninja install                                       # [unix]
    - cmake --build . --target install  --config Release  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
    - ninja
  host:
    - openmp

# The only reason I'm splitting the package is that defaults has it split
outputs:
  - name: mklml
    files:
      - lib/libmkldnn.so.{{ version }}.0           # [linux]
      - lib/libmkldnn.so.0                         # [linux]
      - share/doc/mkldnn/LICENSE                   # [unix]
      - lib/libmkldnn.{{ version }}.0.dylib        # [osx]
      - lib/libmkldnn.0.dylib                      # [osx]
      - Library\\share\\doc\\mkldnn\\LICENSE       # [win]
      - Library\\bin\\mkldnn.dll                   # [win]
    test:
      comamnds:
        - if not exist %PREFIX%\\Library\\bin\\mkldnn.dll exit 1     # [win]
        - test -f $PREFIX/lib/libmkldnn.so.0                         # [linux]
        - test -f $PREFIX/lib/libmkldnn.0.dylib                      # [osx]
  - name: libmklml
    build:
      run_exports:
        # https://abi-laboratory.pro/index.php?view=timeline&l=mkl-dnn
        - {{ pin_subpackage('mklml', 'x.x') }}
    requirements:
      run:
        - {{ pin_subpackage('mklml', exact=True) }}
    files:
      - include/mkldnn.h               # [unix]
      - include/mkldnn.hpp             # [unix]
      - include/mkldnn_debug.h         # [unix]
      - include/mkldnn_types.h         # [unix]
      - lib/libmkldnn${SHLIB_EXT}      # [unix]
      - Library\\include\\mkldnn.h              # [win]
      - Library\\include\\mkldnn.hpp            # [win]
      - Library\\include\\mkldnn_debug.h        # [win]
      - Library\\include\\mkldnn_types.h        # [win]
      - Library\\lib\\mkldnn.lib                # [win]
    test:
      commands:
        - test -f $PREFIX/include/mkldnn.h           # [unix]
        - test -f $PREFIX/include/mkldnn.hpp         # [unix]
        - test -f $PREFIX/include/mkldnn_debug.h     # [unix]
        - test -f $PREFIX/include/mkldnn_types.h     # [unix]
        - test -f $PREFIX/lib/libmkldnn${SHLIB_EXT}  # [unix]
        - if not exist %PREFIX%\\Library\\include\\mkldnn.h exit 1             # [win]
        - if not exist %PREFIX%\\Library\\include\\mkldnn.hpp exit 1           # [win]
        - if not exist %PREFIX%\\Library\\include\\mkldnn_debug.h exit 1       # [win]
        - if not exist %PREFIX%\\Library\\include\\mkldnn_types.h exit 1       # [win]
        - if not exist %PREFIX%\\Library\\lib\\mkldnn.lib exit 1               # [win]

about:
  home: https://01.org/mkl-dnn
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: 'Aperformance library for deep-learning applications. The library accelerates deep-learning applications and frameworks on Intel architecture.'
  dev_url: https://github.com/intel/mkl-dnn/tree/master

extra:
  recipe-maintainers:
    - hmaarrfk
    - sodre
