{% set name = "sam3" %}
{% set git_hash = "84cc43bca4347b772f17d1078a1ddb4c054655c2" %}
{% set version = "0.1.0" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/facebookresearch/sam3/archive/{{ git_hash }}.tar.gz
  sha256: b50d5f85bc57f13ef8c1b7fe485688bc0f76f58d18078ce9b505acb3bcfa408b
  patches:
    # https://github.com/facebookresearch/sam3/pull/167
    - 167-update_setuptools_to_find_all_subpackages.patch
    # https://github.com/facebookresearch/sam3/pull/196
    # - 196-lazy_import_decord.patch
    # Decord is simply unmaintained and the codepath doesn't really use
    # that much reuse of a single video instance
    # I (hmaarrfk) rewrote it in pyav
    - use_pyav_instead_of_decord.patch
    # triton seems to be only used in
    # sample_one_point_from_error_center
    # which doesn't seem to be used in any sam3 codepath
    # So i'm going to lazy import this to avoid the whole triton (and compiler)
    # requirement
    - 0001-Avoid-importing-triton-since-it-doesn-t-seem-used.patch
    # numpy and ftfy are pinned too hard in sam3
    - loosen_dependencies.patch

build:
  noarch: python
  script: python -m pip install . -vv
  number: 0

requirements:
  host:
    - python {{ python_min }}
    - setuptools
    - wheel
    - pip
  run:
    - python >={{ python_min }}
    - timm >=1.0.17
    - numpy >=1.26
    - tqdm
    - ftfy >=6.1.1
    - regex
    - iopath >=0.1.10
    - typing_extensions
    - huggingface_hub
    - einops
    - pytorch
    - einops >=0.8.0
    # They use pycocotools's mask utils alot
    - pycocotools
    - psutil
    - av

test:
  imports:
    - sam3
  commands:
    - pip check
  requires:
    - pip
    - python {{ python_min }}

about:
  home: https://github.com/facebookresearch/sam3
  summary: 'SAM 3: Segment Anything with Concepts'
  description: |
    SAM 3 is a unified foundation model for promptable segmentation in images and videos.
    It can detect, segment, and track objects using text or visual prompts such as points,
    boxes, and masks.
  license: SAM
  license_family: OTHER
  license_file: LICENSE

extra:
  recipe-maintainers:
    - giswqs
