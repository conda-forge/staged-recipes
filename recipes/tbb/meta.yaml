{% set version = "2019_U3" %}

package:
  name: tbb
  version: {{ version }}

source:
  url: https://github.com/01org/tbb/archive/{{ version }}.tar.gz
  fn: tbb-{{ version }}.tar.gz
  sha256: b2244147bc8159cdd8f06a38afeb42f3237d3fc822555499d7ccfbd4b86f8ece

build:
  number: 0
  script:
    # don't install the docs
    - {{ PYTHON }} build/build.py --prefix={{ PREFIX }} --install-libs --install-devel          # [unix]
    - {{ PYTHON }} build/build.py --prefix={{ PREFIX }}/Library --install-libs --install-devel  # [win]
  run_exports:
    # Really good compatibility
    # https://abi-laboratory.pro/index.php?view=timeline&l=tbb
    - {{ pin_subpackage('tbb') }}

requirements:
  build:
    - {{ compiler('c') }}
    - make
  host:
    - python 3.6

outputs:
  - name: tbb
  - name: python-tbb
    build:
      script:
        - {{ PYTHON }} build/build.py --prefix={{ PREFIX }} --install-python
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - make
        - swig
      host:
        - python 3.6
      run:
        - python 3.6
        - {{ pin_subpackage('tbb', exact=True) }}
    test:
      imports:
        - tbb
        - TBB
test:
  commands:
    - test -f $PREFIX/lib/libtbb${SHLIB_EXT}                     # [unix]
    - test -f $PREFIX/lib/libtbb_debug${SHLIB_EXT}               # [unix]
    - test -f $PREFIX/lib/libtbbmalloc${SHLIB_EXT}               # [unix]
    - test -f $PREFIX/lib/libtbbmalloc_debug${SHLIB_EXT}         # [unix]
    - test -f $PREFIX/lib/libtbbmalloc_proxy${SHLIB_EXT}         # [unix]
    - test -f $PREFIX/lib/libtbbmalloc_proxy_debug${SHLIB_EXT}   # [unix]
    - test -f $PREFIX/include/serial/tbb/parallel_for.h          # [unix]
    - test -f $PREFIX/include/serial/tbb/tbb_annotate.h          # [unix]
    - test -f $PREFIX/include/tbb/tbb.h                          # [unix]
    # Many more includes exist, but this is probably enough to check.

about:
  home: threadingbuildingblocks.org
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: 'TBB lets you easily write parallel C++ programs that take full advantage of multicore performance, that are portable, composable and have future-proof scalability.'
  dev_url: https://github.com/01org/tbb

extra:
  recipe-maintainers:
    - hmaarrfk
    - sodre
