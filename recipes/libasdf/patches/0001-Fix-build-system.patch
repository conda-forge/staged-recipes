From e3b67ad5f9f0226eafea6c1ee198c48de90e8ab8 Mon Sep 17 00:00:00 2001
From: Joseph Hunkeler <jhunkeler@gmail.com>
Date: Mon, 8 Dec 2025 15:41:21 -0500
Subject: [PATCH 1/2] Fix build system

---
 Makefile.am       |  5 +----
 configure.ac      |  5 ++++-
 tests/Makefile.am | 18 +++++++++++-------
 3 files changed, 16 insertions(+), 12 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index ca18bd3..706bbfd 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -81,9 +81,6 @@ ACLOCAL_AMFLAGS = -Im4
 
 noinst_HEADERS = $(src_headers)
 
-ASDF_LIBS = $(FYAML_LIBS) $(ZLIB_LIBS) $(BZIP2_LIBS) $(LZ4_LIBS) $(STATGRAB_LIBS)
-
-
 # libasdf library
 #include .c and .h in SOURCES so that both appear in dist
 lib_LTLIBRARIES = libasdf.la
@@ -98,7 +95,7 @@ bin_PROGRAMS = asdf
 asdf_SOURCES = src/main.c
 asdf_CFLAGS = $(AM_CFLAGS) $(FYAML_CFLAGS) $(STATGRAB_CFLAGS) $(LZ4_CFLAGS) $(CODE_COVERAGE_CFLAGS)
 asdf_LDFLAGS = $(CODE_COVERAGE_LDFLAGS)
-asdf_LDADD = libasdf.la $(ARGP_LIB) $(ASDF_LIBS)
+asdf_LDADD = libasdf.la $(ARGP_LIBS) $(ASDF_LIBS)
 endif # ASDF_BUILD_TOOL
 
 
diff --git a/configure.ac b/configure.ac
index 1102b4b..77232a6 100644
--- a/configure.ac
+++ b/configure.ac
@@ -262,10 +262,13 @@ AS_IF([test "x$asdf_build_tool" = "xyes"], [
 
 # Shouldn't be needed with glibc but is if we're using the homebrew package, e.g.
   AC_CHECK_LIB([argp], [argp_parse], [
-    AC_SUBST([ARGP_LIB], [-largp])
+    AC_SUBST([ARGP_LIBS], [-largp])
   ])
 ])
 
+ASDF_LIBS="$FYAML_LIBS $ZLIB_LIBS $BZIP2_LIBS $LZ4_LIBS $STATGRAB_LIBS"
+AC_SUBST([ASDF_LIBS])
+
 # ------ Optional features ---------------------------------------------------
 
 AC_ARG_WITH([gwcs],
diff --git a/tests/Makefile.am b/tests/Makefile.am
index 64c1dc9..957f823 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -7,7 +7,10 @@ AM_CPPFLAGS = \
 
 asdf_standard_dir = $(abs_top_srcdir)/asdf-standard
 asdf_standard_submodule = $(asdf_standard_dir)/.git
-munit_submodule = $(srcdir)/tests/munit.git
+munit_dir = $(top_srcdir)/tests/munit
+munit_submodule = $(munit_dir)/.git
+munit_cflags = -I$(srcdir)/tests
+munit_ldflags = $(builddir)/libmunit.a
 submodules = $(asdf_standard_submodule) $(munit_submodule)
 
 $(asdf_standard_submodule) $(munit_submodule):
@@ -43,18 +46,18 @@ unit_test_cppflags = \
     -DREFERENCE_FILES_DIR=\"$(asdf_standard_dir)/reference_files\" \
     -DFIXTURES_DIR=\"$(abs_srcdir)/fixtures\"
 unit_test_cflags = \
-    $(FYAML_CFLAGS) $(STATGRAB_CFLAGS) $(LZ4_CFLAGS) $(CODE_COVERAGE_CFLAGS) $(ASDF_CFLAGS)
+     $(munit_cflags) $(FYAML_CFLAGS) $(STATGRAB_CFLAGS) $(LZ4_CFLAGS) $(CODE_COVERAGE_CFLAGS) $(ASDF_CFLAGS)
 
 if DEBUG
 unit_test_cflags += -DMUNIT_NO_FORK
 endif
 
-unit_test_ldflags = $(CODE_COVERAGE_LDFLAGS)
-unit_test_ldadd = $(top_builddir)/libasdf.la libmunit.a $(LZ4_LIBS) $(STATGRAB_LIBS)
+unit_test_ldflags = $(LDFLAGS) $(CODE_COVERAGE_LDFLAGS)
+unit_test_ldadd = $(munit_ldflags) $(top_builddir)/libasdf.la $(ASDF_LIBS)
 
 # Unit tests
 check_LIBRARIES = libmunit.a
-libmunit_a_SOURCES = util.c munit/munit.c
+libmunit_a_SOURCES = util.c $(munit_dir)/munit.c
 libmunit_a_CPPFLAGS = $(unit_test_cppflags)
 libmunit_a_CFLAGS = $(unit_test_cflags) -w
 
@@ -191,7 +194,7 @@ $(cpp_header_test): $(asdf_public_headers) $(srcdir)/scripts/generate_test_cpp_h
 
 test-cpp-headers$(EXEEXT): $(cpp_header_test) $(top_builddir)/libasdf.la
 	$(AM_V_at)$(LIBTOOL) --mode=link $(CXX) -std=c++17 -I$(top_srcdir)/include \
-	    $(ASDF_LDFLAGS) $(cpp_header_test) $(top_builddir)/libasdf.la \
+	    $(ASDF_LDFLAGS) $(unit_test_ldflags) $(cpp_header_test) $(top_builddir)/libasdf.la $(ASDF_LIBS) \
 	    -o $@ $(QUIET_OUT)
 
 TESTS += test-cpp-headers
@@ -211,7 +214,8 @@ $(DOC_EXAMPLES_DIR)/test-doc-examples.sh: $(top_srcdir)/README.rst $(srcdir)/scr
 	$(AM_V_at)for f in $(DOC_EXAMPLES_DIR)/*.c; do \
 	    exe=$${f%.c}; \
 	    $(LIBTOOL) --mode=link $(CC) $(ASDF_CFLAGS) -I$(top_srcdir)/include \
-	      $(ASDF_LDFLAGS) $$f $(top_builddir)/libasdf.la -o $$exe $(QUIET_OUT); \
+	      $(ASDF_LDFLAGS) $(unit_test_ldflags) $$f $(top_builddir)/libasdf.la $(ASDF_LIBS) \
+	      -o $$exe $(QUIET_OUT); \
 	done
 
 endif
-- 
2.51.2

