# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
context:
  name: "MoarVM"
  version: "2025.06"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://github.com/${{ name }}/${{ name }}/releases/download/${{ version }}/${{ name }}-${{ version }}.tar.gz
  sha256: e8d6b00cdb3f99022ade2a843a7a8ec87f66a38bb5655f85d50351c6b3b8d257

build:
  number: 0
  script:
    interpreter: perl
    content: |
      use strict;
      use warnings;
      use File::Basename;

      # Set up environment for Linux (needed for memmem)
      if ($^O eq 'linux') {
          $ENV{CFLAGS} = ($ENV{CFLAGS} // '') . ' -D_GNU_SOURCE';
      }

      # Get the compiler basename
      my $cc = $ENV{CC} // 'gcc';
      my $cc_basename = basename($cc);

      # Configure MoarVM
      my @configure_args = (
          'Configure.pl',
          '--c11-atomics',
          '--has-libtommath',
          '--has-mimalloc',
          '--has-libuv',
          '--has-libffi',
          "--prefix=$ENV{PREFIX}",
          "--cc=$cc_basename"
      );

      print "Running: perl @configure_args\n";
      system('perl', @configure_args) == 0
          or die "Configure failed: $?\n";

      # Build and install
      my $make_cmd = $^O eq 'MSWin32' ? 'nmake' : 'make';

      print "Running: $make_cmd install\n";
      system($make_cmd, 'install') == 0
          or die "Make install failed: $?\n";

      print "MoarVM build completed successfully\n";

requirements:
  build:
    - ${{ compiler("c") }}
    - ${{ stdlib("c") }}
    - make
    - perl
    - pkgconf
    - mimalloc
  host:
    - libtommath
    - mimalloc
    - libuv
    - libffi
  run_exports:
    - ${{ pin_subpackage("moarvm", exact=True) }}

tests:
  - script:
      - moar --version
      - moar --help
    requirements:
      run: moarvm

about:
  homepage: https://moarvm.org/
  license: Artistic-2.0
  license_file: LICENSE
  summary: A VM with adaptive optimization and JIT compilation, built for Rakudo
  description: |
    MoarVM (short for Metamodel On A Runtime Virtual Machine) is a runtime built for the 6model object system. It is primarily aimed at running NQP and Rakudo, but should be able to serve as a backend for any compilers built using the NQP compiler toolchain.
  repository: https://github.com/MoarVM/MoarVM
  documentation: https://github.com/MoarVM/MoarVM/tree/main/docs

extra:
  recipe-maintainers:
    - remimimimimi
