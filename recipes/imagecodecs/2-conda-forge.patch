From 6b2b958ef7274aba6bdb93810a178cdaa8e163d9 Mon Sep 17 00:00:00 2001
From: santi <sdvillal@gmail.com>
Date: Sun, 31 May 2020 16:45:23 +0200
Subject: [PATCH] Fix conda build path

---
 setup.py | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/setup.py b/setup.py
index 1ee7670..ebdead6 100644
--- a/setup.py
+++ b/setup.py
@@ -268,29 +268,31 @@ def customize_build_ci(EXTENSIONS, OPTIONS):
 def customize_build_cf(EXTENSIONS, OPTIONS):
     """Customize build for conda-forge."""
 
-    library_inc = os.environ.get('LIBRARY_INC', '')
-
     del EXTENSIONS['jpeg12']
     del EXTENSIONS['jpegxl']
     del EXTENSIONS['lerc']
     del EXTENSIONS['zfp']
 
     # build jpeg8 against libjpeg instead of libjpeg_turbo
+    # note that for conda, "jpeg8" can be a bit misleading as we will be building against jpeg9
     OPTIONS['cythonize'] = True
     EXTENSIONS['jpeg8']['cython_compile_env']['HAVE_LIBJPEG_TURBO'] = False
 
-    EXTENSIONS['jpegxr']['libraries'] = ['libjpegxr', 'libjxrglue']
+    EXTENSIONS['jpegxr']['libraries'] = ['jpegxr', 'jxrglue']
     EXTENSIONS['jpegxr']['include_dirs'] = [
-        os.path.join(library_inc, 'jpegxr')
+        os.path.join(os.environ['PREFIX'], 'include', 'jxrlib')
     ]
 
     if sys.platform == 'win32':
         EXTENSIONS['bz2']['libraries'] = ['bzip2']
         EXTENSIONS['jpeg2k']['include_dirs'] = [
             os.path.join(
-                library_inc, 'openjpeg-' + os.environ.get('openjpeg', '2.3')
+                os.environ['LIBRARY_INC'], 'openjpeg-' + os.environ.get('openjpeg', '2.3')
             )
         ]
+        EXTENSIONS['jpegxr']['include_dirs'] = [
+            os.path.join(os.environ['LIBRARY_INC'], 'jxrlib')
+        ]
         EXTENSIONS['jpegls']['libraries'] = ['charls-2-x64']
         EXTENSIONS['lz4']['libraries'] = ['liblz4']
         EXTENSIONS['lzma']['libraries'] = ['liblzma']
@@ -306,7 +308,7 @@ def customize_build_cf(EXTENSIONS, OPTIONS):
         customize_build = customize_build_cg
     elif os.environ.get('LD_LIBRARY_PATH', os.environ.get('LIBRARY_PATH', '')):
         customize_build = customize_build_ci
-    elif os.environ.get('LIBRARY_INC', ''):
+    elif os.environ.get('CONDA_BUILD', ''):
         customize_build = customize_build_cf
     else:
         customize_build = customize_build_default
