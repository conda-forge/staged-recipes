From 94e75ee4bb58605dcb7c86ef53c1250af342ac1f Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 4 Feb 2017 13:29:12 -0500
Subject: [PATCH 22/41] Use conda's pandoc when CONDA_BUILD

---
 dependencies/windows/install-dependencies.cmd  | 18 ++++++++++--------
 .../include/session/SessionConstants.hpp       |  6 +++++-
 2 files changed, 15 insertions(+), 9 deletions(-)

diff --git a/dependencies/windows/install-dependencies.cmd b/dependencies/windows/install-dependencies.cmd
index d14261ea9f..f91582901f 100644
--- a/dependencies/windows/install-dependencies.cmd
+++ b/dependencies/windows/install-dependencies.cmd
@@ -128,14 +128,16 @@ if not exist "mathjax-27" (
   )
 )
 
-if not exist pandoc\%PANDOC_VERSION% (
-  wget %WGET_ARGS% "%BASEURL%pandoc/%PANDOC_VERSION%/%PANDOC_FILE%"
-  echo Unzipping %PANDOC_FILE%
-  unzip %UNZIP_ARGS% "%PANDOC_FILE%"
-  mkdir pandoc\%PANDOC_VERSION%
-  copy "%PANDOC_NAME%\pandoc*" "pandoc\%PANDOC_VERSION%""
-  del %PANDOC_FILE%
-  rmdir /s /q %PANDOC_NAME%
+if not "%CONDA_BUILD%" == "1" (
+  if not exist pandoc\%PANDOC_VERSION% (
+    wget %WGET_ARGS% "%BASEURL%pandoc/%PANDOC_VERSION%/%PANDOC_FILE%"
+    echo Unzipping %PANDOC_FILE%
+    unzip %UNZIP_ARGS% "%PANDOC_FILE%"
+    mkdir pandoc\%PANDOC_VERSION%
+    copy "%PANDOC_NAME%\pandoc*" "pandoc\%PANDOC_VERSION%""
+    del %PANDOC_FILE%
+    rmdir /s /q %PANDOC_NAME%
+  )
 )
 
 if not exist libclang\%LIBCLANG_VERSION% (
diff --git a/src/cpp/session/include/session/SessionConstants.hpp b/src/cpp/session/include/session/SessionConstants.hpp
index 3abbedf37d..42c0399118 100644
--- a/src/cpp/session/include/session/SessionConstants.hpp
+++ b/src/cpp/session/include/session/SessionConstants.hpp
@@ -122,7 +122,11 @@
 #define kSessionTmpDir             "rstudio-rsession"
 
 #if !defined(CONDA_BUILD)
-#define kDefaultPandocPath         "bin/pandoc"
+#ifdef _WIN32
+  #define kDefaultPandocPath       "../../Scripts/pandoc"
+#else
+  #define kDefaultPandocPath       "bin/pandoc"
+#endif
 #define kDefaultPostbackPath       "bin/postback/rpostback"
 #define kDefaultRsclangPath        "bin/rsclang"
 #define kDefaultDiagnosticsPath    "bin/diagnostics"
-- 
2.29.2.windows.3

