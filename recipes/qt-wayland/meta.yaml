{% set version = "5.15.8" %}

package:
  name: qt-wayland
  version: {{ version }}

source:
  url: https://download.qt.io/official_releases/qt/{{ version.rpartition('.')[0] }}/{{ version }}/submodules/qtwayland-everywhere-opensource-src-{{ version }}.tar.xz
  sha256: fa0e7bd40f5da2d30fbdb51a436c5776950d6bd070b61a8d62d85cb537934529
  patches:
    # Get most of these patches from KDE (who's developers really care about
    # good qt operation)
    # By looking at
    # https://invent.kde.org/qt/qt/qtwayland/-/commits/5.15/
    # https://invent.kde.org/qt/qt/qtwayland/-/commits/kde/5.15/
    # https://invent.kde.org/qt/qt/qtwayland/-/compare/5.15...kde%2F5.15
    # Checkout, update both branches
    #     git checkout 5.15 && git pull
    #     git checkout kde/5.15 && git pull
    #     git format-patch 5.15
    - kde_patches/0001-Client-Announce-an-output-after-receiving-more-compl.patch
    - kde_patches/0002-Fix-issue-with-repeated-window-size-changes.patch
    - kde_patches/0003-Client-Connect-drags-being-accepted-to-updating-the-.patch
    - kde_patches/0004-Client-Disconnect-registry-listener-on-destruction.patch
    - kde_patches/0005-Client-Set-XdgShell-size-hints-before-the-first-comm.patch
    - kde_patches/0006-Fix-build.patch
    - kde_patches/0007-Fix-remove-listener.patch
    - kde_patches/0008-Hook-up-queryKeyboardModifers.patch
    - kde_patches/0009-Correctly-detect-if-image-format-is-supported-by-QIm.patch
    - kde_patches/0010-Client-Don-t-always-recreate-frame-callbacks.patch
    - kde_patches/0011-Client-Always-destroy-frame-callback-in-the-actual-c.patch
    - kde_patches/0012-Wayland-client-use-wl_keyboard-to-determine-active-s.patch
    - kde_patches/0013-Client-do-not-empty-clipboard-when-a-new-popup-windo.patch
    - kde_patches/0014-Set-preedit-cursor-when-cursor-equals-to-0.patch
    - kde_patches/0015-Client-Implement-DataDeviceV3.patch
    - kde_patches/0016-Client-Delay-deletion-of-QDrag-object-until-after-we.patch
    - kde_patches/0017-Client-Avoid-processing-of-events-when-showing-windo.patch
    - kde_patches/0018-Handle-registry_global-out-of-constructor.patch
    - kde_patches/0019-Connect-flushRequest-after-forceRoundTrip.patch
    - kde_patches/0020-Move-the-wayland-socket-polling-to-a-separate-event-.patch
    - kde_patches/0021-Fix-crash-if-no-input-method-module-could-be-loaded.patch
    - kde_patches/0022-Client-Remove-mWaitingForUpdateDelivery.patch
    - kde_patches/0023-Cursor-position-0-should-still-show-the-cursor.patch
    - kde_patches/0024-Update-the-preedit-styling-mapping.patch
    - kde_patches/0025-client-Simplify-round-trip-behavior.patch
    - kde_patches/0026-Client-Fix-opaque-region-setter.patch
    - kde_patches/0027-Use-proper-dependencies-in-compile-tests.patch
    - kde_patches/0028-client-update-button-state-and-etc-in-pointer_leave.patch
    - kde_patches/0029-Revert-Client-Remove-mWaitingForUpdateDelivery.patch
    - kde_patches/0030-Fix-race-condition-on-mWaitingForUpdateDelivery.patch
    - kde_patches/0031-use-poll-2-when-reading-from-clipboard.patch
    - kde_patches/0032-Reduce-memory-leakage.patch
    - kde_patches/0033-Fix-build-with-libcxx-missing-array-include.patch
    - kde_patches/0034-Only-close-popup-in-the-the-hierchary.patch
    - kde_patches/0035-Build-fixes-for-GCC-11.patch
    - kde_patches/0036-Check-pointer-for-null-before-use-in-ASSERT.patch
    - kde_patches/0037-Use-wl_surface.damage_buffer-on-the-client-side.patch
    - kde_patches/0038-Client-clear-focus-on-touch-cancel.patch
    - kde_patches/0039-Guard-mResizeDirty-by-the-correctMutex.patch
    - kde_patches/0040-client-Synthesize-enter-leave-event-for-popup-in-xdg.patch
    - kde_patches/0041-Fix-compile-tests.patch
    - kde_patches/0042-Use-CRLF-line-delimiter-for-text-uri-list-data.patch
    - kde_patches/0043-Fix-missing-update-when-toggling-client-side-decorat.patch
    - kde_patches/0044-Avoid-calling-requestUpdate-from-wrong-thread.patch
    - kde_patches/0045-Client-support-high-dpi-mode-for-window-icon.patch
    - kde_patches/0046-Call-finishDrag-in-QWaylandDataDevice-dragSourceCanc.patch
    - kde_patches/0047-Hold-surface-read-lock-throughout-QWaylandEglWindow-.patch
    - kde_patches/0048-Client-Ensure-that-wl_surface-lives-as-long-as-qtqui.patch
    - kde_patches/0049-Keep-toplevel-windows-in-the-top-left-corner-of-the-.patch
    - kde_patches/0050-Revert-Client-Ensure-that-wl_surface-lives-as-long-a.patch
    - kde_patches/0051-Client-Add-F_SEAL_SHRINK-seal-to-shm-backing-file.patch
    - kde_patches/0052-Client-Call-wl_output_release-upon-QWaylandScreen-de.patch
    - kde_patches/0053-Client-Bump-wl_output-version.patch
    - kde_patches/0054-Fix-frame-sync-related-to-unprotected-multithread-ac.patch
    - kde_patches/0055-Client-Handle-zwp_primary_selection_device_manager_v.patch
    - kde_patches/0056-Fixes-the-build-on-CentOS.patch
    - kde_patches/0057-client-Avoid-protocol-error-with-invalid-min-max-siz.patch
    - kde_patches/0058-Client-Fix-handling-of-Qt-BlankCursor.patch

build:
  skip: true   # [not linux]
  number: 1
  detect_binary_files_with_prefix: true
  run_exports:
    - {{ pin_subpackage('qt-wayland', max_pin='x.x') }}

requirements:
  build:
    - perl
    - make
    - {{ compiler('cxx') }}
    - {{ compiler('c') }}
    - qt-main                            # [build_platform != target_platform]
    - sysroot_linux-64 2.17              # [linux]
    - {{ cdt('mesa-libgl-devel') }}      # [linux]
    - {{ cdt('mesa-libegl') }}           # [linux]
    - {{ cdt('mesa-libegl-devel') }}     # [linux]
    - {{ cdt('mesa-dri-drivers') }}      # [linux]
    - {{ cdt('libdrm-devel') }}          # [linux]
    - {{ cdt('libglvnd-glx') }}          # [linux]
    - {{ cdt('libglvnd-egl') }}          # [linux]
  host:
    - qt-main  {{ version }}
    - libxkbcommon
    - xorg-libx11
    - xorg-libxext
    - xorg-libxrandr
    - wayland
    - fontconfig
    - freetype
    - zlib
    - glib
  run:
    # https://github.com/conda-forge/xorg-libxext-feedstock/pull/12
    - xorg-libxext
    # https://github.com/conda-forge/xorg-libx11-feedstock/pull/28
    - xorg-libx11

test:
  commands:
    {% set qt_libs = ["WaylandClient", "WaylandCompositor"] %}
    {% for each_qt_lib in qt_libs %}
    - test -d $PREFIX/include/qt/Qt{{ each_qt_lib }}  # [unix]
    - test -f $PREFIX/lib/libQt5{{ each_qt_lib }}${SHLIB_EXT}  # [unix]
    {% endfor %}

about:
  home: http://qt-project.org
  license: LGPL-3.0-only
  license_file:
    -  LICENSE.FDL
    -  LICENSE.GPL2
    -  LICENSE.GPL3
    -  LICENSE.GPL3-EXCEPT
    -  LICENSE.LGPL3
  summary: QtWayland module
  description: |
    The QtWayland module consists of two parts.

    Wayland platform plugin --
        Enables Qt applications to be run as Wayland clients.

    QtWaylandCompositor API --
        Enables the creation of Wayland compositors using Qt and QtQuick.
  doc_url: https://wiki.qt.io/QtWayland
  dev_url: https://github.com/qt/qtwayland/tree/5.15

extra:
  recipe-maintainers:
    # - jschueller  # ask first
    - hmaarrfk
    # Add all of qt-main?
    # - conda-forge/qt-main
  feedstock-name: qt-wayland
