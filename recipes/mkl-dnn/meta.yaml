{% set version = "0.17.2" %}

package:
  name: mkl-dnn
  version: {{ version }}

source:
  url: https://github.com/intel/mkl-dnn/archive/v{{ version }}.tar.gz
  fn: mkl-dnn-{{ version }}.tar.gz
  sha256: 56c3e22d4fad816059cc58fd8e78ab3bacbec76a6bbded7eaead66220d8e5134
  patches:
    # https://github.com/intel/mkl-dnn/pull/346
    - 346-unify-install-command.patch


{% set cmake_install_prefix=LIBRARY_PREFIX %}  # [win]
{% set cmake_install_prefix=PREFIX %}          # [unix]

build:
  skip: true  # [win and vc<14]
  # Why do I have to skip windows 32? Conda forge builds this?
  skip: true  # [win32]
  number: 0
  script:
    # they are ignoring the array-bounds warning, but it doesn't seem to be working
    # #if defined(__GNUC__) && __GNUC__ >= 4
    # /* GCC produces bogus array subscript is above array bounds warning for
    #  * the `p.nodes[j - 1] = p.nodes[j]` line below, so disable it for now. */
    # #pragma GCC diagnostic push
    # #pragma GCC diagnostic ignored "-Warray-bounds"
    # #endif
    - export CFLAGS="-Wno-error=array-bounds -Wno-array-bounds ${CFLAGS} -Wno-array-bounds -Wno-error=array-bounds"  # [unix]
    - mkdir build
    - cd build
    - cmake -LAH -G "Ninja" -DWITH_TEST=0 -DCMAKE_BUILD_TYPE="Release" -DCMAKE_INSTALL_PREFIX={{ cmake_install_prefix }} ..
    - ninja install -v   # [unix]
    - cmake --build . --target install  --config Release  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - cmake
    - make  # [unix]
    - ninja
  host:
    - openmp
  # run:

test:
  commands:
    - if not exist %PREFIX%\\Library\\include\\mkldnn.h exit 1             # [win]
    - if not exist %PREFIX%\\Library\\include\\mkldnn.hpp exit 1           # [win]
    - if not exist %PREFIX%\\Library\\include\\mkldnn_debug.h exit 1       # [win]
    - if not exist %PREFIX%\\Library\\include\\mkldnn_types.h exit 1       # [win]
    - if not exist %PREFIX%\\Library\\lib\\mkldnn.lib exit 1               # [win]
    - if not exist %PREFIX%\\Library\\bin\\mkldnn.dll exit 1               # [win]


about:
  home: https://01.org/mkl-dnn
  license: Apache-2.0
  license_family: Apache
  license_file: LICENSE
  summary: 'Aperformance library for deep-learning applications. The library accelerates deep-learning applications and frameworks on Intel architecture.'
  dev_url: https://github.com/intel/mkl-dnn/tree/master

extra:
  recipe-maintainers:
    - hmaarrfk
    - sodre
