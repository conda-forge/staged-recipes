{% set name = "lbr-fri-client-sdk" %}
{% set version = "1.15" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/lbr-stack/fri/archive/refs/heads/fri-{{ version }}.tar.gz
  sha256: 9bb4578864a8c92c28a798860e2d43c25b9d94841aa7527e40884c2899ce939c

build:
  number: 0
  script: |
    python - <<'PY'  # [not win]
    import zipfile

    with zipfile.ZipFile("FRI-Client-SDK_Cpp.zip") as zf:
        data = zf.read("doc/html/index.html")
    text = data.decode("utf-8", errors="ignore")
    start = text.find("The following license terms and conditions apply")
    end = text.find("DISCLAIMER OF WARRANTY")
    if start == -1 or end == -1:
        raise SystemExit("KUKA license block not found in doc/html/index.html")
    license_block = text[start:end].strip()
    with open("LICENSE-KUKA-Sunrise-Connectivity-FRI-Client-SDK.txt", "w", encoding="utf-8") as f:
        f.write(license_block + "\n")
    PY
    python -c "import zipfile; data=zipfile.ZipFile('FRI-Client-SDK_Cpp.zip').read('doc/html/index.html'); text=data.decode('utf-8', errors='ignore'); start=text.find('The following license terms and conditions apply'); end=text.find('DISCLAIMER OF WARRANTY');\nimport sys\n\nif start==-1 or end==-1: sys.exit('KUKA license block not found in doc/html/index.html'); license_block=text[start:end].strip(); open('LICENSE-KUKA-Sunrise-Connectivity-FRI-Client-SDK.txt','w',encoding='utf-8').write(license_block+'\\n')"  # [win]
    cmake -S . -B build -GNinja ${CMAKE_ARGS} -DCMAKE_BUILD_TYPE=Release
    cmake --build build
    cmake --install build
    if exist build\\FRIClient.dll copy /Y build\\FRIClient.dll %LIBRARY_BIN%\\  # [win]
    if exist build\\Release\\FRIClient.dll copy /Y build\\Release\\FRIClient.dll %LIBRARY_BIN%\\  # [win]
    if exist build\\FRIClient.lib copy /Y build\\FRIClient.lib %LIBRARY_LIB%\\  # [win]
    if exist build\\Release\\FRIClient.lib copy /Y build\\Release\\FRIClient.lib %LIBRARY_LIB%\\  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    - cmake >=3.18
    - ninja
    - python

test:
  commands:
    - test -f $PREFIX/lib/libFRIClient*  # [unix]
    - test -f $PREFIX/include/friClientIf.h  # [unix]
    - if exist %LIBRARY_BIN%\\FRIClient.dll (exit 0) else (exit 1)  # [win]
    - if exist %LIBRARY_INC%\\friClientIf.h (exit 0) else (exit 1)  # [win]

about:
  home: https://github.com/lbr-stack/fri
  summary: CMake support for KUKA Fast Robot Interface (FRI) client SDK
  description: |
    Adds CMake build support for KUKA's Fast Robot Interface (FRI) client SDK.
    The SDK is bundled in the repository as FRI-Client-SDK_Cpp.zip.
  license: Apache-2.0 AND LicenseRef-KUKA-Sunrise-Connectivity-FRI-Client-SDK
  license_file:
    - LICENSE
    - NOTICE
    - LICENSE-KUKA-Sunrise-Connectivity-FRI-Client-SDK.txt

extra:
  recipe-maintainers:
    - kenichi-maeda
