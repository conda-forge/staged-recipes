context:
  version: "0.28.0"

package:
  name: cern-sso-cli
  version: ${{ version }}

source:
  url: https://github.com/clelange/cern-sso-cli/archive/refs/tags/v${{ version }}.tar.gz
  sha256: a36770129fb7a033fd49783f7b4748be4e3b3636340865ea4e0be671ffcecfc6
  target_directory: src

build:
  number: 0
  skip:
    - not linux
  script:
    - cd src
    - go-licenses save . --save_path ../library_licenses
    - go build -v -o $PREFIX/bin/cern-sso-cli -ldflags="-X main.version=${{ version }} -s -w"
    - chmod -R u+w $(go env GOPATH) && rm -r $(go env GOPATH)
    - export CERN_SSO_CLI=$PREFIX/bin/cern-sso-cli
    # Set library path so the binary can find libfido2 at build time
    - export LD_LIBRARY_PATH=${PREFIX}/lib:${LD_LIBRARY_PATH:-}
    # Install bash, zsh, and fish completions
    - mkdir -p ${PREFIX}/share/bash-completion/completions
    - ${CERN_SSO_CLI} completion bash > ${PREFIX}/share/bash-completion/completions/cern-sso-cli.bash
    - mkdir -p ${PREFIX}/share/zsh/site-functions
    - ${CERN_SSO_CLI} completion zsh > ${PREFIX}/share/zsh/site-functions/_cern-sso-cli
    - mkdir -p ${PREFIX}/share/fish/vendor_completions.d
    - ${CERN_SSO_CLI} completion fish > ${PREFIX}/share/fish/vendor_completions.d/cern-sso-cli.fish
requirements:
  build:
    - ${{ compiler('go-cgo') }}
    - ${{ compiler('c') }}
    - ${{ stdlib('c') }}
    - go-licenses
    - pkg-config
  host:
    - libfido2
    - libudev
  
  run:
    - libfido2

tests:
  - script:
      - cern-sso-cli --help
      - cern-sso-cli --version
  - package_contents:
      bin:
        - cern-sso-cli
      files:
        - share/bash-completion/completions/cern-sso-cli.bash
        - share/zsh/site-functions/_cern-sso-cli
        - share/fish/vendor_completions.d/cern-sso-cli.fish
      strict: true

about:
  homepage: https://github.com/clelange/cern-sso-cli
  summary: Go implementation of CERN SSO authentication tools
  description: |
    A Go implementation of CERN SSO authentication tools. This is Go equivalent
    of auth-get-sso-cookie. Features include SSO session cookie management, OIDC token
    acquisition, 2FA support (OTP & WebAuthn/YubiKey), and shell completion.
  license: GPL-3.0-or-later
  license_file:
    - src/LICENSE
    - library_licenses/
  documentation: https://pkg.go.dev/github.com/clelange/cern-sso-cli
  repository: https://github.com/clelange/cern-sso-cli

extra:
  recipe-maintainers:
    - clelange
