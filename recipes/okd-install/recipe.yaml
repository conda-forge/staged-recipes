schema_version: 1

context:
  name: "openshift-installer"
  version: "4.19.15"

package:
  name: okd-install
  version: ${{ version }}

source:
  url: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${{ version }}/${{ name }}-src.tar.gz
  sha256: d4c19a4f3c438535bf69c727f85ff4eea1395325d78a8a0e6bf0b554b6102a3b

build:
  number: 0
  script:
    - if: target_platform in ("linux-aarch64", "osx-arm64", "osx-64", "win-64")
      then:
        - if: unix
          then:
            - export CGO_ENABLED=0
        - if: win
          then:
            - set "CGO_ENABLED=0"
    - if: unix
      then:
        - export PATH=$BUILD_PREFIX/bin:$BUILD_PREFIX/go/bin:$PATH
        - unset LDFLAGS
        - unset CPPFLAGS
        - unset CFLAGS
        - unset CXXFLAGS
        - export SOURCE_GIT_COMMIT="${{ version }}"
        - export BUILD_VERSION="${{ version }}"
        - TAGS="include_gcs include_oss containers_image_openpgp" OUTPUT="openshift-installer" hack/build.sh
        - go-licenses csv ./cmd/openshift-installer > licenses.csv || touch licenses.csv
        - go-licenses save ./cmd/openshift-installer --save_path=licenses/ || mkdir -p licenses
        - mkdir -p $PREFIX/bin/
        - cp openshift-installer $PREFIX/bin/
        - cp openshift-installer $PREFIX/bin/okd-install
    - if: win
      then:
        - set "PATH=%BUILD_PREFIX%\bin;%BUILD_PREFIX%\go\bin;%PATH%"
        - set "LDFLAGS="
        - set "CPPFLAGS="
        - set "CFLAGS="
        - set "CXXFLAGS="
        - set "SOURCE_GIT_COMMIT=${{ version }}"
        - set "BUILD_VERSION=${{ version }}"
        - set "TAGS=include_gcs include_oss containers_image_openpgp"
        - set "OUTPUT=openshift-installer"
        - dir /b
        - if exist installer-${{ version }} cd installer-${{ version }}
        - if exist openshift-installer-${{ version }} cd openshift-installer-${{ version }}
        - if exist openshift-installer cd openshift-installer
        - if exist installer cd installer
        - dir cmd 2>nul || echo cmd directory not found at current level
        - go build -tags "%TAGS%" -ldflags "-X github.com/openshift/installer/pkg/version.Raw=%BUILD_VERSION% -X github.com/openshift/installer/pkg/version.Commit=%SOURCE_GIT_COMMIT%" -o "%OUTPUT%.exe" .\cmd\openshift-installer
        - go-licenses csv .\cmd\openshift-installer > licenses.csv 2>nul || type nul > licenses.csv
        - go-licenses save .\cmd\openshift-installer --save_path=licenses\ 2>nul || mkdir licenses
        - if not exist "%PREFIX%\bin" mkdir "%PREFIX%\bin"
        - copy "%OUTPUT%.exe" "%PREFIX%\bin\"
        - copy "%OUTPUT%.exe" "%PREFIX%\bin\okd-install.exe"

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
    - if: build_platform != target_platform
      then:
        - ${{ stdlib('c') }}
    - ${{ compiler('go-nocgo') }} >=1.15.2
    - go-licenses >=2.0.1
    - make >=4.0
    - git >=2.0
    - krb5 >=1.21
    - pkg-config >=0.29
    - if: unix
      then:
        - zip >=3.0
    - if: win
      then:
        - m2-zip >=3.0.3

tests:
  - package_contents:
      bin:
        - openshift-installer
        - okd-install
  - script:
      - okd-install --help

about:
  homepage: https://www.okd.io/
  summary: OpenShift Installer Console Application
  description: |
    The OpenShift Installer is the command-line utility used to deploy and
    install Red Hat OpenShift Container Platform on various cloud providers
    (like AWS, Azure, Google Cloud) or
    on-premises infrastructure (like vSphere or bare metal).
    It is the primary tool that takes a set of configuration parameters and
    transforms them into a fully operational OpenShift cluster.
  license: Apache-2.0
  license_file: LICENSE
  repository: https://github.com/openshift/installer
  documentation: https://docs.openshift.com/container-platform/latest/cli_reference/openshift_cli/getting-started-cli.html

extra:
  recipe-maintainers:
    - phreed
