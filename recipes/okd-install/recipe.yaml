schema_version: 1

context:
  name: "openshift-installer"
  version: "4.19.15"

package:
  name: okd-install
  version: ${{ version }}

source:
  url: https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${{ version }}/${{ name }}-src.tar.gz
  sha256: d4c19a4f3c438535bf69c727f85ff4eea1395325d78a8a0e6bf0b554b6102a3b

build:
  number: 0
  script: |
    # Use the existing build script from source
    export CGO_ENABLED=0
    export SOURCE_GIT_COMMIT=${{ version }}
    export BUILD_VERSION=${{ version }}
    export TAGS="include_gcs include_oss containers_image_openpgp"
    export OUTPUT="openshift-install"

    # Clear LDFLAGS to avoid passing GNU linker flags to Go linker
    # Since CGO_ENABLED=0, external linker flags are not needed
    unset LDFLAGS

    # Build the installer
    ./hack/build.sh

    # Generate license information
    go-licenses csv ./cmd/openshift-install > licenses.csv || echo "Warning: go-licenses csv failed"
    go-licenses save ./cmd/openshift-install --save_path licenses || mkdir -p licenses

    # Install binaries
    mkdir -p $PREFIX/bin
    cp bin/openshift-install $PREFIX/bin/
    cp bin/openshift-install $PREFIX/bin/okd-install
  skip:
    - win

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
    - if: build_platform != target_platform
      then:
        - ${{ stdlib('c') }}
    - ${{ compiler('go-nocgo') }} >=1.15.2
    - go-licenses >=2.0.1
    - git >=2.0
    - krb5 >=1.21
    - pkg-config >=0.29
    - zip >=3.0
    - tar >=1.35
    - make >=4.0

tests:
  - package_contents:
      bin:
        - openshift-install
        - okd-install
  - script:
      - okd-install --help

about:
  homepage: https://www.okd.io/
  summary: OpenShift Installer Console Application
  description: |
    The OpenShift Installer is the command-line utility used to deploy and
    install Red Hat OpenShift Container Platform on various cloud providers
    (like AWS, Azure, Google Cloud) or
    on-premises infrastructure (like vSphere or bare metal).
    It is the primary tool that takes a set of configuration parameters and
    transforms them into a fully operational OpenShift cluster.
  license: Apache-2.0
  license_file: LICENSE
  repository: https://github.com/openshift/installer
  documentation: https://docs.openshift.com/container-platform/latest/cli_reference/openshift_cli/getting-started-cli.html

extra:
  recipe-maintainers:
    - phreed
