From 96c6f577bf88442ebd8685870dc891424aac6055 Mon Sep 17 00:00:00 2001
From: Agriya Khetarpal <74401230+agriyakhetarpal@users.noreply.github.com>
Date: Tue, 18 Feb 2025 20:29:14 +0530
Subject: [PATCH] Find KLU

Co-Authored-By: Pradyot Ranjan <99216956+prady0t@users.noreply.github.com>
---
 0001-Find-KLU.patch | 39 +++++++++++++++++++++++++++++++++++++++
 setup.py            |  9 ++++++---
 2 files changed, 45 insertions(+), 3 deletions(-)
 create mode 100644 0001-Find-KLU.patch

diff --git a/0001-Find-KLU.patch b/0001-Find-KLU.patch
new file mode 100644
index 0000000..5b9eda7
--- /dev/null
+++ b/0001-Find-KLU.patch
@@ -0,0 +1,39 @@
+From 9ed1ad921adc326c3770d20102bc8a76fd64a6cc Mon Sep 17 00:00:00 2001
+From: Agriya Khetarpal <74401230+agriyakhetarpal@users.noreply.github.com>
+Date: Tue, 18 Feb 2025 20:29:14 +0530
+Subject: [PATCH] Find KLU
+
+---
+ setup.py | 9 ++++++---
+ 1 file changed, 6 insertions(+), 3 deletions(-)
+
+diff --git a/setup.py b/setup.py
+index 65e3e6c..d02dcb5 100644
+--- a/setup.py
++++ b/setup.py
+@@ -11,9 +11,9 @@ from setuptools.command.install import install
+ from setuptools.command.build_ext import build_ext
+ 
+ 
+-default_lib_dir = (
+-    "" if system() == "Windows" else str(Path(__file__).parent.resolve() / ".idaklu")
+-)
++default_lib_dir = str(Path(os.environ["PREFIX"]) / "lib")
++os.environ["KLU_INCLUDE_DIR"] = str(Path(os.environ["PREFIX"]) / "include")
++
+ 
+ # ---------- set environment variables for vcpkg on Windows ----------------------------
+ 
+@@ -104,6 +104,9 @@ class CMakeBuild(build_ext):
+             cmake_args.append(
+                 f"-DSuiteSparse_ROOT={os.path.abspath(self.suitesparse_root)}"
+             )
++            cmake_args.append(
++                f"-DKLU_INCLUDE_DIR={os.environ.get('KLU_INCLUDE_DIR', '')}"
++            )
+         if self.sundials_root:
+             cmake_args.append(f"-DSUNDIALS_ROOT={os.path.abspath(self.sundials_root)}")
+ 
+-- 
+2.47.1
+
diff --git a/setup.py b/setup.py
index 65e3e6c..d02dcb5 100644
--- a/setup.py
+++ b/setup.py
@@ -11,9 +11,9 @@ from setuptools.command.install import install
 from setuptools.command.build_ext import build_ext
 
 
-default_lib_dir = (
-    "" if system() == "Windows" else str(Path(__file__).parent.resolve() / ".idaklu")
-)
+default_lib_dir = str(Path(os.environ["PREFIX"]) / ".idaklu")
+os.environ["KLU_INCLUDE_DIR"] = str(Path(os.environ["PREFIX"]) / "include")
+
 
 # ---------- set environment variables for vcpkg on Windows ----------------------------
 
@@ -104,6 +104,9 @@ class CMakeBuild(build_ext):
             cmake_args.append(
                 f"-DSuiteSparse_ROOT={os.path.abspath(self.suitesparse_root)}"
             )
+            cmake_args.append(
+                f"-DKLU_INCLUDE_DIR={os.environ.get('KLU_INCLUDE_DIR', '')}"
+            )
         if self.sundials_root:
             cmake_args.append(f"-DSUNDIALS_ROOT={os.path.abspath(self.sundials_root)}")
 
-- 
2.47.1
