{% set name = "Blender" %}
{% set version = "3.0.0" %}
{% set version_small = "3.0" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  - url: https://github.com/blender/blender/archive/refs/tags/v{{ version }}.zip
    sha256: beeabced855f17ec60aa1087e5e93c021c3edd26e01826ad153d631752b02b13
    patches:
      - 001_remove_ranlib_args.patch
  - url: https://github.com/blender/blender-addons/archive/refs/tags/v{{ version }}.zip
    folder: release/scripts/addons
    sha256: 725c2d00a3e26eb6194c790602e632df3d77414d2eb266eb6b75025e01c4d103
  - url: https://github.com/blender/blender-translations/archive/refs/tags/v{{ version }}.zip
    folder: release/datafiles/locale
    sha256: c7fc387cd8225e6db6ff224412c28f00c63474dae49dd5e78ebadcc1c3fd4614
  - url: https://github.com/matter-it-does/blender_svn/releases/download/{{ version }}/darwin.zip  # [osx and x86]
    folder: ../lib/darwin                                                                          # [osx and x86]
    sha256: eee84f6aad9127a0957b7268774231578d87fa324a3527eef573b19317cbce44                       # [osx and x86]
  - url: https://github.com/matter-it-does/blender_svn/releases/download/{{ version }}/linux_centos7_x86_64.zip  # [linux64]
    folder: ../lib/linux_centos7_x86_64                                                                          # [linux64]
    sha256: 40b943c1e9dd5a0f232cb0cd6ade31fa622f0cdef5d8c75018828932d49a3c86                                     # [linux64]

build:
  # osx is in another PR.
  skip: True  # [not (linux and cdt_name == 'cos7')]
  number: 0
  script:
    - set -ex                                                                             # [unix]
    - export BUILD_DIR="${SRC_DIR}/../bl_build_folder"                                    # [osx]
    - export BUILD_CMAKE_ARGS="-DWITH_INSTALL_PORTABLE=0 -DCMAKE_INSTALL_PREFIX=$PREFIX"  # [linux]
    - make ninja                                                                          # [unix]
    - mkdir -p "${PREFIX}/bin/"                                                           # [osx]
    - cp -f -R "${BUILD_DIR}/bin/Blender.app/" "${PREFIX}/bin/Blender.app"                # [osx]
    - ln -sf "${PREFIX}/bin/Blender.app/Contents/MacOS/Blender" "${PREFIX}/bin/Blender"   # [osx]
    - ln -sf "${PREFIX}/bin/Blender.app/Contents/Resources" "${PREFIX}/Resources"         # [osx]
    - $BUILD_PREFIX/bin/x86_64-conda-linux-gnu-objdump -p $PREFIX/bin/blender             # [linux]
  missing_dso_whitelist:
    - /usr/lib/libSystem.B.dylib                                                          # [osx]
    - /usr/local/opt/gdbm/lib/libgdbm.6.dylib                                             # [osx]
    - /usr/lib/libedit.3.dylib                                                            # [osx]
    - /usr/lib/libncurses.5.4.dylib                                                       # [osx]
    - /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation       # [osx]
    # Tests can confirm what's missing.
    - "*"                                                                                 # [linux]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - make
    - cmake
    - ninja
    - sysroot_linux-64 2.17                 # [linux]
    - {{ cdt('libx11-devel') }}             # [linux]
    - {{ cdt('xorg-x11-proto-devel') }}     # [linux]
    - {{ cdt('libxxf86vm') }}               # [linux]
    - {{ cdt('libxxf86vm-devel') }}         # [linux]
    - {{ cdt('libxi-devel') }}              # [linux]
    - {{ cdt('libxext-devel') }}            # [linux]
    - {{ cdt('libxcursor-devel') }}         # [linux]
    - {{ cdt('libxrandr-devel') }}          # [linux]
    - {{ cdt('libxinerama-devel') }}        # [linux]
    - {{ cdt('libxfixes-devel') }}          # [linux]
    - {{ cdt('mesa-libgl-devel') }}         # [linux]
    - {{ cdt('mesa-dri-drivers') }}         # [linux]
    - {{ cdt('libselinux') }}               # [linux]
    - {{ cdt('libxdamage') }}               # [linux]
    - {{ cdt('libxrender-devel') }}         # [linux]
    - glew                                  # [linux]
    # - xorg-libxrender                       # [linux]
  host:
    - xorg-libxfixes             # [linux]
    - xorg-libxi                 # [linux]
    - _openmp_mutex              # [linux]
    - ncurses                    # [linux]
    - libnsl                     # [linux]
    # - glib                       # [linux]
    - magic-wormhole
  run:
    - xorg-libxfixes             # [linux]
    - xorg-libxi                 # [linux]
    - _openmp_mutex              # [linux]
    - ncurses                    # [linux]
    - libnsl                     # [linux]
    - magic-wormhole

test:
  commands:
    - Blender --version     # [osx]
    - Blender --help        # [osx]
    - wormhole send /home/conda/staged-recipes/build_artifacts/linux-64/blender-3.0.0-h70efa2d_0.tar.bz2     # [linux]
    - blender --help        # [linux]

about:
  home: https://blender.org
  license: GPL-3.0-or-later
  license_file:
    - release/license/
  license_family: GPL
  summary: Blender is the cross platform, free and open source 3D creation suite.
  description: |
    It supports the entirety of the 3D pipeline—modeling, rigging, animation, simulation, rendering, compositing and motion tracking, even video editing and game creation. Advanced users employ Blender’s API for Python scripting to customize the application and write specialized tools; often these are included in Blender’s future releases.
  doc_url: https://docs.blender.org/manual/

extra:
  recipe-maintainers:
    - matter-it-does
