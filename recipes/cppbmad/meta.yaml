{% set name = "cppbmad" %}
{% set version = "20260108-0" %}
{% set dot_version = version | replace("-", ".") %}
{% set build = 0 %}

{% set mpi = mpi or 'nompi' %}

{% if mpi == 'nompi' %}
# prioritize nompi variant via build number
{% set build = build + 100 %}
{% endif %}

{% if mpi != 'nompi' %}
{% set mpi_prefix = "mpi_" + mpi %}
{% else %}
{% set mpi_prefix = "nompi" %}
{% endif %}

package:
  name: {{ name }}-split
  version: {{ dot_version }}

source:
  - url: https://github.com/ken-lauer/cppbmad/archive/{{ version }}.tar.gz
    sha256: 6b24bf6fea17a4e1cc025989ebb1279e6bc9e9be2393e573735d007556ec8ae3

build:
  number: {{ build }}
  skip: true  # [win] 

requirements:
  build:
    - {{ compiler("cxx") }}
    - {{ compiler("fortran") }}
    - {{ stdlib("c") }}
    - cmake
    - make
  host:
    - bmad {{ dot_version }} {{ mpi_prefix }}*
    - {{ mpi }}  # [mpi != 'nompi']
    - python
    - pybind11
    - pybind11-stubgen

outputs:
  - name: cppbmad
    build:
      # script: build_cppbmad.sh
      string: "{{ mpi_prefix }}_h{{ PKG_HASH }}_{{ build }}"
      run_exports:
        - {{ pin_subpackage('cppbmad', max_pin="x.x") }}
      ignore_run_exports:
        - python  # cppbmad is independent of Python
    files:
      - include/bmad.hpp
      - include/bmad/
      - lib/libcppbmad*
      - lib/cmake/cppbmad
    requirements:
      run:
        - {{ pin_compatible('bmad', exact=True) }}
        - {{ mpi }}  # [mpi != 'nompi']
        - libgcc     # [osx]
    test:
      commands:
        - test -f $PREFIX/lib/libcppbmad${SHLIB_EXT}
        - test -f $PREFIX/include/bmad.hpp
        - bash test_cppbmad_build.sh

  - name: pybmad
    build:
      # script: build_pybmad.sh
      string: "{{ mpi_prefix }}_py{{ python | replace('.', '') }}_h{{ PKG_HASH }}_{{ build }}"
    files:
      - {{ SP_DIR }}/pybmad
    requirements:
      run:
        - python
        - {{ mpi }}  # [mpi != 'nompi']
        - {{ pin_subpackage('cppbmad', max_pin="x.x") }}
    test:
      imports:
        - pybmad

about:
  home: github.com/ken-lauer/cppbmad
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE
  summary: cppbmad and pybmad are wrappers for Bmad, a relativistic charged-particle dynamics simulations in accelerators and storage rings.
  description: |
    cppbmad wraps the original Fortran Bmad with convenient, modern C++ proxy classes
    of the Fortran-allocated data. Many procedures are supported as well, allowing
    for coordinating tracking and other simulations through C++.
    pybmad wraps cppbmad with pybind11, further bringing the lower-level capabilities
    of Bmad-ecosystem (including Tao) to Python.
  doc_url: https://github.com/ken-lauer/cppbmad/wiki

extra:
  feedstock-name: cppbmad
  recipe-maintainers:
    - ken-lauer
