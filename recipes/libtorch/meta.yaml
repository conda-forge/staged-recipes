{% set version = "2.1.0" %}
{% set mkl = "2022" %}


package:
  name: libtorch
  version: {{ version }}

source:
  folder: pytorch
  url: https://github.com/pytorch/pytorch/archive/v{{ version }}.tar.gz
  sha256: 3f85b6d92cb78d940b1e894101496ea02639b46986bb4bc53cdb17ab155bdfaf
  patches:
    - 0001-Use-shared-libraries.patch
    # - 0002-Update-to-the-latest-XNNPACK-from-Nov-2023.patch

build:
  skip: true  # not just yet
  # You can probably build this for windows
  skip: true  # [win]
  number: 0
  run_exports:
    # 0 guarantees because they beleive in not creating real releases...
    # https://github.com/pytorch/qnnpack/issues/84
    - {{ pin_subpackage('libtorch', max_pin='x.x.x') }}

requirements:
  build:
    - sysroot_linux-64  2.17  # [linux64]
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    # - {{ compiler('cuda') }}    # [cuda_compiler_version != "None"]
    - libgomp        # [linux]
    - llvm-openmp    # [osx]
    - cmake
    - ninja
    - libprotobuf 4.24.4
    - protobuf
    - make      # [linux]
    - python 3.9.*=*cpython
    # needed for some code generation
    - typing_extensions
    - pyyaml
  host:
    # GPU requirements
    # - cudnn                           # [cuda_compiler_version != "None"]
    # - nccl                            # [cuda_compiler_version != "None"]
    # - magma                           # [cuda_compiler_version != "None"]
    # other requirements
    # hmaarrfk 2021/12/28
    # it seems that pytorch uses some aspects of setuptools
    # that were removed in version 59.6
    # I'm not really inclined to patch this out since
    # this is a pretty easy build time dependency
    # https://github.com/pytorch/pytorch/issues/69894
    - onednn
    - flatbuffers
    - mkl-devel {{ mkl }}   # [x86]
    - mkl {{ mkl }}         # [x86]
    - libblas 3.9 *_mkl     # [x86]
    - libblas 3.9           # [not x86]
    - libblas               # [not x86]
    - liblapack             # [not x86]
    - openblas              # [not x86]
    - libprotobuf 4.24.4
    - cpuinfo
    - sleef
    # Don't have these builds of gloo yet
    - gloo
    - fp16
    - pybind11
    - pthreadpool
    - psimd
    - fxdiv
    - libonnx
    - xnnpack 0.0.0.20221121.3783.458f0f394
    - clog
    - qnnpack
    - nnpack
    - tensorpipe
    - kineto
    - fbgemm
    - fmt 10
    - c10
    - typing
    - libuv
    - pkg-config  # [unix]
    - typing_extensions
  run:
    - mkl {{ mkl }}     # [x86]
    - libblas * *_mkl   # [x86]
    - libblas   # [not x86]
    - libcblas   # [not x86]
    - liblapack   # [not x86]
    - llvm-openmp    # [osx]

test:
  commands:
    - test ! -f "${PREFIX}/lib/libpytorch_qnnpack.a"                 # [unix]
    - test ! -f "${PREFIX}/include/qnnpack_func.h"                   # [unix]
    - test -f "${PREFIX}/lib/libtorch.so.{{ version }}"              # [linux]
    - test -f "${PREFIX}/lib/libtorch_cpu.so.{{ version }}"          # [linux]
    - test -f "${PREFIX}/lib/libtorch_global_deps.so.{{ version }}"  # [linux]
    - test -d "${PREFIX}/include/ATen"                               # [linux]
    - test -d "${PREFIX}/include/c10d"                               # [linux]
    - test -d "${PREFIX}/include/caffe2"                             # [linux]
    - test -d "${PREFIX}/include/torch"                              # [linux]

about:
  home: https://github.com/pytorch/pytorch/
  summary: PyTorch C bindings
  license: BSD-3-Clause
  license_family: BSD
  license_file: pytorch/LICENSE

extra:
  recipe-maintainers:
    - hmaarrfk
