{% set name = "rte-rrtmgp" %}
{% set version = "0.0.1" %}
{% set run_validation_plots = false %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  # TODO: Set `makepath-cmake` to {{ version }} when we have real version
  url: https://github.com/makepath-alex/rte-rrtmgp/archive/refs/heads/conda-recipe-dev.zip
  sha256: 893eb55c6d638116a0749bc52f6bca633fbad17495e2b6a3bd8730937c2bbb17

build:
  number: 0
  script_env:
    - RUN_VALIDATION_PLOTS={{ run_validation_plots }}

requirements:
  build:
    # General
    - cmake                                  # CMake to configure the project
    - ninja                                  # Ninja to run the build
    - python                                 # Required for testing Python
    - conda-forge::netcdf-fortran >=4.5,<5.0 # Required for testing Fortran NetCDF library
    - netcdf4                                # Required for testing
    - xarray                                 # Required for testing
    - dask                                   # Required for testing
    - numpy                                  # Required for testing
    - matplotlib                             # [run_validation_plots]
    - colorcet                               # [run_validation_plots]
    - scipy                                  # [run_validation_plots]
    # Linux
    - gcc_linux-64                           # [linux]
    - gxx_linux-64                           # [linux]
    - gfortran_linux-64                      # [linux]
    # MacOS
    - clang_osx-64                           # [osx and x86_64]
    - clangxx_osx-64                         # [osx and x86_64]
    - gfortran_osx-64                        # [osx and x86_64]
    - clang_osx-arm64                        # [osx and arm64]
    - clangxx_osx-arm64                      # [osx and arm64]
    - gfortran_osx-arm64                     # [osx and arm64]
    # Win
    - gcc_win-64                             # [win]
    - gxx_win-64                             # [win]
    - gfortran_win-64                        # [win]
  host:
    # General
    - cmake                                  # CMake to configure the project
    - python                                 # Python required for running tests
    - conda-forge::netcdf-fortran >=4.5,<5.0 # Required runtime for testing
    # Linux
    - gfortran_linux-64                      # [linux]
    # MacOS
    - gfortran_osx-64                        # [osx and x86_64]
    - gfortran_osx-arm64                     # [osx and arm64]
    # Win
    - gfortran_win-64                        # [win]
  run:
    # General
    - python

test:
  commands:
    # Check if the files exists
    # Unix
    - test -f $PREFIX/include/rrtmgp_kernels.h  # [unix]
    - test -f $PREFIX/include/rte_kernels.h     # [unix]
    - test -f $PREFIX/include/rte_types.h       # [unix]
    - test -f $PREFIX/lib/librte.a              # [unix]
    - test -f $PREFIX/lib/librrtmgp.a           # [unix]
    # Win (we build with mingw, so it generates .a files)
    - if exist "%PREFIX%\include\rrtmgp_kernels.h" (exit /b 0) else (exit /b 1)  # [win]
    - if exist "%PREFIX%\include\rte_kernels.h" (exit /b 0) else (exit /b 1)     # [win]
    - if exist "%PREFIX%\include\rte_types.h" (exit /b 0) else (exit /b 1)       # [win]
    - if exist "%PREFIX%\lib\librte.a" (exit /b 0) else (exit /b 1)              # [win]
    - if exist "%PREFIX%\lib\librrtmgp.a" (exit /b 0) else (exit /b 1)           # [win]

about:
  home: https://github.com/earth-system-radiation/rte-rrtmgp
  summary: Fortran codes for computing radiative fluxes in planetary atmospheres.
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE.txt
  doc_url: https://earth-system-radiation.github.io/rte-rrtmgp/how-tos/

extra:
  recipe-maintainers:
    - RobertPincus
    - makepath-alex
