context:
  version: "2.8.7"

package:
  name: libsc
  version: ${{ version }}

source:
  url: https://github.com/cburstedde/libsc/releases/download/v${{ version }}/libsc-${{ version }}.tar.gz
  sha256: 96028B7E16917E90DD319E9F7BBB231280FF3E74ECFE2A5480B5FF94AE1428CD

build:
  number: 0
  skip:
    - win
  script:
    - if: unix
      then:
        # - if: (build_platform != target_platform)
        #   then:
        #     # flags from https://conda-forge.org/docs/maintainer/knowledge_base/#cross-compilation and https://github.com/conda-forge/mumps-feedstock/blob/966474677d28486ef897b0d3bb2c10558dc9b5ca/recipe/build-mumps.sh
        #     - export OMPI_CC=$CC
        #     - export OMPI_CXX=$CXX
        #     - export OMPI_FC=$FC
        #     - export OPAL_PREFIX="$PREFIX"
        #     - export FFLAGS="${FFLAGS} -DAVOID_MPI_IN_PLACE"
        #     - export LDFLAGS="${LDFLAGS} -headerpad_max_install_names"
        - cmake -B build -DCMAKE_INSTALL_PREFIX=$PREFIX -DSC_BUILD_SHARED_LIBS=ON -DSC_ENABLE_MPI=ON
        - cmake --build build --parallel
        - cmake --install build

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ stdlib('c') }}
    - cmake
    - make
    - if: (build_platform != target_platform)
      then:
        - openmpi-mpicc
  host:
    - openmpi-mpicc
    - zlib
    - jansson

tests:
  - package_contents:
      lib:
        - libsc
  # - script:
  #     # JSON test file has relative path to h5 included - changing that
  #     - JSON_FILE="$PREFIX/etc/conda/test-files/$PKG_NAME/0/test/input_files/test_LinearElastic.json"
  #     - MODIFIED_JSON_FILE="$PREFIX/etc/conda/test-files/$PKG_NAME/0/test/input_files/test_LinearElastic_mod.json"
  #     - NEW_MS_FILENAME="$PREFIX/etc/conda/test-files/$PKG_NAME/0/test/microstructures/sphere32.h5"
  #     # Use jq to create a modified copy of the JSON file
  #     - jq --arg new_filename "$NEW_MS_FILENAME" '.microstructure.filepath = $new_filename' "$JSON_FILE" > "$MODIFIED_JSON_FILE"
  #     # Run tests
  #     - mpiexec -n 1 FANS "$MODIFIED_JSON_FILE" "$PREFIX/etc/conda/test-files/$PKG_NAME/0//test/test_results.h5"
  #   requirements:
  #     run:
  #       - jq
  #   files:
  #     source:
  #       - test/
  # - script:
  #     - FANS --version

about:
  homepage: https://www.p4est.org/
  summary: 'The "sc" auxiliary library'
  description: |
    The SC Library provides support for parallel scientific applications.
    It consists of basic helper functionality such as logging, array and hash data structures, parallel statistics, and more.
    libsc also integrates the third-party libraries zlib and lua.
  license: LGPL-2.1-only
  license_family: LGPL
  license_file: COPYING
  repository: https://github.com/cburstedde/libsc

extra:
  recipe-maintainers:
    - claudiushaag
